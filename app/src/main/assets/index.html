<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StopAddict</title>

<!-- =========================
   CSS GLOBAL ‚Äî BLOC 1
   UNIQUEMENT STYLES G√âN√âRAUX
   ========================= -->

<style>

/* RESET BASIQUE */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: Arial, sans-serif;
}

html, body {
    width: 100%;
    height: 100%;
    background: #f5f5f5;
    color: #222;
    overflow: hidden;
}

/* SUPPORT LANGUE ARABE (RTL) */
html[dir="rtl"] {
    direction: rtl;
}

/* EN-T√äTE HAUT (nom app + date/heure + console debug overlay) */
#topbar {
    width: 100%;
    padding: 14px;
    background: #2563eb;
    color: white;
    font-size: 20px;
    font-weight: bold;
    text-align: center;
    position: relative;
}

/* Console debug (5 clics) */
#debugConsole {
    display: none;
    position: absolute;
    top: 0;
    left: 0;
    z-index: 9999;
    width: 100%;
    height: 120px;
    background: rgba(0,0,0,0.85);
    color: #00ff00;
    font-size: 12px;
    padding: 10px;
    overflow-y: auto;
}

/* BANDEAU PROFIL */
#profileBanner {
    width: 100%;
    padding: 10px;
    background: #e2e8f0;
    color: #333;
    border-bottom: 1px solid #ccc;
    font-size: 14px;
}

/* CONTENU DES ONGLETS (scrollable) */
#content {
    position: absolute;
    top: 110px;   /* topbar + banner */
    bottom: 110px; /* pub + menu onglets */
    left: 0;
    right: 0;
    overflow-y: auto;
    padding: 12px;
}

/* BANDEAU PUB ‚Äî 50px */
#adBanner {
    position: absolute;
    bottom: 60px; /* juste au-dessus du menu navigation */
    left: 0;
    width: 100%;
    height: 50px;
    background: #e5e5e5;
    border-top: 1px solid #ccc;
    text-align: center;
    line-height: 50px;
    font-size: 14px;
    color: #444;
}

/* MENU NAVIGATION BAS */
#navbar {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 60px;
    background: white;
    border-top: 2px solid #2563eb;
    display: flex;
}

.nav-item {
    flex: 1;
    text-align: center;
    padding-top: 6px;
    font-size: 12px;
    color: #333;
}

.nav-item.active {
    color: #2563eb;
    font-weight: bold;
}

/* SECTIONS (onglets) ‚Äî cach√©s par d√©faut */
.tab {
    display: none;
}

/* POPUPS (CGV, Manuel, Mentions, Avertissement‚Ä¶) */
.popup-overlay {
    display: none;
    position: fixed;
    z-index: 9000;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.65);
}

.popup {
    background: white;
    width: 90%;
    max-height: 80%;
    margin: 50px auto;
    padding: 15px;
    overflow-y: auto;
    border-radius: 8px;
    font-size: 14px;
}

/* BOUTONS */
button {
    padding: 10px 16px;
    margin: 6px 0;
    border: none;
    border-radius: 6px;
    background: #2563eb;
    color: white;
    font-size: 14px;
}

button.secondary {
    background: #6b7280;
}

button.danger {
    background: #dc2626;
}

/* INPUTS & CHECKBOXES */
input[type="text"],
input[type="number"],
input[type="date"] {
    width: 100%;
    padding: 8px;
    margin: 6px 0 12px 0;
    border: 1px solid #bbb;
    border-radius: 6px;
}

input[type="checkbox"] {
    transform: scale(1.2);
}

/* TITRES ONGLET */
.tab-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
}

/* SEPARATEURS */
.section {
    margin-bottom: 25px;
}

/* MINI-IC√îNES CATEGORIES */
.category-icon {
    width: 20px;
    height: 20px;
    display: inline-block;
    margin-right: 6px;
}

/* GRAPHIQUES (conteneurs) */
.chart-container {
    width: 100%;
    height: 260px;
    margin: 20px 0;
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 6px;
}

</style>

</head>

<body>

<!-- ===================
     BLOC 1 SE TERMINE ICI
     =================== -->

<!-- FIN BLOC 1 ‚Äî COLLER BLOC 2 ICI -->
<!-- =========================
     BLOC 2 ‚Äî HTML COMPLET
     5 ONGLES + POPUPS
     ========================= -->

<!-- BARRE DU HAUT (TITRE + DATE/HEURE + CONSOLE DEBUG) -->
<div id="topbar" onclick="handleTopbarClick()">
    <span id="appTitle">StopAddict</span>
    &nbsp;‚Äî&nbsp;
    <span id="currentDateTime">--/--/---- --:--</span>

    <!-- Console debug (affich√©e apr√®s 5 clics) -->
    <div id="debugConsole"></div>
</div>

<!-- BANDEAU PROFIL (√âTAT + TOTAL JOUR) -->
<div id="profileBanner">
    <span id="profileStatusIcon">üë§</span>
    <span id="profileStatusText">Profil incomplet</span>
    &nbsp;¬∑&nbsp;
    <span id="todayCounterLabel">Total aujourd'hui :</span>
    <span id="todayTotalCount">0</span>
</div>

<!-- CONTENU PRINCIPAL (ONGLETS) -->
<div id="content">

    <!-- =========================
         ONGLET 1 ‚Äî ACCUEIL
         ========================= -->
    <div id="tab-home" class="tab">
        <div class="tab-title">Accueil</div>

        <!-- R√©sum√© jour -->
        <div class="section">
            <h3>R√©sum√© de la journ√©e</h3>
            <p>
                Cigarettes : <span id="summary-cigarettes">0</span><br>
                Joints : <span id="summary-joints">0</span><br>
                Alcool global : <span id="summary-alcool-global">0</span><br>
                Bi√®res : <span id="summary-bieres">0</span><br>
                Liqueurs : <span id="summary-liqueurs">0</span><br>
                Alcool fort : <span id="summary-alcool-fort">0</span>
            </p>
        </div>

        <!-- Cat√©gories & compteurs -->
        <div class="section">
            <h3>Suivi en direct</h3>

            <!-- Cigarettes -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-cigarettes">
                    Cigarettes
                </label>
                <br>
                <button onclick="changeCount('cigarettes', -1)">‚àí</button>
                <span id="count-cigarettes">0</span>
                <button onclick="changeCount('cigarettes', 1)">+</button>
            </div>
            <hr>

            <!-- Joints -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-joints">
                    Joints (cannabis)
                </label>
                <br>
                <button onclick="changeCount('joints', -1)">‚àí</button>
                <span id="count-joints">0</span>
                <button onclick="changeCount('joints', 1)">+</button>
            </div>
            <hr>

            <!-- Alcool global -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-alcool-global">
                    Alcool global (verres)
                </label>
                <br>
                <button onclick="changeCount('alcoolGlobal', -1)">‚àí</button>
                <span id="count-alcool-global">0</span>
                <button onclick="changeCount('alcoolGlobal', 1)">+</button>
            </div>
            <p style="font-size:12px;color:#555;margin-top:4px;">
                Si "Alcool global" est activ√©, les cat√©gories Bi√®re, Liqueur et Alcool fort sont d√©sactiv√©es.
            </p>
            <hr>

            <!-- Bi√®re -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-bieres">
                    Bi√®res
                </label>
                <br>
                <button onclick="changeCount('bieres', -1)">‚àí</button>
                <span id="count-bieres">0</span>
                <button onclick="changeCount('bieres', 1)">+</button>
            </div>
            <hr>

            <!-- Liqueur -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-liqueurs">
                    Liqueurs
                </label>
                <br>
                <button onclick="changeCount('liqueurs', -1)">‚àí</button>
                <span id="count-liqueurs">0</span>
                <button onclick="changeCount('liqueurs', 1)">+</button>
            </div>
            <hr>

            <!-- Alcool fort -->
            <div>
                <label>
                    <input type="checkbox" id="toggle-alcool-fort">
                    Alcool fort
                </label>
                <br>
                <button onclick="changeCount('alcoolFort', -1)">‚àí</button>
                <span id="count-alcool-fort">0</span>
                <button onclick="changeCount('alcoolFort', 1)">+</button>
            </div>
        </div>

        <!-- Conseils adaptatifs -->
        <div class="section">
            <h3>Conseils du moment</h3>
            <div id="adviceBox" style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:10px;font-size:14px;">
                <p id="adviceText">
                    Les conseils appara√Ætront ici en fonction de tes consommations, de tes habitudes, de tes co√ªts et de tes dates d'arr√™t.
                </p>
            </div>
        </div>
    </div>

    <!-- =========================
         ONGLET 2 ‚Äî STATS
         ========================= -->
    <div id="tab-stats" class="tab">
        <div class="tab-title">Statistiques</div>

                <!-- R√©sum√© global -->
        <div class="section">
            <h3>R√©sum√©</h3>

            <!-- JOUR -->
            <div style="margin-bottom:8px;">
                <strong>Jour :</strong><br>
                <span id="stats-day-details">‚Äì</span><br>
                <span id="stats-day-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- SEMAINE -->
            <div style="margin-bottom:8px;">
                <strong>Semaine :</strong><br>
                <span id="stats-week-details">‚Äì</span><br>
                <span id="stats-week-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- MOIS -->
            <div style="margin-bottom:8px;">
                <strong>Mois :</strong><br>
                <span id="stats-month-details">‚Äì</span><br>
                <span id="stats-month-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- ANN√âE -->
            <div>
                <strong>Ann√©e :</strong><br>
                <span id="stats-year-details">‚Äì</span><br>
                <span id="stats-year-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>
        </div>

        <!-- Graphique habitudes -->
        <div class="section">
            <h3>Habitudes de consommation</h3>
            <div>
                P√©riode :
                <select id="statsPeriodSelect">
                    <option value="day">Jour</option>
                    <option value="week">Semaine</option>
                    <option value="month">Mois</option>
                    <option value="year">Ann√©e</option>
                </select>
            </div>
            <div class="chart-container">
                <canvas id="chartHabitudes"></canvas>
            </div>
        </div>

        <!-- Graphique co√ªts & √©conomies -->
        <div class="section">
            <h3>Co√ªts et √©conomies</h3>
            <div class="chart-container">
                <canvas id="chartCouts"></canvas>
            </div>
        </div>
    </div>

    <!-- =========================
         ONGLET 3 ‚Äî AGENDA
         ========================= -->
    <div id="tab-agenda" class="tab">
        <div class="tab-title">Calendrier</div>
        <!-- R√©sum√© global (copie du bloc Stats) -->
        <div class="section">
            <h3>R√©sum√©</h3>

            <!-- JOUR -->
            <div style="margin-bottom:8px;">
                <strong>Jour :</strong><br>
                <span id="agenda-day-details">‚Äì</span><br>
                <span id="agenda-day-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- SEMAINE -->
            <div style="margin-bottom:8px;">
                <strong>Semaine :</strong><br>
                <span id="agenda-week-details">‚Äì</span><br>
                <span id="agenda-week-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- MOIS -->
            <div style="margin-bottom:8px;">
                <strong>Mois :</strong><br>
                <span id="agenda-month-details">‚Äì</span><br>
                <span id="agenda-month-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>

            <!-- ANN√âE -->
            <div>
                <strong>Ann√©e :</strong><br>
                <span id="agenda-year-details">‚Äì</span><br>
                <span id="agenda-year-summary">Total : 0 unit√©s (~0.00 ‚Ç¨)</span>
            </div>
        </div>

        <!-- Navigation mois -->
        <div class="section">
            <button onclick="changeAgendaMonth(-1)">&lt;</button>
            <span id="agendaMonthLabel" style="font-weight:bold;margin:0 10px;">Mois Ann√©e</span>
            <button onclick="changeAgendaMonth(1)">&gt;</button>
        </div>

        <!-- Grille calendrier -->
        <div class="section" id="agendaGrid" style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;font-size:11px;">
            <!-- Les jours seront g√©n√©r√©s en JS -->
        </div>

        <!-- L√©gende -->
        <div class="section">
            <h3>L√©gende</h3>
            <p>
                <span class="category-icon" style="background:#111;"></span> Cigarettes<br>
                <span class="category-icon" style="background:#228b22;"></span> Joints<br>
                <span class="category-icon" style="background:#b5651d;"></span> Alcool global<br>
                <span class="category-icon" style="background:#1e90ff;"></span> Bi√®res<br>
                <span class="category-icon" style="background:#800080;"></span> Liqueurs<br>
                <span class="category-icon" style="background:#8b0000;"></span> Alcool fort<br>
                <span class="category-icon" style="background:#ffd700;"></span> Dates de volont√© (r√©duction / arr√™t / r√©ussite)
            </p>
        </div>
	    <!-- Encart d'√©dition d'une journ√©e de l'agenda -->
    <div id="agendaEditorOverlay" 
         style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); 
                align-items:center; justify-content:center; z-index:9999;">
        <div style="background:#fff; padding:16px; border-radius:8px; min-width:260px; max-width:90%;">
            <h3 id="agendaEditorTitle" style="margin-top:0;margin-bottom:8px;">
                √âdition du jour
            </h3>

            <div style="font-size:13px; margin-bottom:10px;">
                <strong>Rappel :</strong> si une cat√©gorie est d√©sactiv√©e dans Accueil/R√©glages,
                les boutons ne feront rien ici non plus.
            </div>

            <!-- 6 lignes de compteurs -->
            <div style="font-size:14px; line-height:1.8;">
                Cigarettes :
                <button type="button" onclick="changeAgendaCount('cigarettes', -1)">‚àí</button>
                <span id="agenda-count-cigarettes">0</span>
                <button type="button" onclick="changeAgendaCount('cigarettes', 1)">+</button>
                <br>

                Joints :
                <button type="button" onclick="changeAgendaCount('joints', -1)">‚àí</button>
                <span id="agenda-count-joints">0</span>
                <button type="button" onclick="changeAgendaCount('joints', 1)">+</button>
                <br>

                Alcool global :
                <button type="button" onclick="changeAgendaCount('alcoolGlobal', -1)">‚àí</button>
                <span id="agenda-count-alcoolGlobal">0</span>
                <button type="button" onclick="changeAgendaCount('alcoolGlobal', 1)">+</button>
                <br>

                Bi√®res :
                <button type="button" onclick="changeAgendaCount('bieres', -1)">‚àí</button>
                <span id="agenda-count-bieres">0</span>
                <button type="button" onclick="changeAgendaCount('bieres', 1)">+</button>
                <br>

                Liqueurs :
                <button type="button" onclick="changeAgendaCount('liqueurs', -1)">‚àí</button>
                <span id="agenda-count-liqueurs">0</span>
                <button type="button" onclick="changeAgendaCount('liqueurs', 1)">+</button>
                <br>

                Alcool fort :
                <button type="button" onclick="changeAgendaCount('alcoolFort', -1)">‚àí</button>
                <span id="agenda-count-alcoolFort">0</span>
                <button type="button" onclick="changeAgendaCount('alcoolFort', 1)">+</button>
            </div>

            <div style="margin-top:12px; display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" onclick="resetAgendaDay()">RAZ journ√©e</button>
                <button type="button" onclick="closeAgendaEditor()">Fermer</button>
            </div>
        </div>
    </div>

    </div>

    <!-- =========================
         ONGLET 4 ‚Äî HABITUDES & VOLONT√â
         ========================= -->
    <div id="tab-habits" class="tab">
        <div class="tab-title">Habitudes & volont√©</div>

        <!-- Zone habitudes -->
        <div class="section">
            <h3>Habitudes (maximum par jour)</h3>

            <label>Max cigarettes / jour</label>
            <input type="number" id="habit-max-cigarettes" min="0" step="1">

            <label>Max joints / jour</label>
            <input type="number" id="habit-max-joints" min="0" step="1">

            <label>Max alcool global / jour</label>
            <input type="number" id="habit-max-alcool-global" min="0" step="1">

            <label>Max bi√®res / jour</label>
            <input type="number" id="habit-max-bieres" min="0" step="1">

            <label>Max liqueurs / jour</label>
            <input type="number" id="habit-max-liqueurs" min="0" step="1">

            <label>Max alcool fort / jour</label>
            <input type="number" id="habit-max-alcool-fort" min="0" step="1">
        </div>

        <!-- Zone volont√© : dates d'arr√™t -->
        <div class="section">
            <h3>Volont√© ‚Äî Dates importantes</h3>

            <!-- Cigarette -->
            <h4>Cigarettes</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-cigarettes-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-cigarettes-stop">
            <label>Date de r√©ussite (je ne fume plus)</label>
            <input type="date" id="will-cigarettes-success">

            <!-- Joint -->
            <h4>Joints</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-joints-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-joints-stop">
            <label>Date de r√©ussite (je ne fume plus)</label>
            <input type="date" id="will-joints-success">

            <!-- Alcool global -->
            <h4>Alcool global</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-alcool-global-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-alcool-global-stop">
            <label>Date de r√©ussite (je ne bois plus)</label>
            <input type="date" id="will-alcool-global-success">

            <!-- Bi√®res -->
            <h4>Bi√®res</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-bieres-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-bieres-stop">
            <label>Date de r√©ussite (je ne bois plus)</label>
            <input type="date" id="will-bieres-success">

            <!-- Liqueurs -->
            <h4>Liqueurs</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-liqueurs-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-liqueurs-stop">
            <label>Date de r√©ussite (je ne bois plus)</label>
            <input type="date" id="will-liqueurs-success">

            <!-- Alcool fort -->
            <h4>Alcool fort</h4>
            <label>Date de r√©duction</label>
            <input type="date" id="will-alcool-fort-reduction">
            <label>Date d'arr√™t</label>
            <input type="date" id="will-alcool-fort-stop">
            <label>Date de r√©ussite (je ne bois plus)</label>
            <input type="date" id="will-alcool-fort-success">
        </div>
    </div>

    <!-- =========================
         ONGLET 5 ‚Äî R√âGLAGES
         ========================= -->
    <div id="tab-settings" class="tab">
        <div class="tab-title">R√©glages</div>

        <!-- Personnalisation -->
        <div class="section">
            <h3>Personnalisation</h3>
            <label>Pr√©nom (pour les conseils personnalis√©s)</label>
            <input type="text" id="user-firstname" placeholder="Ton pr√©nom (optionnel)">
        </div>

        <!-- Langue -->
        <div class="section">
            <h3>Langue de l'application</h3>
            <p style="font-size:12px;color:#555;">
                Le changement de langue red√©marrera l'application. Les donn√©es ne seront pas effac√©es.
            </p>
            <select id="language-select">
                <option value="fr">Fran√ßais (FR)</option>
                <option value="en">English (EN)</option>
                <option value="es">Espa√±ol (ES)</option>
                <option value="pt">Portugu√™s (PT)</option>
                <option value="de">Deutsch (DE)</option>
                <option value="it">Italiano (IT)</option>
                <option value="ru">–†—É—Å—Å–∫–∏–π (RU)</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (AR)</option>
                <option value="hi">‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (HI)</option>
                <option value="ja">Êó•Êú¨Ë™û (JA)</option>
            </select>
        </div>

        <!-- Monnaie -->
        <div class="section">
            <h3>Monnaie</h3>
            <select id="currency-select">
                <option value="EUR">Euro (EUR)</option>
                <option value="USD">Dollar US (USD)</option>
                <option value="GBP">Livre (GBP)</option>
                <option value="JPY">Yen (JPY)</option>
                <option value="CHF">Franc suisse (CHF)</option>
            </select>
        </div>

        <!-- Activation cat√©gories + co√ªts -->
        <div class="section">
            <h3>Cat√©gories & co√ªts</h3>

            <!-- Cigarettes -->
            <h4>Cigarettes</h4>
            <label>
                <input type="checkbox" id="settings-cigarettes-enabled">
                Activer la cat√©gorie Cigarettes
            </label>

            <p style="font-weight:bold;margin-top:10px;">Cigarettes "classiques" (paquet)</p>
            <label>Prix du paquet</label>
            <input type="number" id="price-pack-classic" min="0" step="0.01">
            <label>Nombre de cigarettes par paquet</label>
            <input type="number" id="count-pack-classic" min="0" step="1">

            <p style="font-weight:bold;margin-top:10px;">Cigarettes "roul√©es"</p>
            <label>Prix du paquet de tabac √† rouler</label>
            <input type="number" id="price-pack-roll" min="0" step="0.01">
            <label>Nombre de cigarettes par paquet (roul√©es)</label>
            <input type="number" id="count-pack-roll" min="0" step="1">
            <label>Prix des feuilles √† rouler</label>
            <input type="number" id="price-rolling-papers" min="0" step="0.01">
            <label>Nombre de feuilles</label>
            <input type="number" id="count-rolling-papers" min="0" step="1">
            <label>Prix du sachet de filtres</label>
            <input type="number" id="price-filters" min="0" step="0.01">
            <label>Nombre de filtres</label>
            <input type="number" id="count-filters" min="0" step="1">

            <p style="font-weight:bold;margin-top:10px;">Cigarettes "√† tubes"</p>
            <label>Prix du paquet de tabac √† tuber</label>
            <input type="number" id="price-pack-tube" min="0" step="0.01">
            <label>Nombre de cigarettes par paquet (tubes)</label>
            <input type="number" id="count-pack-tube" min="0" step="1">
            <label>Prix des tubes</label>
            <input type="number" id="price-tubes" min="0" step="0.01">
            <label>Nombre de tubes</label>
            <input type="number" id="count-tubes" min="0" step="1">

            <!-- Cannabis -->
            <h4>Cannabis (joints)</h4>
            <label>
                <input type="checkbox" id="settings-joints-enabled">
                Activer la cat√©gorie Cannabis / joints
            </label>
            <label>Prix du gramme</label>
            <input type="number" id="price-gram-cannabis" min="0" step="0.01">
            <label>Gramme par joint</label>
            <input type="number" id="grams-per-joint" min="0" step="0.01">
            <label>Prix des feuilles</label>
            <input type="number" id="price-cannabis-papers" min="0" step="0.01">
            <label>Nombre de feuilles</label>
            <input type="number" id="count-cannabis-papers" min="0" step="1">

            <!-- Alcool global -->
            <h4>Alcool global</h4>
            <label>
                <input type="checkbox" id="settings-alcool-global-enabled">
                Activer la cat√©gorie Alcool global
            </label>
            <label>Prix d'un verre (alcool global)</label>
            <input type="number" id="price-glass-alcool-global" min="0" step="0.01">
            <label>Unit√© alcool global (cl)</label>
            <input type="number" id="unit-alcool-global-cl" min="0" step="0.1">

            <!-- Bi√®re -->
            <h4>Bi√®res</h4>
            <label>
                <input type="checkbox" id="settings-bieres-enabled">
                Activer la cat√©gorie Bi√®res
            </label>
            <label>Prix d'une bi√®re</label>
            <input type="number" id="price-beer" min="0" step="0.01">
            <label>Unit√© bi√®re (cl)</label>
            <input type="number" id="unit-beer-cl" min="0" step="0.1">

            <!-- Liqueur -->
            <h4>Liqueurs</h4>
            <label>
                <input type="checkbox" id="settings-liqueurs-enabled">
                Activer la cat√©gorie Liqueurs
            </label>
            <label>Prix d'un verre de liqueur</label>
            <input type="number" id="price-liqueur" min="0" step="0.01">
            <label>Unit√© liqueur (cl)</label>
            <input type="number" id="unit-liqueur-cl" min="0" step="0.1">

            <!-- Alcool fort -->
            <h4>Alcool fort</h4>
            <label>
                <input type="checkbox" id="settings-alcool-fort-enabled">
                Activer la cat√©gorie Alcool fort
            </label>
            <label>Prix d'un verre d'alcool fort</label>
            <input type="number" id="price-strong-alcohol" min="0" step="0.01">
            <label>Unit√© alcool fort (cl)</label>
            <input type="number" id="unit-strong-alcohol-cl" min="0" step="0.1">

            <p style="font-size:12px;color:#555;margin-top:6px;">
                Lorsque "Alcool global" est activ√©, les cat√©gories Bi√®re, Liqueur et Alcool fort sont d√©sactiv√©es, et inversement.
            </p>
        </div>

        <!-- √Ä propos -->
        <div class="section">
            <h3>√Ä propos</h3>
            <button type="button" onclick="openPopup('warning')">Voir l'avertissement (18+)</button><br>
            <button type="button" onclick="openPopup('manual')">Manuel d'utilisation</button><br>
            <button type="button" onclick="openPopup('cgv')">Conditions g√©n√©rales de vente</button><br>
            <button type="button" onclick="openPopup('mentions')">Mentions l√©gales</button><br>
            <button type="button" onclick="openPopup('ressources')">Ressources et num√©ros utiles</button><br>
            <button type="button" onclick="contactSupport()">Contact support</button>
        </div>

        <!-- RAZ & sauvegarde -->
        <div class="section">
            <h3>RAZ & sauvegarde</h3>
            <button class="danger" type="button" onclick="resetDay()">RAZ du jour</button><br>
            <button class="danger" type="button" onclick="resetHistory()">RAZ de l'historique</button><br>
            <button class="danger" type="button" onclick="resetFactory()">RAZ r√©glages usine</button><br><br>

            <button type="button" onclick="exportData()">Exporter (JSON)</button><br><br>

            <label>Importer (JSON)</label>
            <input type="file" id="importFileInput" accept="application/json" onchange="importDataFromFile(event)">
        </div>
    </div>
</div>

<!-- BANDEAU PUB -->
<div id="adBanner">
    Version gratuite ‚Äî espace publicitaire (bandeau 50px)
</div>

<!-- NAVIGATION BAS -->
<div id="navbar">
    <div class="nav-item" id="nav-home" onclick="switchTab('home')">
        üè†<br>Accueil
    </div>
    <div class="nav-item" id="nav-stats" onclick="switchTab('stats')">
        üìä<br>Stats
    </div>
    <div class="nav-item" id="nav-agenda" onclick="switchTab('agenda')">
        üìÖ<br>Agenda
    </div>
    <div class="nav-item" id="nav-habits" onclick="switchTab('habits')">
        üí™<br>Habitudes
    </div>
    <div class="nav-item" id="nav-settings" onclick="switchTab('settings')">
        ‚öôÔ∏è<br>R√©glages
    </div>
</div>

<!-- =========================
     POPUPS (OVERLAYS)
     ========================= -->

<!-- POPUP AVERTISSEMENT MAJORIT√â -->
<div id="popup-warning-overlay" class="popup-overlay">
    <div class="popup">
        <h3>Avertissement ‚Äî Public majeur(e) (18+)</h3>
        <p style="margin-top:10px;">
            StopAddict est une application d'auto-suivi et d'aide √† la r√©duction/arr√™t des consommations
            (tabac, alcool, cannabis).
        </p>
        <p style="margin-top:6px;">
            R√©serv√©e aux personnes de 18 ans et plus, ayant d√©pass√© la majorit√© du pays de r√©sidence
            ou du pays visit√©.
        </p>
        <p style="margin-top:6px;">
            L'application ne fait pas la promotion de ces produits et ne remplace pas un accompagnement
            m√©dical, psychologique ou social.
        </p>
        <p style="margin-top:6px;">
            Utilisez StopAddict de fa√ßon responsable.
        </p>

        <button type="button" style="margin-top:10px;" onclick="openPopup('ressources')">
            Ressources et num√©ros utiles
        </button>

        <div style="margin-top:15px;">
            <label>
                <input type="checkbox" id="chk-is-adult">
                Je suis majeur(e), j'ai 18 ans ou plus
            </label>
        </div>
        <div>
            <label>
                <input type="checkbox" id="chk-hide-warning">
                Ne plus r√©afficher ce message
            </label>
        </div>

        <div style="margin-top:15px;">
            <button class="secondary" onclick="quitApp()">Quitter</button>
            <button class="secondary" onclick="closePopup('warning')">Annuler</button>
            <button id="btn-accept-warning" onclick="acceptWarning()" disabled>J'accepte et continue</button>
        </div>
    </div>
</div>

<!-- POPUP MANUEL D'UTILISATION -->
<div id="popup-manual-overlay" class="popup-overlay">
    <div class="popup">
        <h3>Manuel d'utilisation ‚Äî StopAddict</h3>

        <p style="margin-top:10px;">
            Objectif : t'aider √† suivre et r√©duire/arr√™ter tes consommations (tabac, alcool, cannabis),
            sans incitation.
        </p>

        <h4 style="margin-top:10px;">1) √âcran Accueil</h4>
        <p>
            Choisis le type (Clopes : Classiques/Roul√©es/Tubes ; Alcool : Bi√®re/Fort/Liqueur) via les pastilles.<br>
            Boutons +/‚àí pour ajouter/retirer une unit√©.<br>
            Bandeau conseil : progression vs limites du jour et Tips dynamiques.
        </p>

        <h4 style="margin-top:10px;">2) Stats</h4>
        <p>
            Onglets Jour/Semaine/Mois/Ann√©e. Totaux + co√ªt estim√©.<br>
            Barres vs limites (si d√©finies dans R√©glages).
        </p>

        <h4 style="margin-top:10px;">3) Calendrier</h4>
        <p>
            Chaleur = volume ; pastilles = type consomm√© (clope/joint/alcool).<br>
            Appuie sur un jour pour √©diter ou RAZ ce jour.
        </p>

        <h4 style="margin-top:10px;">4) Habitudes & R√©glages</h4>
        <p>
            Habitudes : min/max journaliers pour alimenter les conseils.<br>
            R√©glages : activer les cat√©gories, prix/unit√©s, limites, dates d‚Äôobjectifs.<br>
            RAZ & Sauvegarde : reset jour/p√©riode/historique, export JSON.
        </p>

        <h4 style="margin-top:10px;">5) Donn√©es & confidentialit√©</h4>
        <p>
            Stockage local sur l‚Äôappareil (localStorage). Aucune synchronisation externe.<br>
            Tu peux exporter/supprimer √† tout moment (voir RAZ & sauvegarde).
        </p>

        <div style="margin-top:15px;">
            <button onclick="closePopup('manual')">Fermer</button>
        </div>
    </div>
</div>

<!-- POPUP CGV -->
<div id="popup-cgv-overlay" class="popup-overlay">
    <div class="popup">
        <h3>Conditions G√©n√©rales de Vente (CGV)</h3>

        <p style="margin-top:10px;">
            Prix public : 1,00 ‚Ç¨ TTC (ou √©quivalent devise locale selon Google Play).
        </p>

        <h4 style="margin-top:10px;">1) Objet</h4>
        <p>
            La pr√©sente licence te permet d‚Äôutiliser StopAddict pour un usage personnel.
        </p>

        <h4 style="margin-top:10px;">2) Achat & paiement</h4>
        <p>
            L‚Äôachat et le paiement sont g√©r√©s par Google Play. Les taxes, taux de change et disponibilit√©
            d√©pendent du Store.
        </p>

        <h4 style="margin-top:10px;">3) Droit de r√©tractation</h4>
        <p>
            Contenu num√©rique fourni sur ex√©cution imm√©diate : le droit de r√©tractation de l‚ÄôUE peut
            ne pas s‚Äôappliquer une fois le t√©l√©chargement commenc√©, sous r√©serve des r√®gles de Google Play.
        </p>

        <h4 style="margin-top:10px;">4) Mises √† jour</h4>
        <p>
            Des mises √† jour correctives ou √©volutives peuvent √™tre propos√©es sans obligation de disponibilit√© continue.
        </p>

        <h4 style="margin-top:10px;">5) Responsabilit√©</h4>
        <p>
            StopAddict n‚Äôest pas un dispositif m√©dical. Aucune responsabilit√© pour dommages indirects.
            Utilisation responsable et conforme aux lois locales.
        </p>

        <h4 style="margin-top:10px;">6) Support</h4>
        <p>
            Contact : stopmauvaiseshabitudes@gmail.com (d√©lai cible 72 h ouvr√©es).
        </p>

        <h4 style="margin-top:10px;">7) Loi applicable & litiges</h4>
        <p>
            En l‚Äôabsence d‚Äôentreprise constitu√©e, ces CGV sont propos√©es √† titre d‚Äôinformation.
            La loi applicable et la juridiction pourront d√©pendre de ta localisation et des r√®gles du Store.
        </p>

        <p style="margin-top:10px;">
            Entr√©e en vigueur : 15 septembre 2025
        </p>

        <div style="margin-top:15px;">
            <button onclick="closePopup('cgv')">Fermer</button>
        </div>
    </div>
</div>

<!-- POPUP MENTIONS L√âGALES -->
<div id="popup-mentions-overlay" class="popup-overlay">
    <div class="popup">
        <h3>Mentions l√©gales</h3>

        <p style="margin-top:10px;">
            √âditeur : √Ä compl√©ter (auto-entrepreneur ‚Äî ouverture pr√©vue d√©cembre).<br>
            Contact: stopmauvaiseshabitudes@gmail.com
        </p>

        <p style="margin-top:10px;">
            H√©bergement: Application distribu√©e via Google Play Store. Donn√©es utilisateurs stock√©es localement
            sur l‚Äôappareil.
        </p>

        <p style="margin-top:10px;">
            Protection des donn√©es : aucune collecte c√¥t√© serveur. Les donn√©es que tu saisis restent sur l‚Äôappareil.
            Export/RAZ disponibles.
        </p>

        <p style="margin-top:10px;">
            Avertissement sant√© : r√©serv√© aux 18+. L'app n‚Äôincite pas √† la consommation et ne remplace pas un
            accompagnement m√©dical/psychologique/social.
        </p>

        <p style="margin-top:10px;">
            Entr√©e en vigueur : 15 septembre 2025
        </p>

        <div style="margin-top:15px;">
            <button onclick="closePopup('mentions')">Fermer</button>
        </div>
    </div>
</div>

<!-- POPUP RESSOURCES & NUM√âROS UTILES -->
<div id="popup-ressources-overlay" class="popup-overlay">
    <div class="popup">
        <h3>Ressources et num√©ros utiles</h3>

        <p style="margin-top:10px;">
            Urgences : 112 (UE) / 15 (FR ‚Äî SAMU)
        </p>
        <p>
            Tabac info service (FR): 39 89 ‚Äî tabac-info-service.fr
        </p>
        <p>
            Alcool info service (FR): 0 980 980 930 ‚Äî alcool-info-service.fr
        </p>
        <p>
            Drogues info service (FR): 0 800 23 13 13 ‚Äî drogues-info-service.fr
        </p>
        <p style="margin-top:10px;">
            Consulte les ressources locales dans ton pays si tu n'es pas en France.
        </p>

        <div style="margin-top:15px;">
            <button onclick="closePopup('ressources')">Fermer</button>
        </div>
    </div>
</div>

<!-- ===================
     FIN BLOC 2 ‚Äî COLLER BLOC 3 ICI
     =================== -->
<!-- =========================
     BLOC 3 ‚Äî JS COEUR LOGIQUE
     State global, stockage, onglets,
     bandeau profil, avertissement,
     compteurs, agenda de base,
     conseils (version simple)
     ========================= -->

<script>
// =========================
// STATE GLOBAL & STORAGE
// =========================

const STORAGE_KEY = "stopaddict_state_v1";

let appState = {
    version: "1.0.0",
    language: "fr",
    currency: "EUR",
    user: {
        firstName: ""
    },
    flags: {
        isAdultConfirmed: false,
        hideWarning: false
    },
    categoriesEnabled: {
        cigarettes: false,
        joints: false,
        alcoolGlobal: false,
        bieres: false,
        liqueurs: false,
        alcoolFort: false
    },
    // countsByDate: { "YYYY-MM-DD": { cigarettes: 0, joints: 0, ... } }
    countsByDate: {},

    habits: {
        cigarettes: 0,
        joints: 0,
        alcoolGlobal: 0,
        bieres: 0,
        liqueurs: 0,
        alcoolFort: 0
    },

    willDates: {
        cigarettes: { reduction: "", stop: "", success: "" },
        joints: { reduction: "", stop: "", success: "" },
        alcoolGlobal: { reduction: "", stop: "", success: "" },
        bieres: { reduction: "", stop: "", success: "" },
        liqueurs: { reduction: "", stop: "", success: "" },
        alcoolFort: { reduction: "", stop: "", success: "" }
    },

    prices: {
        // cigarettes
        cigarettes: {
            enabled: true,
            classic: {
                pricePack: 0,
                countPack: 0
            },
            roll: {
                priceTobaccoPack: 0,
                countFromPack: 0,
                pricePapers: 0,
                countPapers: 0,
                priceFilters: 0,
                countFilters: 0
            },
            tube: {
                priceTobaccoPack: 0,
                countFromPack: 0,
                priceTubes: 0,
                countTubes: 0
            }
        },
        // joints / cannabis
        joints: {
            enabled: true,
            priceGram: 0,
            gramsPerJoint: 0,
            pricePapers: 0,
            countPapers: 0
        },
        // alcool
        alcoolGlobal: {
            enabled: true,
            priceGlass: 0,
            unitCl: 0
        },
        bieres: {
            enabled: true,
            priceBeer: 0,
            unitCl: 0
        },
        liqueurs: {
            enabled: true,
            priceGlass: 0,
            unitCl: 0
        },
        alcoolFort: {
            enabled: true,
            priceGlass: 0,
            unitCl: 0
        }
    },

    meta: {
        createdAt: null,
        lastUpdate: null
    }
};

// Agenda : mois affich√© actuellement
let agendaCurrentYear = null;
let agendaCurrentMonth = null; // 0-11

// Jour actuellement s√©lectionn√© dans l'agenda (cl√© AAAA-MM-JJ)
let agendaSelectedDateKey = null;


// Debug console
let topbarClickCount = 0;
let debugVisible = false;

// =========================
// HELPERS DATE & STORAGE
// =========================

function getTodayKey() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

function getDateKey(dateObj) {
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth() + 1).padStart(2, "0");
    const d = String(dateObj.getDate()).padStart(2, "0");
    return `${y}-${m}-${d}`;
}

function loadState() {
    try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
            appState.meta.createdAt = new Date().toISOString();
            saveState();
            return;
        }
        const parsed = JSON.parse(raw);
        // merge simple (sans prise de t√™te)
        appState = Object.assign({}, appState, parsed);
        // s√©curit√© si certaines sous-structures manquent
        appState.countsByDate = appState.countsByDate || {};
        appState.habits = Object.assign({
            cigarettes: 0, joints: 0, alcoolGlobal: 0, bieres: 0, liqueurs: 0, alcoolFort: 0
        }, appState.habits || {});
        appState.flags = Object.assign({
            isAdultConfirmed: false,
            hideWarning: false
        }, appState.flags || {});
    } catch (e) {
        console.error("Erreur chargement state", e);
        // reset en cas de corruption
        appState = {
            ...appState,
            meta: { createdAt: new Date().toISOString(), lastUpdate: null }
        };
        saveState();
    }
}

function saveState() {
    appState.meta.lastUpdate = new Date().toISOString();
    try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
    } catch (e) {
        console.error("Erreur sauvegarde state", e);
    }
    logDebug("State sauvegard√©.");
}

// =========================
function ensureTodayEntry() {
    const key = getTodayKey();
    if (!appState.countsByDate[key]) {
        appState.countsByDate[key] = {
            cigarettes: 0,
            joints: 0,
            alcoolGlobal: 0,
            bieres: 0,
            liqueurs: 0,
            alcoolFort: 0
        };
    }
}

// =========================
// DATE/HEURE TOPBAR
// =========================

function updateDateTime() {
    const el = document.getElementById("currentDateTime");
    if (!el) return;
    const now = new Date();
    const dateStr = now.toLocaleDateString(undefined, { year: "numeric", month: "2-digit", day: "2-digit" });
    const timeStr = now.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" });
    el.textContent = `${dateStr} ${timeStr}`;
}

// =========================
// DEBUG CONSOLE 5 CLICS
// =========================

function handleTopbarClick() {
    topbarClickCount++;
    if (topbarClickCount >= 5) {
        topbarClickCount = 0;
        debugVisible = !debugVisible;
        const consoleDiv = document.getElementById("debugConsole");
        if (!consoleDiv) return;
        if (debugVisible) {
            consoleDiv.style.display = "block";
            logDebug("Console debug activ√©e.");
            logDebug("State actuel : " + JSON.stringify(appState, null, 2));
        } else {
            consoleDiv.style.display = "none";
        }
    }
}

function logDebug(msg) {
    const consoleDiv = document.getElementById("debugConsole");
    if (!consoleDiv) return;
    const now = new Date();
    const timeStr = now.toLocaleTimeString();
    consoleDiv.textContent += `[${timeStr}] ${msg}\n`;
    consoleDiv.scrollTop = consoleDiv.scrollHeight;
}

// =========================
// BANDEAU PROFIL & TOTAL JOUR
// =========================

function updateProfileBanner() {
    ensureTodayEntry();
    const key = getTodayKey();
    const today = appState.countsByDate[key];

    const totalToday =
        (today.cigarettes || 0) +
        (today.joints || 0) +
        (today.alcoolGlobal || 0) +
        (today.bieres || 0) +
        (today.liqueurs || 0) +
        (today.alcoolFort || 0);

    const profileStatusText = document.getElementById("profileStatusText");
    const todayTotalCount = document.getElementById("todayTotalCount");

    // Profil complet / incomplet (co√ªts, habitudes, dates)
    const hasCosts = checkHasCosts();
    const hasHabits = checkHasHabits();
    const hasDates = checkHasDates();

    if (hasCosts && hasHabits && hasDates) {
        profileStatusText.textContent = "Profil complet (co√ªts + habitudes + dates)";
    } else {
        profileStatusText.textContent = "Profil incomplet (pense √† renseigner co√ªts / habitudes / dates)";
    }

    todayTotalCount.textContent = totalToday.toString();
}

function checkHasCosts() {
    // on regarde s'il y a au moins un prix non nul
    const p = appState.prices;
    if (!p) return false;
    function nonZero(n) { return typeof n === "number" && n > 0; }

    return (
        nonZero(p.cigarettes.classic.pricePack) ||
        nonZero(p.cigarettes.roll.priceTobaccoPack) ||
        nonZero(p.cigarettes.tube.priceTobaccoPack) ||
        nonZero(p.joints.priceGram) ||
        nonZero(p.alcoolGlobal.priceGlass) ||
        nonZero(p.bieres.priceBeer) ||
        nonZero(p.liqueurs.priceGlass) ||
        nonZero(p.alcoolFort.priceGlass)
    );
}

function checkHasHabits() {
    const h = appState.habits || {};
    return !!(
        (h.cigarettes && h.cigarettes > 0) ||
        (h.joints && h.joints > 0) ||
        (h.alcoolGlobal && h.alcoolGlobal > 0) ||
        (h.bieres && h.bieres > 0) ||
        (h.liqueurs && h.liqueurs > 0) ||
        (h.alcoolFort && h.alcoolFort > 0)
    );
}

function checkHasDates() {
    const w = appState.willDates || {};
    function hasAny(obj) {
        if (!obj) return false;
        return !!(obj.reduction || obj.stop || obj.success);
    }
    return (
        hasAny(w.cigarettes) ||
        hasAny(w.joints) ||
        hasAny(w.alcoolGlobal) ||
        hasAny(w.bieres) ||
        hasAny(w.liqueurs) ||
        hasAny(w.alcoolFort)
    );
}

// =========================
// COMPTEURS ACCUEIL
// =========================

function changeCount(categoryKey, delta) {
    // respect activation cat√©gorie
    if (!appState.categoriesEnabled[categoryKey]) {
        logDebug(`Cat√©gorie ${categoryKey} d√©sactiv√©e, incr√©ment ignor√©.`);
        return;
    }

    ensureTodayEntry();
    const key = getTodayKey();
    const today = appState.countsByDate[key];

    let current = today[categoryKey] || 0;
    current += delta;
    if (current < 0) current = 0;
    today[categoryKey] = current;
    appState.countsByDate[key] = today;
    saveState();

    refreshHomeCounters();
    updateProfileBanner();
    refreshStatsSummariesBasic();
    renderAgenda(); // mise √† jour visuelle

    logDebug(`changeCount(${categoryKey}, ${delta}) => ${current}`);
}

function refreshHomeCounters() {
    ensureTodayEntry();
    const key = getTodayKey();
    const today = appState.countsByDate[key];

    const mapping = {
        cigarettes: "count-cigarettes",
        joints: "count-joints",
        alcoolGlobal: "count-alcool-global",
        bieres: "count-bieres",
        liqueurs: "count-liqueurs",
        alcoolFort: "count-alcool-fort"
    };

    Object.keys(mapping).forEach(cat => {
        const spanId = mapping[cat];
        const el = document.getElementById(spanId);
        if (el) el.textContent = today[cat] || 0;
    });

    // R√©sum√© journ√©e
    document.getElementById("summary-cigarettes").textContent = today.cigarettes || 0;
    document.getElementById("summary-joints").textContent = today.joints || 0;
    document.getElementById("summary-alcool-global").textContent = today.alcoolGlobal || 0;
    document.getElementById("summary-bieres").textContent = today.bieres || 0;
    document.getElementById("summary-liqueurs").textContent = today.liqueurs || 0;
    document.getElementById("summary-alcool-fort").textContent = today.alcoolFort || 0;
}

// =========================
// STATS R√âSUM√â (BASIC)
// (les vrais graphiques arriveront plus tard)
// =========================

function refreshStatsSummariesBasic() {
    const today = new Date();
    const dayKey = getTodayKey();
    const counts = appState.countsByDate || {};

    let dayTotalUnits = 0, weekTotalUnits = 0, monthTotalUnits = 0, yearTotalUnits = 0;
    let dayTotalCost = 0, weekTotalCost = 0, monthTotalCost = 0, yearTotalCost = 0;

    // Petits objets pour stocker le d√©tail par cat√©gorie
    function makeEmptyTotals() {
        return {
            cigarettes: 0,
            joints: 0,
            alcoolGlobal: 0,
            bieres: 0,
            liqueurs: 0,
            alcoolFort: 0
        };
    }

    const totalsDay = makeEmptyTotals();
    const totalsWeek = makeEmptyTotals();
    const totalsMonth = makeEmptyTotals();
    const totalsYear = makeEmptyTotals();

    Object.keys(counts).forEach(dateKey => {
        const parts = dateKey.split("-");
        if (parts.length !== 3) return;
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const dt = new Date(y, m, d);

        const day = counts[dateKey] || {};
        const cig = day.cigarettes || 0;
        const joints = day.joints || 0;
        const alcG = day.alcoolGlobal || 0;
        const beers = day.bieres || 0;
        const liq = day.liqueurs || 0;
        const strong = day.alcoolFort || 0;

        const sumForDay = cig + joints + alcG + beers + liq + strong;
        const costForDay = estimateDayCost(dateKey);

        // Jour
        if (dateKey === dayKey) {
            dayTotalUnits += sumForDay;
            dayTotalCost += costForDay;

            totalsDay.cigarettes += cig;
            totalsDay.joints += joints;
            totalsDay.alcoolGlobal += alcG;
            totalsDay.bieres += beers;
            totalsDay.liqueurs += liq;
            totalsDay.alcoolFort += strong;
        }

        // Semaine (7 derniers jours)
        const diffDays = Math.floor((today - dt) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays < 7) {
            weekTotalUnits += sumForDay;
            weekTotalCost += costForDay;

            totalsWeek.cigarettes += cig;
            totalsWeek.joints += joints;
            totalsWeek.alcoolGlobal += alcG;
            totalsWeek.bieres += beers;
            totalsWeek.liqueurs += liq;
            totalsWeek.alcoolFort += strong;
        }

        // Mois (m√™me mois / ann√©e que aujourd'hui)
        if (dt.getFullYear() === today.getFullYear() && dt.getMonth() === today.getMonth()) {
            monthTotalUnits += sumForDay;
            monthTotalCost += costForDay;

            totalsMonth.cigarettes += cig;
            totalsMonth.joints += joints;
            totalsMonth.alcoolGlobal += alcG;
            totalsMonth.bieres += beers;
            totalsMonth.liqueurs += liq;
            totalsMonth.alcoolFort += strong;
        }

        // Ann√©e (m√™me ann√©e)
        if (dt.getFullYear() === today.getFullYear()) {
            yearTotalUnits += sumForDay;
            yearTotalCost += costForDay;

            totalsYear.cigarettes += cig;
            totalsYear.joints += joints;
            totalsYear.alcoolGlobal += alcG;
            totalsYear.bieres += beers;
            totalsYear.liqueurs += liq;
            totalsYear.alcoolFort += strong;
        }
    });

// ----- D√âTAIL PAR P√âRIODE (Stats + Agenda) -----

const dayDetailText =
    `Cigarettes : ${totalsDay.cigarettes} ¬∑ ` +
    `Joints : ${totalsDay.joints} ¬∑ ` +
    `Alcool global : ${totalsDay.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsDay.bieres} ¬∑ ` +
    `Liqueurs : ${totalsDay.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsDay.alcoolFort}`;

const weekDetailText =
    `Cigarettes : ${totalsWeek.cigarettes} ¬∑ ` +
    `Joints : ${totalsWeek.joints} ¬∑ ` +
    `Alcool global : ${totalsWeek.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsWeek.bieres} ¬∑ ` +
    `Liqueurs : ${totalsWeek.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsWeek.alcoolFort}`;

const monthDetailText =
    `Cigarettes : ${totalsMonth.cigarettes} ¬∑ ` +
    `Joints : ${totalsMonth.joints} ¬∑ ` +
    `Alcool global : ${totalsMonth.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsMonth.bieres} ¬∑ ` +
    `Liqueurs : ${totalsMonth.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsMonth.alcoolFort}`;

const yearDetailText =
    `Cigarettes : ${totalsYear.cigarettes} ¬∑ ` +
    `Joints : ${totalsYear.joints} ¬∑ ` +
    `Alcool global : ${totalsYear.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsYear.bieres} ¬∑ ` +
    `Liqueurs : ${totalsYear.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsYear.alcoolFort}`;

function setDetail(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

// D√©tails pour l‚Äôonglet Stats
setDetail("stats-day-details",   dayDetailText);
setDetail("stats-week-details",  weekDetailText);
setDetail("stats-month-details", monthDetailText);
setDetail("stats-year-details",  yearDetailText);

// D√©tails pour l‚Äôonglet Agenda
setDetail("agenda-day-details",   dayDetailText);
setDetail("agenda-week-details",  weekDetailText);
setDetail("agenda-month-details", monthDetailText);
setDetail("agenda-year-details",  yearDetailText);

// ----- LIGNES "Total : xx unit√©s (~yy ‚Ç¨)" pour Stats + Agenda -----

const daySummaryText   = `Total : ${dayTotalUnits} unit√©s (~${formatMoney(dayTotalCost)})`;
const weekSummaryText  = `Total : ${weekTotalUnits} unit√©s (~${formatMoney(weekTotalCost)})`;
const monthSummaryText = `Total : ${monthTotalUnits} unit√©s (~${formatMoney(monthTotalCost)})`;
const yearSummaryText  = `Total : ${yearTotalUnits} unit√©s (~${formatMoney(yearTotalCost)})`;

function setSummary(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

// Totaux pour Stats
setSummary("stats-day-summary",   daySummaryText);
setSummary("stats-week-summary",  weekSummaryText);
setSummary("stats-month-summary", monthSummaryText);
setSummary("stats-year-summary",  yearSummaryText);

// Totaux pour Agenda
setSummary("agenda-day-summary",   daySummaryText);
setSummary("agenda-week-summary",  weekSummaryText);
setSummary("agenda-month-summary", monthSummaryText);
setSummary("agenda-year-summary",  yearSummaryText);

logDebug("Stats r√©sum√© mis √† jour (Stats + Agenda).");
}

// =========================
// CONSEILS ADAPTATIFS (VERSION √âTENDUE)
// =========================

let adviceTimer = null;

function startAdviceLoop() {
    if (adviceTimer) clearInterval(adviceTimer);
    updateAdviceText(); // premi√®re fois
    // toutes les 3 minutes = 180000 ms
    adviceTimer = setInterval(updateAdviceText, 180000);
}

function updateAdviceText() {
    const el = document.getElementById("adviceText");
    if (!el) return;

    const hasCosts  = checkHasCosts();
    const hasHabits = checkHasHabits();
    const hasDates  = checkHasDates();
    const firstName = (appState.user.firstName || "").trim();

    const todayKey = getTodayKey();
    const countsByDate = appState.countsByDate || {};
    const today = countsByDate[todayKey] || {};

    const todayTotal =
        (today.cigarettes   || 0) +
        (today.joints       || 0) +
        (today.alcoolGlobal || 0) +
        (today.bieres       || 0) +
        (today.liqueurs     || 0) +
        (today.alcoolFort   || 0);

    // Moyenne tr√®s simple sur les 7 derniers jours
    const now = new Date();
    let sum7 = 0;
    let daysCount7 = 0;
    Object.keys(countsByDate).forEach(key => {
        const parts = key.split("-");
        if (parts.length !== 3) return;
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const dt = new Date(y, m, d);
        const diffDays = Math.floor((now - dt) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays < 7) {
            const day = countsByDate[key] || {};
            const dayTotal =
                (day.cigarettes   || 0) +
                (day.joints       || 0) +
                (day.alcoolGlobal || 0) +
                (day.bieres       || 0) +
                (day.liqueurs     || 0) +
                (day.alcoolFort   || 0);
            sum7 += dayTotal;
            daysCount7++;
        }
    });
    const avg7 = daysCount7 > 0 ? sum7 / daysCount7 : 0;

    // ---------------------------
    // 1. Banque de conseils (‚âà100 messages)
    // ---------------------------

    // 1.a ‚Äì Conseils g√©n√©raux (base pour tout le monde)
    const generalAdvice = [
        // 1
        "Chaque cigarette ou verre en moins est d√©j√† une victoire, m√™me si tu ne le vois pas tout de suite.",
        // 2
        "Les envies sont comme des vagues : elles montent, puis redescendent si tu ne montes pas dessus.",
        // 3
        "Tu n‚Äôes pas oblig√© d‚Äô√™tre parfait, tu as juste besoin de continuer √† essayer.",
        // 4
        "Changer une habitude prend du temps : la r√©p√©tition compte plus que la motivation.",
        // 5
        "Respirer lentement pendant 30 secondes peut d√©j√† calmer une envie forte.",
        // 6
        "Tu peux changer ta consommation sans changer qui tu es.",
        // 7
        "Un jour difficile n‚Äôefface pas tous les efforts des jours pr√©c√©dents.",
        // 8
        "Noter ce que tu consommes te redonne du contr√¥le, pas de la culpabilit√©.",
        // 9
        "Tu as le droit d‚Äô√™tre fier de toi d√®s que tu fais un pas dans la bonne direction.",
        // 10
        "R√©duire, ce n‚Äôest pas renoncer au plaisir, c‚Äôest choisir quand tu en as vraiment envie.",
        // 11
        "Tu peux te demander : est-ce que j‚Äôen ai vraiment envie, ou est-ce juste l‚Äôhabitude ?",
        // 12
        "Boire un verre d‚Äôeau avant de fumer ou de boire ralentit la m√©canique automatique.",
        // 13
        "Tu peux tr√®s bien faire une pause sans d√©cider tout de suite d‚Äôarr√™ter pour toujours.",
        // 14
        "M√™me une petite baisse r√©guli√®re finit par faire une √©norme diff√©rence sur l‚Äôann√©e.",
        // 15
        "Te comparer aux autres ne sert √† rien, c‚Äôest ton rythme et ton histoire qui comptent.",
        // 16
        "Tu peux transformer cette appli en journal de bord de ton changement, pas en tribunal.",
        // 17
        "Donne-toi le droit de recommencer autant de fois que n√©cessaire.",
        // 18
        "Changer une seule chose √† la fois est souvent plus efficace que vouloir tout modifier d‚Äôun coup.",
        // 19
        "Tu peux d√©cider qu‚Äôaujourd‚Äôhui sera une journ√©e un peu plus douce pour ton corps.",
        // 20
        "M√™me si tu ne vois pas les effets tout de suite, ton organisme les enregistre.",
        // 21
        "Tu peux utiliser tes envies comme des signaux : fatigue, stress, ennui‚Ä¶ √† toi de d√©coder.",
        // 22
        "Il n‚Äôy a pas de petit progr√®s : moins, c‚Äôest d√©j√† mieux que pareil.",
        // 23
        "Tu as le droit de demander de l‚Äôaide si tu sens que c‚Äôest trop lourd tout seul.",
        // 24
        "Changer ta relation au tabac ou √† l‚Äôalcool, c‚Äôest d√©j√† prendre soin de toi.",
        // 25
        "Tu peux d√©cider que cette appli est l√† pour t‚Äôencourager, pas pour te juger.",
        // 26
        "Plus tu observes tes habitudes, plus tu rep√®res les moments o√π tu peux agir.",
        // 27
        "Tu n‚Äôes pas en retard : tu commences exactement au moment o√π tu es pr√™t.",
        // 28
        "Chaque journ√©e o√π tu remplis l‚Äôappli est une journ√©e o√π tu es conscient de ta consommation.",
        // 29
        "Tu peux te fixer de tr√®s petits objectifs : ils sont plus faciles √† atteindre et motivent plus.",
        // 30
        "Tu as d√©j√† fait le plus dur : d√©cider de regarder ta consommation en face."
    ];

    // 1.b ‚Äì Sant√© / corps
    const healthAdvice = [
        // 31
        "Ton corps adore les pauses : moins de toxiques aujourd‚Äôhui, c‚Äôest plus d‚Äô√©nergie demain.",
        // 32
        "Boire un grand verre d‚Äôeau √† chaque envie peut d√©j√† l‚Äôatt√©nuer un peu.",
        // 33
        "Un peu de marche ou d‚Äô√©tirements peut d√©tourner une envie de fumer ou de boire.",
        // 34
        "Ton sommeil peut s‚Äôam√©liorer d√®s que ta consommation baisse, m√™me l√©g√®rement.",
        // 35
        "Tes poumons te remercient √† chaque cigarette √©vit√©e, m√™me si tu continues √† fumer.",
        // 36
        "Ton foie lui aussi adore les jours plus calmes en alcool.",
        // 37
        "Faire une vraie pause sans √©cran ni clope aide aussi ton cerveau √† souffler.",
        // 38
        "Remplacer une clope ou un verre par un geste agr√©able pour toi reste un vrai progr√®s.",
        // 39
        "Ton corps ne demande pas de perfection, juste un peu plus de douceur.",
        // 40
        "Un simple exercice de respiration peut √™tre ton premier outil anti-envie.",
        // 41
        "Moins de consommation, c‚Äôest aussi plus de souffle pour marcher, monter les escaliers, chanter.",
        // 42
        "√Ä chaque r√©duction, ton c≈ìur travaille un peu moins en surr√©gime.",
        // 43
        "Ton odorat et ton go√ªt peuvent vite s‚Äôam√©liorer quand tu r√©duis.",
        // 44
        "Respecter au moins quelques heures sans conso le soir aide ton sommeil √† se r√©parer.",
        // 45
        "Tu peux lier une r√©duction de conso √† une autre habitude positive : sport l√©ger, marche, douche.",
        // 46
        "Ton corps a une capacit√© de r√©cup√©ration incroyable, m√™me apr√®s des ann√©es.",
        // 47
        "Un jour avec un peu moins de conso, c‚Äôest d√©j√† un jour o√π ton organisme respire mieux.",
        // 48
        "Tu peux √©couter les signaux de ton corps plut√¥t que les r√©flexes automatiques.",
        // 49
        "Ton √©nergie n‚Äôest pas infinie : chaque r√©duction te rend un peu de carburant.",
        // 50
        "Tes futures versions de toi te remercieront pour chaque petite baisse d‚Äôaujourd‚Äôhui."
    ];

    // 1.c ‚Äì Argent / budget
    const moneyAdvice = [
        // 51
        "L‚Äôargent que tu ne mets pas dans la clope ou l‚Äôalcool, tu peux le transformer en projets.",
        // 52
        "M√™me quelques euros √©conomis√©s chaque jour finissent par repr√©senter une grosse somme.",
        // 53
        "Tu peux te fixer un mini-objectif : √©conomiser de quoi t‚Äôoffrir quelque chose que tu aimes.",
        // 54
        "Suivre ton budget conso, ce n‚Äôest pas culpabiliser, c‚Äôest reprendre la main.",
        // 55
        "Tu peux d√©cider qu‚Äôune partie de ce que tu √©conomises ira dans un projet plaisir.",
        // 56
        "Visualiser la somme d√©pens√©e sur un mois peut t‚Äôaider √† ajuster ton rythme.",
        // 57
        "Ton futur toi peut profiter de cet argent pour voyager, t‚Äô√©quiper ou juste souffler.",
        // 58
        "Chaque verre ou cigarette non pris, c‚Äôest quelques pi√®ces qui restent dans ta poche.",
        // 59
        "Tu peux utiliser l‚Äôappli comme un tableau de bord de tes √©conomies cach√©es.",
        // 60
        "M√™me si la somme te para√Æt petite aujourd‚Äôhui, elle grossit avec la r√©p√©tition.",
        // 61
        "Tu peux relier une baisse de conso √† un projet concret : sortie, week-end, activit√©.",
        // 62
        "L‚Äôid√©e n‚Äôest pas de te priver, mais de choisir o√π tu veux vraiment mettre ton argent.",
        // 63
        "Tu peux te demander : est-ce que ce paquet ou cette bouteille vaut ce que je pourrais faire avec cet argent ?",
        // 64
        "R√©duire un peu la conso, c‚Äôest aussi all√©ger la fin de mois.",
        // 65
        "Tu peux transformer ton suivi de conso en suivi d‚Äô√©conomies positives."
    ];

    // 1.d ‚Äì Habitudes / rythme au quotidien
    const habitsAdvice = [
        // 66
        "Observer √† quels moments tu consommes le plus t‚Äôaide √† trouver tes vrais d√©clencheurs.",
        // 67
        "Tu peux tester : d√©caler une conso de 10 minutes pour voir si l‚Äôenvie passe.",
        // 68
        "Changer un tout petit d√©tail dans ta routine peut casser un automatisme.",
        // 69
        "Tu peux commencer par r√©duire sur un seul moment de la journ√©e, pas sur tous.",
        // 70
        "Rep√©rer tes ‚Äòclopes automatiques‚Äô est d√©j√† un √©norme pas.",
        // 71
        "Tu peux choisir un cr√©neau ‚Äòsans conso‚Äô dans la journ√©e pour t‚Äôentra√Æner.",
        // 72
        "Certaines consommations sont du plaisir, d‚Äôautres juste du r√©flexe : les distinguer aide beaucoup.",
        // 73
        "Quand tu remplis l‚Äôappli, tu transformes ton habitude en donn√©e que tu peux piloter.",
        // 74
        "Tu peux te dire : aujourd‚Äôhui, je garde seulement celles dont j‚Äôai vraiment envie.",
        // 75
        "Identifier les lieux o√π tu consommes le plus t‚Äôaide √† ajuster ton environnement.",
        // 76
        "Tu peux d√©cider de lier la conso √† des moments pr√©cis plut√¥t qu‚Äô√† tout et n‚Äôimporte quoi.",
        // 77
        "Remplacer un automatisme par un micro-rituel diff√©rent peut d√©j√† casser le sch√©ma.",
        // 78
        "Tu peux observer quels jours de la semaine sont les plus lourds pour adapter ton planning.",
        // 79
        "R√©duire un peu mais souvent change r√©ellement ton rythme de fond.",
        // 80
        "Chaque fois que tu remplis l‚Äôagenda, tu affines la carte de tes habitudes."
    ];

    // 1.e ‚Äì Dates, objectifs, soir√©es, √©carts, r√©ussites
    const datesAndSituationsAdvice = [
        // 81
        "Une date d‚Äôobjectif est un phare, pas une obligation de tout r√©ussir du premier coup.",
        // 82
        "Tu peux pr√©parer les quelques jours avant une grosse date en all√©geant progressivement.",
        // 83
        "Si tu as d√©j√† choisi une date de r√©duction ou d‚Äôarr√™t, tu as d√©j√† pris une d√©cision importante.",
        // 84
        "Un ‚Äò√©cart‚Äô apr√®s une date d‚Äôobjectif ne casse pas tout, il t‚Äôapprend comment mieux te pr√©parer.",
        // 85
        "Tu peux utiliser les soir√©es √† risque pour tester de nouveaux r√©flexes plut√¥t que pour te juger.",
        // 86
        "Si tu d√©passes ton objectif un jour, tu peux viser un jour plus l√©ger juste apr√®s.",
        // 87
        "Un jour sans conso, m√™me isol√©, m√©rite d‚Äô√™tre c√©l√©br√©.",
        // 88
        "Tu peux noter ce qui t‚Äôa aid√© les jours o√π tu as moins consomm√© pour t‚Äôen resservir.",
        // 89
        "Tes dates dans l‚Äôappli sont l√† pour t‚Äôaider √† te projeter, pas pour te mettre la pression.",
        // 90
        "Apr√®s une soir√©e charg√©e, tu peux te programmer une journ√©e plus calme pour r√©cup√©rer.",
        // 91
        "Tu peux choisir une ‚Äòjourn√©e test‚Äô par semaine pour tenter une r√©duction un peu plus forte.",
        // 92
        "Un objectif r√©aliste vaut mieux qu‚Äôune promesse impossible qui d√©courage.",
        // 93
        "Tu peux relire tes donn√©es autour d‚Äôune date importante pour voir ce qui t‚Äôa aid√© ou frein√©.",
        // 94
        "Si ton objectif a d√©j√† √©t√© d√©pass√©, tu peux en fixer un nouveau plus adapt√© √† ton rythme.",
        // 95
        "Une r√©ussite, m√™me modeste, peut devenir ton nouveau rep√®re pour la suite.",
        // 96
        "Tu peux d√©cider que cette semaine sera surtout une semaine d‚Äôobservation sans pression.",
        // 97
        "Avant une date importante, pr√©voir une ou deux strat√©gies de secours peut t‚Äô√©viter un ‚Äòcraquage‚Äô massif.",
        // 98
        "Tu peux adapter tes objectifs en fonction de ta p√©riode de vie : stress, fatigue, vacances‚Ä¶",
        // 99
        "Tes objectifs sont l√† pour t‚Äôaccompagner, pas pour te punir quand tu t‚Äôen √©loignes.",
        // 100
        "Tu peux consid√©rer chaque date d‚Äôobjectif comme une √©tape, pas comme un examen."
    ];

    // ---------------------------
    // 2. Construction du message du jour
    // ---------------------------

    function pickOne(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    const messages = [];

    // Cas o√π l‚Äôutilisateur n‚Äôa encore presque rien rempli
    if (!hasCosts && !hasHabits && !hasDates && Object.keys(countsByDate).length === 0) {
        const base = "Commence par entrer tes habitudes, tes co√ªts ou des dates d‚Äôobjectif dans les onglets Habitudes et R√©glages pour personnaliser les conseils.";
        messages.push(base);
        messages.push(pickOne(generalAdvice));
    } else {
        // 1) Toujours au moins un conseil g√©n√©ral
        messages.push(pickOne(generalAdvice));

        // 2) Sant√© si la conso du jour est pr√©sente
        if (todayTotal > 0) {
            messages.push(pickOne(healthAdvice));
        }

        // 3) Argent si les co√ªts sont renseign√©s
        if (hasCosts) {
            const costToday = estimateDayCost(todayKey) || 0;
            const costWeek  = computePeriodCost(7);
            const costMonth = computePeriodCost(30);

            let moneyLine = "";
            if (costToday > 0) {
                moneyLine = `Aujourd‚Äôhui, ta consommation repr√©sente environ ${formatMoney(costToday)}.`;
            } else {
                moneyLine = "Tu peux renseigner tes co√ªts pour voir l‚Äôargent que tu √©conomises vraiment.";
            }

            messages.push(moneyLine);
            messages.push(pickOne(moneyAdvice));

            // Petit clin d‚Äô≈ìil budget si semaine/mois non nuls
            if (costWeek > 0 || costMonth > 0) {
                messages.push(`Sur la semaine ou le mois, √ßa peut vite repr√©senter une belle somme √† r√©cup√©rer pour tes projets.`);
            }
        }

        // 4) Habitudes / tendance (si un peu d‚Äôhistorique)
        if (daysCount7 > 0) {
            let trendLine = "";
            if (todayTotal === 0) {
                trendLine = "Aujourd‚Äôhui, tu es √† z√©ro consommation : c‚Äôest une journ√©e tr√®s forte pour toi.";
            } else if (avg7 > 0 && todayTotal < avg7 * 0.7) {
                trendLine = "Aujourd‚Äôhui, tu es en dessous de ton rythme des 7 derniers jours : tr√®s bon signal.";
            } else if (avg7 > 0 && todayTotal > avg7 * 1.3) {
                trendLine = "Aujourd‚Äôhui, tu es nettement au-dessus de ton rythme des 7 derniers jours : tu peux regarder ce qui a jou√©.";
            } else if (avg7 > 0) {
                trendLine = "Tu es globalement dans ton rythme des derniers jours ; tu peux tester une petite r√©duction si tu te sens pr√™t.";
            }
            if (trendLine) messages.push(trendLine);
            messages.push(pickOne(habitsAdvice));
        }

        // 5) Dates / objectifs si des dates sont pr√©sentes
        if (hasDates) {
            messages.push(pickOne(datesAndSituationsAdvice));
        }
    }

    // Assemblage final
    let finalText = messages.join(" ");

    if (firstName) {
        finalText = firstName + ", " + finalText;
    }

    el.textContent = finalText;
}

// Petit helper pour le co√ªt sur X jours (si les prix sont remplis)
function computePeriodCost(daysCount) {
    const today = new Date();
    const countsByDate = appState.countsByDate || {};
    let total = 0;

    Object.keys(countsByDate).forEach(key => {
        const parts = key.split("-");
        if (parts.length !== 3) return;
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const dt = new Date(y, m, d);
        const diffDays = Math.floor((today - dt) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays < daysCount) {
            total += estimateDayCost(key) || 0;
        }
    });

    return total;
}
// =========================
// AVERTISSEMENT MAJORIT√â
// =========================

function showWarningIfNeeded() {
    const overlay = document.getElementById("popup-warning-overlay");
    if (!overlay) return;

    if (appState.flags.hideWarning && appState.flags.isAdultConfirmed) {
        overlay.style.display = "none";
        return;
    }

    // si pas confirm√©, on l'affiche au d√©marrage
    if (!appState.flags.isAdultConfirmed) {
        overlay.style.display = "block";
    }
}

function acceptWarning() {
    const chkAdult = document.getElementById("chk-is-adult");
    const chkHide = document.getElementById("chk-hide-warning");
    if (!chkAdult || !chkAdult.checked) {
        alert("Tu dois confirmer que tu es majeur(e) pour continuer.");
        return;
    }
    appState.flags.isAdultConfirmed = true;
    appState.flags.hideWarning = !!(chkHide && chkHide.checked);
    saveState();
    closePopup("warning");
}

function quitApp() {
    // Dans un vrai APK, l'utilisateur pourra simplement fermer l'app.
    alert("Tu peux maintenant quitter l'application.");
    // window.close() ne fonctionne pas toujours, mais on le laisse au cas o√π.
    try { window.close(); } catch (e) {}
}

// Activation / d√©sactivation du bouton J'accepte
document.addEventListener("change", function (e) {
    if (e.target && (e.target.id === "chk-is-adult" || e.target.id === "chk-hide-warning")) {
        const chkAdult = document.getElementById("chk-is-adult");
        const btn = document.getElementById("btn-accept-warning");
        if (btn && chkAdult) {
            btn.disabled = !chkAdult.checked;
        }
    }
});

// =========================
// POPUPS G√âN√âRIQUES
// =========================

function openPopup(type) {
    const id = `popup-${type}-overlay`;
    const el = document.getElementById(id);
    if (el) {
        el.style.display = "block";
    }
}

function closePopup(type) {
    const id = `popup-${type}-overlay`;
    const el = document.getElementById(id);
    if (el) {
        el.style.display = "none";
    }
}

// =========================
// CONTACT SUPPORT
// =========================

function contactSupport() {
    const email = "stopmauvaiseshabitudes@gmail.com";
    window.location.href = `mailto:${email}`;
}

// =========================
// NAVIGATION ONGLET
// =========================

function switchTab(tabName) {
    const tabs = ["home", "stats", "agenda", "habits", "settings"];

    tabs.forEach(t => {
        const tabDiv = document.getElementById(`tab-${t}`);
        const navItem = document.getElementById(`nav-${t}`);
        if (!tabDiv || !navItem) return;
        if (t === tabName) {
            tabDiv.style.display = "block";
            navItem.classList.add("active");
        } else {
            tabDiv.style.display = "none";
            navItem.classList.remove("active");
        }
    });

    logDebug("Onglet actif: " + tabName);
}

// =========================
// AGENDA
// =========================

function initAgenda() {
    const now = new Date();
    agendaCurrentYear = now.getFullYear();
    agendaCurrentMonth = now.getMonth(); // 0-11
    renderAgenda();
}

function changeAgendaMonth(delta) {
    if (agendaCurrentYear === null || agendaCurrentMonth === null) {
        initAgenda();
        return;
    }
    agendaCurrentMonth += delta;
    if (agendaCurrentMonth < 0) {
        agendaCurrentMonth = 11;
        agendaCurrentYear--;
    } else if (agendaCurrentMonth > 11) {
        agendaCurrentMonth = 0;
        agendaCurrentYear++;
    }
    renderAgenda();
}

function renderAgenda() {
    const grid = document.getElementById("agendaGrid");
    const label = document.getElementById("agendaMonthLabel");
    if (!grid || !label) return;

    if (agendaCurrentYear === null || agendaCurrentMonth === null) {
        initAgenda();
        return;
    }

    grid.innerHTML = "";

    const firstDay = new Date(agendaCurrentYear, agendaCurrentMonth, 1);
    const lastDay = new Date(agendaCurrentYear, agendaCurrentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();

    const monthName = firstDay.toLocaleDateString(undefined, { month: "long", year: "numeric" });
    label.textContent = monthName;

    // On commence par des cases vides pour aligner le 1er jour sur le bon jour de semaine
    let startWeekDay = firstDay.getDay(); // 0 = dimanche
    // on veut Lundi=0 -> adaptation
    startWeekDay = (startWeekDay + 6) % 7;

    for (let i = 0; i < startWeekDay; i++) {
        const emptyCell = document.createElement("div");
        emptyCell.style.minHeight = "40px";
        grid.appendChild(emptyCell);
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement("div");
        cell.style.minHeight = "40px";
        cell.style.border = "1px solid #ddd";
        cell.style.borderRadius = "4px";
        cell.style.padding = "2px";
        cell.style.position = "relative";
        cell.style.fontSize = "10px";
        cell.style.background = "#fff";

        const dateObj = new Date(agendaCurrentYear, agendaCurrentMonth, day);
        const dateKey = getDateKey(dateObj);

        // numero du jour
        const dayLabel = document.createElement("div");
        dayLabel.textContent = day;
        dayLabel.style.fontWeight = "bold";
        dayLabel.style.fontSize = "11px";
        cell.appendChild(dayLabel);

        // ic√¥nes de consommation (tr√®s simple : on colore un mini carr√© si la cat√©gorie > 0)
        const counts = appState.countsByDate[dateKey] || {};
        const iconsContainer = document.createElement("div");
        iconsContainer.style.display = "flex";
        iconsContainer.style.flexWrap = "wrap";
        iconsContainer.style.gap = "2px";
        iconsContainer.style.marginTop = "2px";

        function addIconIf(catKey, color) {
            if (!counts[catKey] || counts[catKey] <= 0) return;
            const icon = document.createElement("span");
            icon.style.display = "inline-block";
            icon.style.width = "6px";
            icon.style.height = "6px";
            icon.style.background = color;
            icon.style.borderRadius = "2px";
            iconsContainer.appendChild(icon);
        }

        addIconIf("cigarettes", "#111");
        addIconIf("joints", "#228b22");
        addIconIf("alcoolGlobal", "#b5651d");
        addIconIf("bieres", "#1e90ff");
        addIconIf("liqueurs", "#800080");
        addIconIf("alcoolFort", "#8b0000");

        // dates de volont√© (on ajoute un carr√© or s'il y a une date qui correspond)
        const will = appState.willDates || {};
        const thisDateStr = dateKey;

        if (
            (will.cigarettes && (will.cigarettes.reduction === thisDateStr || will.cigarettes.stop === thisDateStr || will.cigarettes.success === thisDateStr)) ||
            (will.joints && (will.joints.reduction === thisDateStr || will.joints.stop === thisDateStr || will.joints.success === thisDateStr)) ||
            (will.alcoolGlobal && (will.alcoolGlobal.reduction === thisDateStr || will.alcoolGlobal.stop === thisDateStr || will.alcoolGlobal.success === thisDateStr)) ||
            (will.bieres && (will.bieres.reduction === thisDateStr || will.bieres.stop === thisDateStr || will.bieres.success === thisDateStr)) ||
            (will.liqueurs && (will.liqueurs.reduction === thisDateStr || will.liqueurs.stop === thisDateStr || will.liqueurs.success === thisDateStr)) ||
            (will.alcoolFort && (will.alcoolFort.reduction === thisDateStr || will.alcoolFort.stop === thisDateStr || will.alcoolFort.success === thisDateStr))
        ) {
            const willIcon = document.createElement("span");
            willIcon.style.display = "inline-block";
            willIcon.style.width = "8px";
            willIcon.style.height = "8px";
            willIcon.style.background = "#ffd700";
            willIcon.style.borderRadius = "2px";
            willIcon.style.marginLeft = "2px";
            iconsContainer.appendChild(willIcon);
        }

        cell.appendChild(iconsContainer);

        // clic sur un jour : ouverture de l'encart d'√©dition
	cell.addEventListener("click", () => {
    				openAgendaEditor(dateKey);
	});

        grid.appendChild(cell);
    }
}
// =========================
// AGENDA : √©dition d'un jour
// =========================

function ensureDateEntry(dateKey) {
    if (!appState.countsByDate[dateKey]) {
        appState.countsByDate[dateKey] = {
            cigarettes: 0,
            joints: 0,
            alcoolGlobal: 0,
            bieres: 0,
            liqueurs: 0,
            alcoolFort: 0
        };
    }
}

function openAgendaEditor(dateKey) {
    agendaSelectedDateKey = dateKey;
    ensureDateEntry(dateKey);

    const overlay = document.getElementById("agendaEditorOverlay");
    const title   = document.getElementById("agendaEditorTitle");
    if (!overlay || !title) return;

    title.textContent = "√âdition du " + dateKey;

    const day = appState.countsByDate[dateKey];

    // remplir les compteurs
    document.getElementById("agenda-count-cigarettes").textContent   = day.cigarettes || 0;
    document.getElementById("agenda-count-joints").textContent       = day.joints || 0;
    document.getElementById("agenda-count-alcoolGlobal").textContent = day.alcoolGlobal || 0;
    document.getElementById("agenda-count-bieres").textContent       = day.bieres || 0;
    document.getElementById("agenda-count-liqueurs").textContent     = day.liqueurs || 0;
    document.getElementById("agenda-count-alcoolFort").textContent   = day.alcoolFort || 0;

    overlay.style.display = "flex";
}

function closeAgendaEditor() {
    const overlay = document.getElementById("agendaEditorOverlay");
    if (overlay) overlay.style.display = "none";
    agendaSelectedDateKey = null;
}

function changeAgendaCount(categoryKey, delta) {
    if (!agendaSelectedDateKey) return;

    // respect des cat√©gories activ√©es/d√©sactiv√©es
    if (!appState.categoriesEnabled[categoryKey]) {
        logDebug(`Cat√©gorie ${categoryKey} d√©sactiv√©e (agenda), incr√©ment ignor√©.`);
        return;
    }

    ensureDateEntry(agendaSelectedDateKey);
    const day = appState.countsByDate[agendaSelectedDateKey];

    let current = day[categoryKey] || 0;
    current += delta;
    if (current < 0) current = 0;
    day[categoryKey] = current;
    appState.countsByDate[agendaSelectedDateKey] = day;

    saveState();

    // mise √† jour de l'encart
    const spanId = "agenda-count-" + categoryKey;
    const spanEl = document.getElementById(spanId);
    if (spanEl) spanEl.textContent = current;

    // si c'est la journ√©e du jour, on met aussi √† jour l'accueil & stats
    if (agendaSelectedDateKey === getTodayKey()) {
        refreshHomeCounters();
        updateProfileBanner();
        refreshStatsSummariesBasic();
    }

    // mise √† jour visuelle du calendrier
    renderAgenda();
}

function resetAgendaDay() {
    if (!agendaSelectedDateKey) return;
    if (!confirm("Effacer les entr√©es de cette journ√©e ?")) return;

    appState.countsByDate[agendaSelectedDateKey] = {
        cigarettes: 0,
        joints: 0,
        alcoolGlobal: 0,
        bieres: 0,
        liqueurs: 0,
        alcoolFort: 0
    };

    saveState();

    // si c'est aujourd'hui -> accueil + stats
    if (agendaSelectedDateKey === getTodayKey()) {
        refreshHomeCounters();
        updateProfileBanner();
        refreshStatsSummariesBasic();
    }

    renderAgenda();
    openAgendaEditor(agendaSelectedDateKey); // r√©-ouvre l'encart √† 0
}

// =========================
// RAZ & EXPORT / IMPORT
// (les d√©tails seront compl√©t√©s bloc 4,
// mais les fonctions existent d√©j√†)
// =========================

function resetDay() {
    if (!confirm("Effacer les entr√©es de la journ√©e en cours ?")) return;
    ensureTodayEntry();
    const key = getTodayKey();
    appState.countsByDate[key] = {
        cigarettes: 0,
        joints: 0,
        alcoolGlobal: 0,
        bieres: 0,
        liqueurs: 0,
        alcoolFort: 0
    };
    saveState();
    refreshHomeCounters();
    refreshStatsSummariesBasic();
    renderAgenda();
}

function resetHistory() {
    if (!confirm("Effacer TOUT l'historique de consommation ?")) return;
    appState.countsByDate = {};
    saveState();
    refreshHomeCounters();
    refreshStatsSummariesBasic();
    renderAgenda();
}

function resetFactory() {
    if (!confirm("Effacer TOUTES les donn√©es (consommations, r√©glages, habitudes, dates) ?")) return;
    localStorage.removeItem(STORAGE_KEY);
    // recharger state par d√©faut
    appState = {
        version: "1.0.0",
        language: "fr",
        currency: "EUR",
        user: { firstName: "" },
        flags: { isAdultConfirmed: false, hideWarning: false },
        categoriesEnabled: {
            cigarettes: true,
            joints: true,
            alcoolGlobal: true,
            bieres: true,
            liqueurs: true,
            alcoolFort: true
        },
        countsByDate: {},
        habits: {
            cigarettes: 0,
            joints: 0,
            alcoolGlobal: 0,
            bieres: 0,
            liqueurs: 0,
            alcoolFort: 0
        },
        willDates: {
            cigarettes: { reduction: "", stop: "", success: "" },
            joints: { reduction: "", stop: "", success: "" },
            alcoolGlobal: { reduction: "", stop: "", success: "" },
            bieres: { reduction: "", stop: "", success: "" },
            liqueurs: { reduction: "", stop: "", success: "" },
            alcoolFort: { reduction: "", stop: "", success: "" }
        },
        prices: appState.prices, // on garde la structure prix par d√©faut
        meta: { createdAt: new Date().toISOString(), lastUpdate: null }
    };
    saveState();
    initUI();
    renderAgenda();
    refreshHomeCounters();
    refreshStatsSummariesBasic();
}

// EXPORT / IMPORT JSON (version simple, bloc 4 compl√®tera)
function exportData() {
    const dataStr = JSON.stringify(appState, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    a.href = url;
    a.download = `stopaddict_export_${y}${m}${d}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function importDataFromFile(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
        try {
            const imported = JSON.parse(e.target.result);
            appState = imported;
            saveState();
            initUI();
            renderAgenda();
            refreshHomeCounters();
            refreshStatsSummariesBasic();
            alert("Import r√©ussi.");
        } catch (err) {
            alert("Erreur lors de l'import du fichier.");
        }
    };
    reader.readAsText(file);
}

// =========================
// LIENS UI <-> STATE
// (initialisation des champs)
// =========================

function initUI() {
    // Langue & monnaie
    const langSel = document.getElementById("language-select");
    const curSel = document.getElementById("currency-select");
    if (langSel) langSel.value = appState.language || "fr";
    if (curSel) curSel.value = appState.currency || "EUR";

    if (langSel) {
        langSel.onchange = function () {
            const newLang = langSel.value;
            if (confirm("L'application va red√©marrer pour appliquer la nouvelle langue. Les donn√©es ne seront pas effac√©es.")) {
                appState.language = newLang;
                saveState();
                location.reload();
            } else {
                langSel.value = appState.language || "fr";
            }
        };
    }

    if (curSel) {
        curSel.onchange = function () {
            appState.currency = curSel.value;
            saveState();
        };
    }

    // Pr√©nom
    const firstNameInput = document.getElementById("user-firstname");
    if (firstNameInput) {
        firstNameInput.value = appState.user.firstName || "";
        firstNameInput.oninput = function () {
            appState.user.firstName = firstNameInput.value;
            saveState();
        };
    }

    // Habitues
    const h = appState.habits || {};
    const mapHabits = {
        "habit-max-cigarettes": "cigarettes",
        "habit-max-joints": "joints",
        "habit-max-alcool-global": "alcoolGlobal",
        "habit-max-bieres": "bieres",
        "habit-max-liqueurs": "liqueurs",
        "habit-max-alcool-fort": "alcoolFort"
    };
    Object.keys(mapHabits).forEach(inputId => {
        const cat = mapHabits[inputId];
        const el = document.getElementById(inputId);
        if (!el) return;
        el.value = h[cat] || "";
        el.oninput = function () {
            const v = parseInt(el.value || "0", 10);
            appState.habits[cat] = isNaN(v) ? 0 : v;
            saveState();
        };
    });

    // Dates volont√©
    const w = appState.willDates || {};
    const willMap = [
        ["will-cigarettes-reduction", "cigarettes", "reduction"],
        ["will-cigarettes-stop", "cigarettes", "stop"],
        ["will-cigarettes-success", "cigarettes", "success"],

        ["will-joints-reduction", "joints", "reduction"],
        ["will-joints-stop", "joints", "stop"],
        ["will-joints-success", "joints", "success"],

        ["will-alcool-global-reduction", "alcoolGlobal", "reduction"],
        ["will-alcool-global-stop", "alcoolGlobal", "stop"],
        ["will-alcool-global-success", "alcoolGlobal", "success"],

        ["will-bieres-reduction", "bieres", "reduction"],
        ["will-bieres-stop", "bieres", "stop"],
        ["will-bieres-success", "bieres", "success"],

        ["will-liqueurs-reduction", "liqueurs", "reduction"],
        ["will-liqueurs-stop", "liqueurs", "stop"],
        ["will-liqueurs-success", "liqueurs", "success"],

        ["will-alcool-fort-reduction", "alcoolFort", "reduction"],
        ["will-alcool-fort-stop", "alcoolFort", "stop"],
        ["will-alcool-fort-success", "alcoolFort", "success"]
    ];

    willMap.forEach(([id, cat, kind]) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.value = (w[cat] && w[cat][kind]) || "";
        el.onchange = function () {
            if (!appState.willDates[cat]) appState.willDates[cat] = { reduction: "", stop: "", success: "" };
            appState.willDates[cat][kind] = el.value;
            saveState();
            renderAgenda();
        };
    });

    // Cat√©gories activ√©es (Accueil + R√©glages)
    const catMapToggleHome = {
        "toggle-cigarettes": "cigarettes",
        "toggle-joints": "joints",
        "toggle-alcool-global": "alcoolGlobal",
        "toggle-bieres": "bieres",
        "toggle-liqueurs": "liqueurs",
        "toggle-alcool-fort": "alcoolFort"
    };
    Object.keys(catMapToggleHome).forEach(id => {
        const cat = catMapToggleHome[id];
        const el = document.getElementById(id);
        if (!el) return;
        el.checked = !!appState.categoriesEnabled[cat];
        el.onchange = function () {
            setCategoryEnabled(cat, el.checked, true);
        };
    });

    const catMapSettings = {
        "settings-cigarettes-enabled": "cigarettes",
        "settings-joints-enabled": "joints",
        "settings-alcool-global-enabled": "alcoolGlobal",
        "settings-bieres-enabled": "bieres",
        "settings-liqueurs-enabled": "liqueurs",
        "settings-alcool-fort-enabled": "alcoolFort"
    };
    Object.keys(catMapSettings).forEach(id => {
        const cat = catMapSettings[id];
        const el = document.getElementById(id);
        if (!el) return;
        el.checked = !!appState.categoriesEnabled[cat];
        el.onchange = function () {
            setCategoryEnabled(cat, el.checked, false);
        };
    });

    // Prix
    const p = appState.prices || {};
    // cigarettes classiques
    bindNumber("price-pack-classic", p.cigarettes.classic, "pricePack");
    bindNumber("count-pack-classic", p.cigarettes.classic, "countPack");
    // roul√©es
    bindNumber("price-pack-roll", p.cigarettes.roll, "priceTobaccoPack");
    bindNumber("count-pack-roll", p.cigarettes.roll, "countFromPack");
    bindNumber("price-rolling-papers", p.cigarettes.roll, "pricePapers");
    bindNumber("count-rolling-papers", p.cigarettes.roll, "countPapers");
    bindNumber("price-filters", p.cigarettes.roll, "priceFilters");
    bindNumber("count-filters", p.cigarettes.roll, "countFilters");
    // tubes
    bindNumber("price-pack-tube", p.cigarettes.tube, "priceTobaccoPack");
    bindNumber("count-pack-tube", p.cigarettes.tube, "countFromPack");
    bindNumber("price-tubes", p.cigarettes.tube, "priceTubes");
    bindNumber("count-tubes", p.cigarettes.tube, "countTubes");
    // joints
    bindNumber("price-gram-cannabis", p.joints, "priceGram");
    bindNumber("grams-per-joint", p.joints, "gramsPerJoint");
    bindNumber("price-cannabis-papers", p.joints, "pricePapers");
    bindNumber("count-cannabis-papers", p.joints, "countPapers");
    // alcool global
    bindNumber("price-glass-alcool-global", p.alcoolGlobal, "priceGlass");
    bindNumber("unit-alcool-global-cl", p.alcoolGlobal, "unitCl");
    // bi√®res
    bindNumber("price-beer", p.bieres, "priceBeer");
    bindNumber("unit-beer-cl", p.bieres, "unitCl");
    // liqueur
    bindNumber("price-liqueur", p.liqueurs, "priceGlass");
    bindNumber("unit-liqueur-cl", p.liqueurs, "unitCl");
    // alcool fort
    bindNumber("price-strong-alcohol", p.alcoolFort, "priceGlass");
    bindNumber("unit-strong-alcohol-cl", p.alcoolFort, "unitCl");

    // compteurs accueil & stats
    refreshHomeCounters();
    refreshStatsSummariesBasic();
    updateProfileBanner();
}

function bindNumber(inputId, obj, key) {
    const el = document.getElementById(inputId);
    if (!el || !obj) return;
    el.value = obj[key] || "";
    el.oninput = function () {
        const val = parseFloat(el.value.replace(",", ".") || "0");
        obj[key] = isNaN(val) ? 0 : val;
        saveState();
    };
}

// Activation/d√©sactivation cat√©gories avec logique alcool global vs autres
function setCategoryEnabled(cat, enabled, fromHome) {
    // gestion sp√©ciale alcoolGlobal vs bi√®res/liqueurs/alcoolFort
    if (cat === "alcoolGlobal" && enabled) {
        appState.categoriesEnabled.alcoolGlobal = true;
        appState.categoriesEnabled.bieres = false;
        appState.categoriesEnabled.liqueurs = false;
        appState.categoriesEnabled.alcoolFort = false;
    } else if ((cat === "bieres" || cat === "liqueurs" || cat === "alcoolFort") && enabled) {
        appState.categoriesEnabled.alcoolGlobal = false;
        appState.categoriesEnabled[cat] = true;
    } else {
        appState.categoriesEnabled[cat] = !!enabled;
    }

    // mettre √† jour cases accueil + r√©glages
    const homeIdMap = {
        cigarettes: "toggle-cigarettes",
        joints: "toggle-joints",
        alcoolGlobal: "toggle-alcool-global",
        bieres: "toggle-bieres",
        liqueurs: "toggle-liqueurs",
        alcoolFort: "toggle-alcool-fort"
    };
    const settingsIdMap = {
        cigarettes: "settings-cigarettes-enabled",
        joints: "settings-joints-enabled",
        alcoolGlobal: "settings-alcool-global-enabled",
        bieres: "settings-bieres-enabled",
        liqueurs: "settings-liqueurs-enabled",
        alcoolFort: "settings-alcool-fort-enabled"
    };

    Object.keys(homeIdMap).forEach(c => {
        const elH = document.getElementById(homeIdMap[c]);
        const elS = document.getElementById(settingsIdMap[c]);
        const val = !!appState.categoriesEnabled[c];
        if (elH) elH.checked = val;
        if (elS) elS.checked = val;
    });

    saveState();
    logDebug(`setCategoryEnabled(${cat}, ${enabled})`);
}

// =========================
// INIT GLOBALE
// =========================

document.addEventListener("DOMContentLoaded", function () {
    loadState();
    // direction RTL pour arabe
    if (appState.language === "ar") {
        document.documentElement.setAttribute("dir", "rtl");
    } else {
        document.documentElement.setAttribute("dir", "ltr");
    }

    updateDateTime();
    setInterval(updateDateTime, 1000);

    initUI();
    initAgenda();
    startAdviceLoop();
    showWarningIfNeeded();

    // Onglet par d√©faut : accueil
    switchTab("home");
});

</script>

<!-- ===================
     FIN BLOC 3 ‚Äî COLLER BLOC 4 ICI
     =================== -->
<!-- =========================
     BLOC 4 ‚Äî LOGIQUE CO√õTS
     R√©sum√© stats = unit√©s + co√ªt estim√©
     (remplace la version simple de refreshStatsSummariesBasic)
     ========================= -->

<script>
// ===== Helpers num√©riques =====
function safeNum(v) {
    if (v === null || v === undefined || v === "") return 0;
    const n = parseFloat(String(v).replace(",", "."));
    return isNaN(n) ? 0 : n;
}

// ===== Co√ªt par unit√© : Cigarettes =====
function getCostPerCigarette() {
    const p = appState.prices.cigarettes;

    // classiques
    const pricePackClassic = safeNum(p.classic.pricePack);
    const countPackClassic = safeNum(p.classic.countPack);
    const perClassic = (pricePackClassic > 0 && countPackClassic > 0)
        ? pricePackClassic / countPackClassic
        : 0;

    // roul√©es (tabac + feuille + filtre)
    const priceRollTobacco = safeNum(p.roll.priceTobaccoPack);
    const countRollFromPack = safeNum(p.roll.countFromPack);
    const perRollTobacco = (priceRollTobacco > 0 && countRollFromPack > 0)
        ? priceRollTobacco / countRollFromPack
        : 0;

    const pricePapers = safeNum(p.roll.pricePapers);
    const countPapers = safeNum(p.roll.countPapers);
    const perPaper = (pricePapers > 0 && countPapers > 0)
        ? pricePapers / countPapers
        : 0;

    const priceFilters = safeNum(p.roll.priceFilters);
    const countFilters = safeNum(p.roll.countFilters);
    const perFilter = (priceFilters > 0 && countFilters > 0)
        ? priceFilters / countFilters
        : 0;

    const perRolled = (perRollTobacco > 0 || perPaper > 0 || perFilter > 0)
        ? (perRollTobacco + perPaper + perFilter)
        : 0;

    // tubes (tabac + tube)
    const priceTubeTobacco = safeNum(p.tube.priceTobaccoPack);
    const countTubeFromPack = safeNum(p.tube.countFromPack);
    const perTubeTobacco = (priceTubeTobacco > 0 && countTubeFromPack > 0)
        ? priceTubeTobacco / countTubeFromPack
        : 0;

    const priceTubes = safeNum(p.tube.priceTubes);
    const countTubes = safeNum(p.tube.countTubes);
    const perTube = (priceTubes > 0 && countTubes > 0)
        ? priceTubes / countTubes
        : 0;

    const perTuber = (perTubeTobacco > 0 || perTube > 0)
        ? (perTubeTobacco + perTube)
        : 0;

    const candidates = [];
    if (perClassic > 0) candidates.push(perClassic);
    if (perRolled > 0) candidates.push(perRolled);
    if (perTuber > 0) candidates.push(perTuber);

    if (candidates.length === 0) return 0;

    // moyenne simple des modes renseign√©s (approximation neutre)
    const sum = candidates.reduce((a, b) => a + b, 0);
    return sum / candidates.length;
}

// ===== Co√ªt par unit√© : Joint =====
function getCostPerJoint() {
    const pj = appState.prices.joints;
    const priceGram = safeNum(pj.priceGram);
    const gramsPerJoint = safeNum(pj.gramsPerJoint);
    const pricePapers = safeNum(pj.pricePapers);
    const countPapers = safeNum(pj.countPapers);

    const perWeed = (priceGram > 0 && gramsPerJoint > 0)
        ? priceGram * gramsPerJoint
        : 0;

    const perPaper = (pricePapers > 0 && countPapers > 0)
        ? pricePapers / countPapers
        : 0;

    if (perWeed === 0 && perPaper === 0) return 0;
    return perWeed + perPaper;
}

// ===== Co√ªt par unit√© : Alcool =====
function getCostPerAlcoolGlobal() {
    const p = appState.prices.alcoolGlobal;
    return safeNum(p.priceGlass);
}
function getCostPerBeer() {
    const p = appState.prices.bieres;
    return safeNum(p.priceBeer);
}
function getCostPerLiqueur() {
    const p = appState.prices.liqueurs;
    return safeNum(p.priceGlass);
}
function getCostPerStrongAlcohol() {
    const p = appState.prices.alcoolFort;
    return safeNum(p.priceGlass);
}

// ===== Co√ªt d'une journ√©e (toutes cat√©gories) =====
function estimateDayCost(dateKey) {
    const day = appState.countsByDate[dateKey];
    if (!day) return 0;

    const cCig = getCostPerCigarette();
    const cJoint = getCostPerJoint();
    const cAlcG = getCostPerAlcoolGlobal();
    const cBeer = getCostPerBeer();
    const cLiq = getCostPerLiqueur();
    const cStrong = getCostPerStrongAlcohol();

    let total = 0;
    total += (day.cigarettes || 0) * cCig;
    total += (day.joints || 0) * cJoint;
    total += (day.alcoolGlobal || 0) * cAlcG;
    total += (day.bieres || 0) * cBeer;
    total += (day.liqueurs || 0) * cLiq;
    total += (day.alcoolFort || 0) * cStrong;

    return total;
}

// ===== Symboles devises =====
const currencySymbols = {
    "EUR": "‚Ç¨",
    "USD": "$",
    "GBP": "¬£",
    "JPY": "¬•",
    "CHF": "CHF"
};

function formatMoney(amount) {
    const cur = appState.currency || "EUR";
    const sym = currencySymbols[cur] || cur;
    const rounded = Math.round(amount * 100) / 100;
    return `${rounded.toFixed(2)} ${sym}`;
}

// ===== Nouvelle version de refreshStatsSummariesBasic (remplace l'ancienne) =====
function refreshStatsSummariesBasic() {
    const today = new Date();
    const dayKey = getTodayKey();
    const counts = appState.countsByDate || {};

    let dayTotalUnits = 0, weekTotalUnits = 0, monthTotalUnits = 0, yearTotalUnits = 0;
    let dayTotalCost = 0, weekTotalCost = 0, monthTotalCost = 0, yearTotalCost = 0;

    // Petits objets pour stocker le d√©tail par cat√©gorie
    function makeEmptyTotals() {
        return {
            cigarettes: 0,
            joints: 0,
            alcoolGlobal: 0,
            bieres: 0,
            liqueurs: 0,
            alcoolFort: 0
        };
    }

    const totalsDay = makeEmptyTotals();
    const totalsWeek = makeEmptyTotals();
    const totalsMonth = makeEmptyTotals();
    const totalsYear = makeEmptyTotals();

    Object.keys(counts).forEach(dateKey => {
        const parts = dateKey.split("-");
        if (parts.length !== 3) return;
        const y = parseInt(parts[0], 10);
        const m = parseInt(parts[1], 10) - 1;
        const d = parseInt(parts[2], 10);
        const dt = new Date(y, m, d);

        const day = counts[dateKey] || {};
        const cig = day.cigarettes || 0;
        const joints = day.joints || 0;
        const alcG = day.alcoolGlobal || 0;
        const beers = day.bieres || 0;
        const liq = day.liqueurs || 0;
        const strong = day.alcoolFort || 0;

        const sumForDay = cig + joints + alcG + beers + liq + strong;
        const costForDay = estimateDayCost(dateKey);

        // Jour
        if (dateKey === dayKey) {
            dayTotalUnits += sumForDay;
            dayTotalCost += costForDay;

            totalsDay.cigarettes += cig;
            totalsDay.joints += joints;
            totalsDay.alcoolGlobal += alcG;
            totalsDay.bieres += beers;
            totalsDay.liqueurs += liq;
            totalsDay.alcoolFort += strong;
        }

        // Semaine (7 derniers jours)
        const diffDays = Math.floor((today - dt) / (1000 * 60 * 60 * 24));
        if (diffDays >= 0 && diffDays < 7) {
            weekTotalUnits += sumForDay;
            weekTotalCost += costForDay;

            totalsWeek.cigarettes += cig;
            totalsWeek.joints += joints;
            totalsWeek.alcoolGlobal += alcG;
            totalsWeek.bieres += beers;
            totalsWeek.liqueurs += liq;
            totalsWeek.alcoolFort += strong;
        }

        // Mois (m√™me mois / ann√©e que aujourd'hui)
        if (dt.getFullYear() === today.getFullYear() && dt.getMonth() === today.getMonth()) {
            monthTotalUnits += sumForDay;
            monthTotalCost += costForDay;

            totalsMonth.cigarettes += cig;
            totalsMonth.joints += joints;
            totalsMonth.alcoolGlobal += alcG;
            totalsMonth.bieres += beers;
            totalsMonth.liqueurs += liq;
            totalsMonth.alcoolFort += strong;
        }

        // Ann√©e (m√™me ann√©e)
        if (dt.getFullYear() === today.getFullYear()) {
            yearTotalUnits += sumForDay;
            yearTotalCost += costForDay;

            totalsYear.cigarettes += cig;
            totalsYear.joints += joints;
            totalsYear.alcoolGlobal += alcG;
            totalsYear.bieres += beers;
            totalsYear.liqueurs += liq;
            totalsYear.alcoolFort += strong;
        }
    });

    // ----- D√âTAIL PAR P√âRIODE (Stats + Agenda) -----

const dayDetailText =
    `Cigarettes : ${totalsDay.cigarettes} ¬∑ ` +
    `Joints : ${totalsDay.joints} ¬∑ ` +
    `Alcool global : ${totalsDay.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsDay.bieres} ¬∑ ` +
    `Liqueurs : ${totalsDay.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsDay.alcoolFort}`;

const weekDetailText =
    `Cigarettes : ${totalsWeek.cigarettes} ¬∑ ` +
    `Joints : ${totalsWeek.joints} ¬∑ ` +
    `Alcool global : ${totalsWeek.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsWeek.bieres} ¬∑ ` +
    `Liqueurs : ${totalsWeek.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsWeek.alcoolFort}`;

const monthDetailText =
    `Cigarettes : ${totalsMonth.cigarettes} ¬∑ ` +
    `Joints : ${totalsMonth.joints} ¬∑ ` +
    `Alcool global : ${totalsMonth.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsMonth.bieres} ¬∑ ` +
    `Liqueurs : ${totalsMonth.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsMonth.alcoolFort}`;

const yearDetailText =
    `Cigarettes : ${totalsYear.cigarettes} ¬∑ ` +
    `Joints : ${totalsYear.joints} ¬∑ ` +
    `Alcool global : ${totalsYear.alcoolGlobal} ¬∑ ` +
    `Bi√®res : ${totalsYear.bieres} ¬∑ ` +
    `Liqueurs : ${totalsYear.liqueurs} ¬∑ ` +
    `Alcool fort : ${totalsYear.alcoolFort}`;

function setDetail(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

// D√©tails pour l‚Äôonglet Stats
setDetail("stats-day-details",   dayDetailText);
setDetail("stats-week-details",  weekDetailText);
setDetail("stats-month-details", monthDetailText);
setDetail("stats-year-details",  yearDetailText);

// D√©tails pour l‚Äôonglet Agenda
setDetail("agenda-day-details",   dayDetailText);
setDetail("agenda-week-details",  weekDetailText);
setDetail("agenda-month-details", monthDetailText);
setDetail("agenda-year-details",  yearDetailText);

// ----- LIGNES "Total : xx unit√©s (~yy ‚Ç¨)" pour Stats + Agenda -----

const daySummaryText   = `Total : ${dayTotalUnits} unit√©s (~${formatMoney(dayTotalCost)})`;
const weekSummaryText  = `Total : ${weekTotalUnits} unit√©s (~${formatMoney(weekTotalCost)})`;
const monthSummaryText = `Total : ${monthTotalUnits} unit√©s (~${formatMoney(monthTotalCost)})`;
const yearSummaryText  = `Total : ${yearTotalUnits} unit√©s (~${formatMoney(yearTotalCost)})`;

function setSummary(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

// Totaux pour Stats
setSummary("stats-day-summary",   daySummaryText);
setSummary("stats-week-summary",  weekSummaryText);
setSummary("stats-month-summary", monthSummaryText);
setSummary("stats-year-summary",  yearSummaryText);

// Totaux pour Agenda
setSummary("agenda-day-summary",   daySummaryText);
setSummary("agenda-week-summary",  weekSummaryText);
setSummary("agenda-month-summary", monthSummaryText);
setSummary("agenda-year-summary",  yearSummaryText);

logDebug("Stats r√©sum√© mis √† jour (Stats + Agenda).");
}


</script>

<!-- ===================
     FIN BLOC 4 ‚Äî COLLER BLOC 5 ICI
     =================== -->
<!-- =========================
     BLOC 5 ‚Äî GRAPHIQUES STATS
     Sans librairie externe (canvas 2D maison)
     ========================= -->

<script>
// =========================
// Petit moteur de graphiques maison
// =========================

function drawBarChart(canvasId, labels, values, opts = {}) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const container = canvas.parentElement;
    if (container) {
        const w = container.clientWidth || 300;
        const h = container.clientHeight || 200;
        canvas.width = w - 10;
        canvas.height = h - 10;
    }

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const width = canvas.width;
    const height = canvas.height;

    // Nettoyage
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, width, height);

    if (!values || values.length === 0 || !labels || labels.length === 0) {
        ctx.fillStyle = "#777";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Pas de donn√©es pour cette p√©riode", width / 2, height / 2);
        return;
    }

    const paddingLeft = 35;
    const paddingRight = 10;
    const paddingTop = 10;
    const paddingBottom = 40;

    const plotWidth = width - paddingLeft - paddingRight;
    const plotHeight = height - paddingTop - paddingBottom;

    const maxVal = Math.max(...values, 0);
    const safeMax = maxVal <= 0 ? 1 : maxVal * 1.1; // un peu plus haut que la plus grande barre

    // Axes
    ctx.strokeStyle = "#ccc";
    ctx.lineWidth = 1;

    // Axe Y
    ctx.beginPath();
    ctx.moveTo(paddingLeft, paddingTop);
    ctx.lineTo(paddingLeft, height - paddingBottom);
    ctx.stroke();

    // Axe X
    ctx.beginPath();
    ctx.moveTo(paddingLeft, height - paddingBottom);
    ctx.lineTo(width - paddingRight, height - paddingBottom);
    ctx.stroke();

    // Graduation Y simple (4 lignes)
    ctx.fillStyle = "#666";
    ctx.font = "10px Arial";
    ctx.textAlign = "right";

    const steps = 4;
    for (let i = 0; i <= steps; i++) {
        const val = (safeMax * i) / steps;
        const y = (height - paddingBottom) - (plotHeight * i) / steps;
        ctx.fillText(Math.round(val), paddingLeft - 4, y + 3);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(width - paddingRight, y);
        ctx.stroke();
    }

    // Barres
    const n = values.length;
    const barWidth = Math.max(3, plotWidth / (n * 1.5));
    const gap = (plotWidth - n * barWidth) / Math.max(1, (n - 1));

    ctx.textAlign = "center";
    ctx.font = "9px Arial";

    for (let i = 0; i < n; i++) {
        const val = values[i];
        const x = paddingLeft + i * (barWidth + gap);
        const barHeight = (val / safeMax) * plotHeight;
        const y = (height - paddingBottom) - barHeight;

        ctx.fillStyle = "#2563eb";
        ctx.fillRect(x, y, barWidth, barHeight);
	    // Valeur au-dessus de la barre
    if (val > 0) {
        ctx.fillStyle = "#000";
        ctx.font = "9px Arial";
        ctx.textAlign = "center";
        ctx.fillText(
            Math.round(val),
            x + barWidth / 2,
            y - 4
        );
    }
        // label X (on affiche un label sur 2 si trop serr√©)
        if (labels[i]) {
            if (n <= 15 || i % 2 === 0) {
                ctx.save();
                ctx.translate(x + barWidth / 2, height - paddingBottom + 10);
                ctx.rotate(-Math.PI / 4);
                ctx.fillStyle = "#444";
                ctx.fillText(labels[i], 0, 0);
                ctx.restore();
            }
        }
    }
}
function drawHabitsChart(canvasId, data) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const container = canvas.parentElement;
    if (container) {
        const w = container.clientWidth || 300;
        const h = container.clientHeight || 200;
        canvas.width = w - 10;
        canvas.height = h - 10;
    }

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const width = canvas.width;
    const height = canvas.height;
    ctx.clearRect(0, 0, width, height);

    const labels = data.labels || [];
    const series = data.series || {};
    const maxSeries = data.maxSeries || {};

    const cats = Object.keys(series);
    if (!labels.length || !cats.length) {
        ctx.fillStyle = "#666";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Pas de donn√©es pour cette p√©riode", width / 2, height / 2);
        return;
    }

    // calcul du max pour l'√©chelle
    let maxVal = 0;
    cats.forEach(cat => {
        (series[cat] || []).forEach(v => {
            if (v > maxVal) maxVal = v;
        });
        const m = maxSeries[cat] || 0;
        if (m > maxVal) maxVal = m;
    });

    if (maxVal <= 0) {
        ctx.fillStyle = "#666";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Pas de donn√©es pour cette p√©riode", width / 2, height / 2);
        return;
    }

    const safeMax = maxVal * 1.1;

    const paddingLeft = 40;
    const paddingRight = 10;
    const paddingTop = 20;
    const paddingBottom = 40;

    const plotWidth = width - paddingLeft - paddingRight;
    const plotHeight = height - paddingTop - paddingBottom;

    // Axes
    ctx.strokeStyle = "#999";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(paddingLeft, paddingTop);
    ctx.lineTo(paddingLeft, height - paddingBottom);
    ctx.lineTo(width - paddingRight, height - paddingBottom);
    ctx.stroke();

    // Lignes horizontales (4 niveaux)
    ctx.fillStyle = "#666";
    ctx.font = "10px Arial";
    ctx.textAlign = "right";
    const steps = 4;
    for (let i = 0; i <= steps; i++) {
        const val = (safeMax * i) / steps;
        const y = (height - paddingBottom) - (plotHeight * i) / steps;
        ctx.fillText(Math.round(val), paddingLeft - 4, y + 3);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(width - paddingRight, y);
        ctx.stroke();
    }

    const n = labels.length;
    const xStep = (n > 1) ? (plotWidth / (n - 1)) : 0;

    // couleurs par th√®me
    const palette = ["#2563eb","#16a34a","#f97316","#dc2626","#9333ea","#0ea5e9"];

    // Courbes par cat√©gorie
    cats.forEach((cat, idx) => {
        const values = series[cat] || [];
        const color = palette[idx % palette.length];

        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        values.forEach((v, i) => {
            const x = paddingLeft + i * xStep;
            const y = (height - paddingBottom) - (v / safeMax) * plotHeight;
            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // petits points
        ctx.fillStyle = color;
        values.forEach((v, i) => {
            const x = paddingLeft + i * xStep;
            const y = (height - paddingBottom) - (v / safeMax) * plotHeight;
            ctx.beginPath();
            ctx.arc(x, y, 2, 0, Math.PI * 2);
            ctx.fill();
        });
        	// valeurs num√©riques au-dessus des points (consommation)
        	ctx.fillStyle = color;
        	ctx.font = "8px Arial";
        	ctx.textAlign = "center";
        	values.forEach((v, i) => {
            		if (v <= 0) return; // on n'affiche pas les 0 pour all√©ger
            		const x = paddingLeft + i * xStep;
            		const y = (height - paddingBottom) - (v / safeMax) * plotHeight;
            		ctx.fillText(v, x, y - 6);
        });

    });

    // Lignes "Max" (habitudes)
    cats.forEach((cat, idx) => {
        const maxValCat = maxSeries[cat] || 0;
        if (maxValCat > 0) {
            const color = palette[idx % palette.length];
            const y = (height - paddingBottom) - (maxValCat / safeMax) * plotHeight;
            ctx.strokeStyle = color;
            ctx.setLineDash([4, 4]);
            ctx.beginPath();
            ctx.moveTo(paddingLeft, y);
            ctx.lineTo(width - paddingRight, y);
            ctx.stroke();
            ctx.setLineDash([]);

            // libell√©
            ctx.fillStyle = color;
            ctx.font = "9px Arial";
            ctx.textAlign = "left";
            ctx.fillText("Max " + cat, paddingLeft + 4, y - 4);
        }
    });

        // L√©gende simple (carr√© √† gauche du texte, sans chevauchement)
    let legendX = paddingLeft;
    let legendY = paddingTop -10;
    ctx.font = "9px Arial";
    ctx.textAlign = "left";

    cats.forEach((cat, idx) => {
        const color = palette[idx % palette.length];
        const boxSize = 8;

        // carr√© de couleur
        const boxY = legendY - boxSize + 2; // un peu au-dessus de la ligne de base
        ctx.fillStyle = color;
        ctx.fillRect(legendX, boxY, boxSize, boxSize);

        // texte √† droite du carr√©
        ctx.fillStyle = "#000";
        ctx.fillText(cat, legendX + boxSize + 4, legendY);

        legendX += 60; // espace entre chaque entr√©e de l√©gende
    });


    // Labels X
    ctx.fillStyle = "#444";
    ctx.font = "9px Arial";
    ctx.textAlign = "center";
    labels.forEach((lab, i) => {
        const x = paddingLeft + i * xStep;
        const y = height - paddingBottom + 12;
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(-Math.PI / 4);
        ctx.fillText(lab, 0, 0);
        ctx.restore();
    });
}
function drawCostEconomiesChart(canvasId, labels, values) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;

    const container = canvas.parentElement;
    if (container) {
        const w = container.clientWidth || 300;
        const h = container.clientHeight || 200;
        canvas.width = w - 10;
        canvas.height = h - 10;
    }

    const ctx = canvas.getContext("2d");
    if (!ctx) return;

    const width = canvas.width;
    const height = canvas.height;
    ctx.clearRect(0, 0, width, height);
    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0, 0, width, height);

    if (!labels || labels.length === 0 || !values || values.length === 0) {
        ctx.fillStyle = "#777";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Pas de donn√©es pour cette p√©riode", width / 2, height / 2);
        return;
    }

    const paddingLeft = 35;
    const paddingRight = 10;
    const paddingTop = 10;
    const paddingBottom = 40;

    const plotWidth = width - paddingLeft - paddingRight;
    const plotHeight = height - paddingTop - paddingBottom;

    let minVal = 0;
    let maxVal = 0;
    values.forEach(v => {
        if (v < minVal) minVal = v;
        if (v > maxVal) maxVal = v;
    });

    if (minVal === 0 && maxVal === 0) {
        ctx.fillStyle = "#777";
        ctx.font = "12px Arial";
        ctx.textAlign = "center";
        ctx.fillText("Pas de donn√©es pour cette p√©riode", width / 2, height / 2);
        return;
    }

    // On inclut 0 dans l'√©chelle
    minVal = Math.min(minVal, 0);
    maxVal = Math.max(maxVal, 0);

    const range = maxVal - minVal || 1;

    // Position de la ligne 0
    const zeroY = paddingTop + (maxVal / range) * plotHeight;

    // Axes
    ctx.strokeStyle = "#ccc";
    ctx.lineWidth = 1;

    // Axe Y
    ctx.beginPath();
    ctx.moveTo(paddingLeft, paddingTop);
    ctx.lineTo(paddingLeft, height - paddingBottom);
    ctx.stroke();

    // Axe X (ligne de base, passe par y = 0)
    ctx.beginPath();
    ctx.moveTo(paddingLeft, zeroY);
    ctx.lineTo(width - paddingRight, zeroY);
    ctx.stroke();

    // Graduation Y
    ctx.fillStyle = "#666";
    ctx.font = "10px Arial";
    ctx.textAlign = "right";
    const steps = 4;
    for (let i = 0; i <= steps; i++) {
        const val = minVal + (range * i) / steps;
        const y = paddingTop + (plotHeight * (maxVal - val)) / range;
        ctx.fillText(val.toFixed(0), paddingLeft - 4, y + 3);
        ctx.strokeStyle = "#eee";
        ctx.beginPath();
        ctx.moveTo(paddingLeft, y);
        ctx.lineTo(width - paddingRight, y);
        ctx.stroke();
    }

    const n = labels.length;
    const barWidth = n > 0 ? plotWidth / n : plotWidth;

    // Dessin des barres
    for (let i = 0; i < n; i++) {
        const label = labels[i];
        const v = values[i];

        const xCenter = paddingLeft + barWidth * i + barWidth / 2;

        const yValue = paddingTop + (plotHeight * (maxVal - v)) / range;

        let topY, bottomY;

        if (v >= 0) {
            // √©conomie : barre au-dessus de la ligne 0 (en vert)
            topY = yValue;
            bottomY = zeroY;
            ctx.fillStyle = "#16a34a";
        } else {
            // d√©passement : barre en-dessous de la ligne 0 (en rouge)
            topY = zeroY;
            bottomY = yValue;
            ctx.fillStyle = "#dc2626";
        }

        const rectHeight = Math.abs(bottomY - topY);
        const rectWidth = Math.max(barWidth * 0.5, 8);

        ctx.fillRect(xCenter - rectWidth / 2, topY, rectWidth, rectHeight);

        // Valeur num√©rique
        ctx.fillStyle = "#000";
        ctx.font = "10px Arial";
        ctx.textAlign = "center";
        const labelY = (v >= 0) ? topY - 4 : bottomY + 12;
        ctx.fillText(v.toFixed(0), xCenter, labelY);

        // Label X
        const lx = xCenter;
        const ly = height - paddingBottom + 12;
        ctx.save();
        ctx.translate(lx, ly);
        ctx.rotate(-Math.PI / 4);
        ctx.fillText(label, 0, 0);
        ctx.restore();
    }
}

// =========================
// Construction des s√©ries temporelles
// =========================
function buildHabitsTimeSeries(period) {
    const counts = appState.countsByDate || {};
    const today = new Date();

    const allCats = ["cigarettes","joints","alcoolGlobal","bieres","liqueurs","alcoolFort"];
    const activeCats = allCats.filter(cat => appState.categoriesEnabled && appState.categoriesEnabled[cat]);

    const data = {
        labels: [],
        series: {},
        maxSeries: {}
    };

    // initialiser les tableaux par cat√©gorie
    activeCats.forEach(cat => {
        data.series[cat] = [];
        const maxVal = (appState.habits && typeof appState.habits[cat] === "number")
            ? appState.habits[cat]
            : 0;
        data.maxSeries[cat] = maxVal;
    });

    // Petite fonction utilitaire pour r√©partir un total sur 4 tranches
    function splitInto4(total) {
        const arr = [0, 0, 0, 0];
        const base = Math.floor(total / 4);
        let rest = total % 4;
        for (let i = 0; i < 4; i++) {
            arr[i] = base;
        }
        let i = 0;
        while (rest > 0 && i < 4) {
            arr[i] += 1;
            rest--;
            i++;
        }
        return arr;
    }

    // ---------- P√âRIODE JOUR ----------
    if (period === "day") {
        const labels = ["00-07", "07-14", "14-21", "21-00"];
        const todayKey = getTodayKey();
        const day = counts[todayKey] || {};

        data.labels = labels;

        activeCats.forEach(cat => {
            const total = day[cat] || 0;
            const slices = splitInto4(total);
            data.series[cat] = slices;
        });

        return data;
    }

    // ---------- P√âRIODE SEMAINE ----------
    if (period === "week") {
        const labels = [];
        // On boucle sur les 7 derniers jours (comme buildTimeSeries)
        for (let offset = 6; offset >= 0; offset--) {
            const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - offset);
            const key = getDateKey(d);
            const day = counts[key] || {};
            const label = d.toLocaleDateString(undefined, { weekday: "short" });
            labels.push(label);
            activeCats.forEach(cat => {
                const current = data.series[cat];
                current.push(day[cat] || 0);
            });
        }
        data.labels = labels;
        return data;
    }

    // ---------- P√âRIODE MOIS ----------
    if (period === "month") {
        const labels = ["1", "6", "11", "16", "21", "26", "31"];
        data.labels = labels;

        // 7 seaux pour les jours
        const bucketCount = labels.length;
        const buckets = {};
        activeCats.forEach(cat => {
            buckets[cat] = new Array(bucketCount).fill(0);
        });

        const year = today.getFullYear();
        const monthIndex = today.getMonth(); // 0-11

        Object.keys(counts).forEach(dateKey => {
            const parts = dateKey.split("-");
            if (parts.length !== 3) return;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            const d = parseInt(parts[2], 10);
            if (y !== year || m !== monthIndex) return;

            let bucketIndex = 0;
            if (d <= 5) bucketIndex = 0;
            else if (d <= 10) bucketIndex = 1;
            else if (d <= 15) bucketIndex = 2;
            else if (d <= 20) bucketIndex = 3;
            else if (d <= 25) bucketIndex = 4;
            else if (d <= 30) bucketIndex = 5;
            else bucketIndex = 6;

            activeCats.forEach(cat => {
                const dayData = counts[dateKey] || {};
                buckets[cat][bucketIndex] += (dayData[cat] || 0);
            });
        });

        activeCats.forEach(cat => {
            data.series[cat] = buckets[cat];
        });

        return data;
    }

    // ---------- P√âRIODE ANN√âE ----------
    if (period === "year") {
        const labels = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sept", "Oct", "Nov", "D√©c"];
        data.labels = labels;

        const year = today.getFullYear();
        const monthsData = {};
        activeCats.forEach(cat => {
            monthsData[cat] = new Array(12).fill(0);
        });

        Object.keys(counts).forEach(dateKey => {
            const parts = dateKey.split("-");
            if (parts.length !== 3) return;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            if (y !== year) return;

            const dayData = counts[dateKey] || {};
            activeCats.forEach(cat => {
                monthsData[cat][m] += (dayData[cat] || 0);
            });
        });

        activeCats.forEach(cat => {
            data.series[cat] = monthsData[cat];
        });

        return data;
    }

    // P√©riode inconnue : on renvoie une structure vide
    return data;
}

// Retourne { labels: [], units: [], costs: [] } selon la p√©riode
function buildTimeSeries(period) {
    const counts = appState.countsByDate || {};
    const today = new Date();
    const result = {
        labels: [],
        units: [],
        costs: []
    };

    // ---------- P√âRIODE JOUR ----------
    // Abscisses fixes : 00-07 / 07-14 / 14-21 / 21-00
    if (period === "day") {
        const labels = ["00-07", "07-14", "14-21", "21-00"];
        const units = [0, 0, 0, 0];
        const costs = [0, 0, 0, 0];

        const todayKey = getTodayKey();
        const day = counts[todayKey];

        if (day) {
            const totalUnits =
                (day.cigarettes || 0) +
                (day.joints || 0) +
                (day.alcoolGlobal || 0) +
                (day.bieres || 0) +
                (day.liqueurs || 0) +
                (day.alcoolFort || 0);

            const totalCost = estimateDayCost(todayKey);

            if (totalUnits > 0) {
                const perSliceUnits = totalUnits / 4;
                const perSliceCost = totalCost / 4;
                for (let i = 0; i < 4; i++) {
                    units[i] = perSliceUnits;
                    costs[i] = perSliceCost;
                }
            }
        }

        result.labels = labels;
        result.units = units;
        result.costs = costs;
        return result;
    }

    // ---------- P√âRIODE SEMAINE ----------
    // 7 derniers jours, abscisses = jours de la semaine (Lun, Mar, ...)
    if (period === "week") {
        const labels = [];
        const units = [];
        const costs = [];

        for (let offset = 6; offset >= 0; offset--) {
            const d = new Date(today.getFullYear(), today.getMonth(), today.getDate() - offset);
            const key = getDateKey(d);
            const day = counts[key] || {};

            const dayUnits =
                (day.cigarettes || 0) +
                (day.joints || 0) +
                (day.alcoolGlobal || 0) +
                (day.bieres || 0) +
                (day.liqueurs || 0) +
                (day.alcoolFort || 0);

            const dayCost = estimateDayCost(key);

            const label = d.toLocaleDateString(undefined, { weekday: "short" });

            labels.push(label);
            units.push(dayUnits);
            costs.push(dayCost);
        }

        result.labels = labels;
        result.units = units;
        result.costs = costs;
        return result;
    }

    // ---------- P√âRIODE MOIS ----------
    // 7 tranches : 1, 6, 11, 16, 21, 26, 31
    if (period === "month") {
        const labels = ["1", "6", "11", "16", "21", "26", "31"];
        const units = [0, 0, 0, 0, 0, 0, 0];
        const costs = [0, 0, 0, 0, 0, 0, 0];

        const year = today.getFullYear();
        const monthIndex = today.getMonth(); // 0-11

        Object.keys(counts).forEach(dateKey => {
            const parts = dateKey.split("-");
            if (parts.length !== 3) return;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            const d = parseInt(parts[2], 10);
            if (y !== year || m !== monthIndex) return;

            const dayData = counts[dateKey];
            const sumForDay =
                (dayData.cigarettes || 0) +
                (dayData.joints || 0) +
                (dayData.alcoolGlobal || 0) +
                (dayData.bieres || 0) +
                (dayData.liqueurs || 0) +
                (dayData.alcoolFort || 0);
            const costForDay = estimateDayCost(dateKey);

            let bucketIndex = 0;
            if (d <= 5) bucketIndex = 0;
            else if (d <= 10) bucketIndex = 1;
            else if (d <= 15) bucketIndex = 2;
            else if (d <= 20) bucketIndex = 3;
            else if (d <= 25) bucketIndex = 4;
            else if (d <= 30) bucketIndex = 5;
            else bucketIndex = 6;

            units[bucketIndex] += sumForDay;
            costs[bucketIndex] += costForDay;
        });

        result.labels = labels;
        result.units = units;
        result.costs = costs;
        return result;
    }

    // ---------- P√âRIODE ANN√âE ----------
    // 12 mois de l'ann√©e en cours
    if (period === "year") {
        const labels = [];
        const units = [];
        const costs = [];

        for (let m = 0; m < 12; m++) {
            const dtRef = new Date(today.getFullYear(), m, 1);
            labels.push(dtRef.toLocaleDateString(undefined, { month: "short" }));
            units.push(0);
            costs.push(0);
        }

        const currentYear = today.getFullYear();

        Object.keys(counts).forEach(dateKey => {
            const parts = dateKey.split("-");
            if (parts.length !== 3) return;
            const y = parseInt(parts[0], 10);
            const m = parseInt(parts[1], 10) - 1;
            if (y !== currentYear) return;

            const dayData = counts[dateKey];
            const sumForDay =
                (dayData.cigarettes || 0) +
                (dayData.joints || 0) +
                (dayData.alcoolGlobal || 0) +
                (dayData.bieres || 0) +
                (dayData.liqueurs || 0) +
                (dayData.alcoolFort || 0);
            const costForDay = estimateDayCost(dateKey);

            if (m >= 0 && m < 12) {
                units[m] += sumForDay;
                costs[m] += costForDay;
            }
        });

        result.labels = labels;
        result.units = units;
        result.costs = costs;
        return result;
    }

    // Par d√©faut (s√©curit√©)
    result.labels = [];
    result.units = [];
    result.costs = [];
    return result;
}
function buildCostEconomiesSeries(period) {
    const counts = appState.countsByDate || {};
    const today = new Date();

    const allCats = ["cigarettes","joints","alcoolGlobal","bieres","liqueurs","alcoolFort"];
    const activeCats = allCats.filter(cat => appState.categoriesEnabled && appState.categoriesEnabled[cat]);

    const labels = [];
    const values = [];
    const economies = {};
    const pertes = {};

    // Prix unitaires par th√®me
    const unitCost = {
        cigarettes: getCostPerCigarette(),
        joints: getCostPerJoint(),
        alcoolGlobal: getCostPerAlcoolGlobal(),
        bieres: getCostPerBeer(),
        liqueurs: getCostPerLiqueur(),
        alcoolFort: getCostPerStrongAlcohol()
    };

    // Accumulation des unit√©s r√©elles par th√®me
    const realUnits = {};
    activeCats.forEach(cat => {
        realUnits[cat] = 0;
        economies[cat] = 0;
        pertes[cat] = 0;
    });

    // D√©terminer la plage de dates selon la p√©riode
    let startDate = null;
    let endDate = null;

    if (period === "day") {
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        endDate   = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    } else if (period === "week") {
        // 7 derniers jours
        startDate = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 6);
        endDate   = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    } else if (period === "month") {
        startDate = new Date(today.getFullYear(), today.getMonth(), 1);
        // fin de mois
        endDate   = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    } else if (period === "year") {
        startDate = new Date(today.getFullYear(), 0, 1);
        endDate   = new Date(today.getFullYear(), 11, 31);
    } else {
        // P√©riode inconnue : renvoyer des donn√©es vides
        return { labels: [], values: [], economies: {}, pertes: {} };
    }

    // Boucle sur chaque jour de la plage
    let nbJours = 0;
    for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
        nbJours++;
        const key = getDateKey(d);
        const day = counts[key] || {};
        activeCats.forEach(cat => {
            realUnits[cat] += (day[cat] || 0);
        });
    }

    // Calcul des co√ªts r√©els / habituels et des diff√©rences
    activeCats.forEach(cat => {
        const costPerUnit = unitCost[cat] || 0;
        const unitsReelles = realUnits[cat] || 0;
        const maxPerDay = (appState.habits && typeof appState.habits[cat] === "number")
            ? appState.habits[cat]
            : 0;

        const unitsHabit = maxPerDay * nbJours;

        const costReel = unitsReelles * costPerUnit;
        const costHabit = unitsHabit * costPerUnit;

        let diff = 0;
        if (costPerUnit > 0 && maxPerDay > 0) {
            // >0 = √©conomie, <0 = d√©passement
            diff = costHabit - costReel;
        }

        if (diff >= 0) {
            economies[cat] = diff;
            pertes[cat] = 0;
        } else {
            economies[cat] = 0;
            pertes[cat] = -diff; // stock√©e en positif, mais on dessinera en n√©gatif
        }

        labels.push(cat);
        values.push(diff); // valeur sign√©e
    });

    return {
        labels: labels,
        values: values,
        economies: economies,
        pertes: pertes
    };
}

// =========================
// Mise √† jour des 2 graphiques
// =========================

function updateStatsCharts() {
    const periodSelect = document.getElementById("statsPeriodSelect");
    if (!periodSelect) return;
    const period = periodSelect.value || "day";

    // 1) Graphique HABITUDES (haut)
    if (typeof buildHabitsTimeSeries === "function" && typeof drawHabitsChart === "function") {
        const habitsData = buildHabitsTimeSeries(period);
        drawHabitsChart("chartHabitudes", habitsData);
    } else {
        // Fallback si tu n'as pas encore coll√© le code du graphique 1
        const seriesOld = buildTimeSeries(period);
        drawBarChart("chartHabitudes", seriesOld.labels, seriesOld.units, {});
    }

    // 2) Graphique CO√õTS & √âCONOMIES (bas)
    if (typeof buildCostEconomiesSeries === "function" && typeof drawCostEconomiesChart === "function") {
        const econData = buildCostEconomiesSeries(period);
        drawCostEconomiesChart("chartCouts", econData.labels, econData.values);
    } else {
        // Fallback : ancien graph de co√ªts simples
        const series = buildTimeSeries(period);
        drawBarChart("chartCouts", series.labels, series.costs, {});
    }
}


// =========================
// Int√©gration avec le reste de l'app
// =========================

// Listener au chargement
document.addEventListener("DOMContentLoaded", function () {
    const periodSelect = document.getElementById("statsPeriodSelect");
    if (periodSelect) {
        periodSelect.addEventListener("change", updateStatsCharts);
    }
    // Premier affichage
    updateStatsCharts();

    // Mise √† jour p√©riodique (toutes les 30 secondes au cas o√π les donn√©es changent)
    setInterval(updateStatsCharts, 30000);
});

// Red√©finition de switchTab pour mettre √† jour les graphiques quand on ouvre l‚Äôonglet Stats
function switchTab(tabName) {
    const tabs = ["home", "stats", "agenda", "habits", "settings"];

    tabs.forEach(t => {
        const tabDiv = document.getElementById(`tab-${t}`);
        const navItem = document.getElementById(`nav-${t}`);
        if (!tabDiv || !navItem) return;
        if (t === tabName) {
            tabDiv.style.display = "block";
            navItem.classList.add("active");
        } else {
            tabDiv.style.display = "none";
            navItem.classList.remove("active");
        }
    });

    if (tabName === "stats") {
        updateStatsCharts();
        // texte + co√ªts du r√©sum√©
        if (typeof refreshStatsSummariesBasic === "function") {
            refreshStatsSummariesBasic();
        }
    }

    logDebug("Onglet actif (override bloc 5): " + tabName);
}
</script>

</body>
</html>
