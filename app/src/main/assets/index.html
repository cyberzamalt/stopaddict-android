<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Nom app visible côté navigateur / A2HS -->
<title>StopAddict — Compteur Tabac, Cannabis & Alcool (v2.3.1)</title>
<meta name="application-name" content="StopAddict">
<meta name="apple-mobile-web-app-title" content="StopAddict">

<!-- CSP stricte mais compatible exports data:/blob: et styles inline -->
<meta http-equiv="Content-Security-Policy"
      content="default-src 'self' data: blob:;
               img-src 'self' data: blob:;
               style-src 'self' 'unsafe-inline';
               script-src 'self' 'unsafe-inline';
               connect-src 'self';
               object-src 'none';
               base-uri 'none';
               form-action 'self'">

<style>
  :root{
    --bg1:#667eea; --bg2:#764ba2;
    --ink:#1f2937; --muted:#6b7280; --card:#ffffff;
    --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444; --info:#3b82f6;
    --chip:#f3f4f6; --divider:#e5e7eb;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--ink); background:linear-gradient(180deg,var(--bg1),var(--bg2));
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .container{max-width:460px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; background:#f8fafc; position:relative;}

  /* ====== Header + marque (ajout minimal : logo + nom) ====== */
  .header{position:sticky; top:0; z-index:3; background:linear-gradient(135deg,#2c3e50,#34495e); color:#fff; padding:10px 14px; text-align:center}
  .brand{display:flex; align-items:center; gap:8px; justify-content:center; margin-bottom:2px}
  .brand img{width:24px; height:24px; border-radius:6px; object-fit:cover}
  .brand-name{font-weight:900; letter-spacing:.2px}
  .brand-ver{opacity:.8; font-size:12px; margin-left:4px}
  .date{font-weight:800; font-size:18px}
  .heure{opacity:.95; font-size:13px; margin-top:2px}

  .debug-console{position:fixed; top:0; left:0; right:0; background:rgba(0,0,0,.95); color:#b5f7b7; font:12px/1.35 ui-monospace, Menlo, monospace; padding:6px 8px; max-height:40vh; overflow:auto; z-index:9999; border-bottom:2px solid #34d399; display:none}
  .debug-console.show{display:block}

  .stats-rapides{background:#fff; display:grid; grid-template-columns:repeat(4,1fr); gap:8px; padding:10px; border-bottom:1px solid var(--divider)}
  .stat-item{text-align:center}
  .stat-label{font-size:11px; color:var(--muted)}
  .stat-valeur{font-size:16px; font-weight:800; color:#111827}

  .ecran{display:none; flex:1; overflow:auto; padding:12px 12px 86px}
  .ecran.actif{display:block}

  .card{background:var(--card); border-radius:16px; box-shadow:0 2px 10px rgba(0,0,0,.06); padding:16px; margin:12px 0; position:relative}
  .card.bar-grey::before{content:""; position:absolute; inset:0 0 auto 0; height:3px; background:#95a5a6; border-radius:16px 16px 0 0}
  .card.bar-green::before{content:""; position:absolute; inset:0 0 auto 0; height:3px; background:#27ae60; border-radius:16px 16px 0 0}

  .row{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .title{font-weight:900; color:#111827; font-size:18px}
  .count{font-weight:900; font-size:28px}

  .pm{display:flex; justify-content:center; align-items:center; gap:20px; margin-top:10px}
  .btn-round{width:64px; height:64px; border-radius:50%; border:0; color:#fff; font-size:28px; font-weight:900; display:grid; place-items:center; cursor:pointer; transition:transform .12s ease}
  .btn-round:active{transform:scale(.92)}
  .btn-minus{background:linear-gradient(145deg,#e74c3c,#c0392b)}
  .btn-plus{background:linear-gradient(145deg,#3b5569,#2c3e50)}
  .btn-plus.green{background:linear-gradient(145deg,#27ae60,#1f7f49)}

  .segment{display:flex; gap:6px; margin-top:10px; flex-wrap:wrap}
  .seg{flex:1; min-width:88px; text-align:center; background:#eef2ff; border:2px solid #c7d2fe; color:#1e3a8a; border-radius:999px; padding:6px 8px; font-weight:800; font-size:12px; cursor:pointer}
  .seg.actif{background:#3b82f6; border-color:#3b82f6; color:#fff}

  .banner{border-radius:12px; padding:12px; margin-top:12px; color:#fff; display:flex; flex-direction:column; gap:8px}
  .banner.orange{background:linear-gradient(135deg,#f59e0b,#ef6c00)}
  .banner.green{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .banner .hello{font-weight:800}
  .chips{display:flex; gap:6px; flex-wrap:wrap}
  .chip{background:rgba(255,255,255,.15); border:1px solid rgba(255,255,255,.25); color:#fff; padding:4px 8px; border-radius:999px; font-size:12px; font-weight:800}
  .chip.cost{background:#fff; color:#111827}

  .row-slim{display:flex; align-items:center; gap:8px}
  .label{min-width:76px; font-weight:800}
  .bar{flex:1; height:8px; background:rgba(255,255,255,.25); border-radius:999px; overflow:hidden}
  .bar > span{display:block; height:100%; background:#fff; opacity:.9}
  .note{font-size:12px; opacity:.95}

  .adv-ctl{display:flex; align-items:center; gap:6px; justify-content:flex-end}
  .ctl{background:#fff; color:#111827; border-radius:8px; padding:4px 8px; text-decoration:none; font-weight:900; font-size:12px}
  .dots{font-size:12px; letter-spacing:3px; opacity:.85}

  .tabs{display:flex; gap:8px; margin-bottom:8px}
  .tab{flex:1; background:#e6fffa; border:2px solid #b2f5ea; color:#0f766e; border-radius:999px; padding:8px; font-weight:800; font-size:13px; text-align:center; cursor:pointer}
  .tab.actif{background:#3b82f6; border-color:#3b82f6; color:#fff}

  .divider{height:1px; background:var(--divider); margin:10px 0}
  .stats-block{background:#fff; border-radius:12px; padding:14px}

  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:center}
  .grid-2 .param{display:contents}
  .param label{font-size:13px; color:#374151; font-weight:700}
  .param input[type="number"], .param input[type="text"], .param input[type="date"]{width:100%; padding:8px 10px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; background:#f9fafb}
  .param input[type="checkbox"]{transform:scale(1.1)}
  .param .hint{grid-column:1 / -1; font-size:12px; color:#6b7280}
  .section-title{font-weight:900; font-size:15px; color:#111827; border-bottom:2px solid #eef2f7; padding-bottom:6px; margin-bottom:10px}

  .nav{position:fixed; left:50%; transform:translateX(-50%); bottom:0; width:100%; max-width:460px; background:#fff; border-top:1px solid var(--divider); display:flex; z-index:10}
  .nav button{flex:1; background:transparent; border:0; padding:10px 6px 8px; color:#64748b; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:2px; cursor:pointer}
  .nav button.actif{color:#3b82f6; background:rgba(59,130,246,.06)}
  .nav .ico{font-size:18px}

  .snackbar{position:fixed; left:50%; transform:translateX(-50%) translateY(20px); bottom:76px; background:#111827; color:#fff; padding:10px 14px; border-radius:999px; font-size:13px; display:none; gap:10px; align-items:center; z-index:20}
  .snackbar.show{display:flex; animation:fadeUp .2s ease}
  .snackbar a{color:#34d399; font-weight:900; text-decoration:none}
  @keyframes fadeUp{from{opacity:0; transform:translateX(-50%) translateY(40px)} to{opacity:1; transform:translateX(-50%) translateY(20px)}}

  .btn{background:#111827; color:#fff; border:0; border-radius:10px; padding:10px 12px; font-weight:800; cursor:pointer}
  .btn.alt{background:#374151}
  .btn.warn{background:#ef4444}
  .btn.small{padding:6px 10px; font-size:12px}

  /* ====== Calendrier ====== */
  .cal-controls{display:flex; gap:8px; align-items:center; justify-content:space-between; margin:6px 0 10px}
  .cal-month{font-weight:900}
  .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .cal-dow{font-size:11px; color:#6b7280; text-align:center}
  .cal-cell{background:#fff; border:1px solid #e5e7eb; min-height:56px; border-radius:10px; padding:6px; position:relative; cursor:pointer}
  .cal-num{font-size:12px; color:#6b7280; font-weight:800}
  .cal-badges{position:absolute; right:6px; bottom:6px; display:flex; gap:4px; align-items:center}
  .dot{width:8px; height:8px; border-radius:50%}
  .dot.c{background:#1e293b}
  .dot.j{background:#16a34a}
  .dot.a{background:#f59e0b}
  .cal-empty{opacity:.35}
  .cal-flag{position:absolute; left:6px; bottom:6px; font-size:11px; background:#e0f2fe; color:#075985; padding:2px 6px; border-radius:999px; font-weight:800}
  .cal-heat{position:absolute; inset:0; border-radius:10px; background:rgba(59,130,246,.08); pointer-events:none}
  .cal-heat.mid{background:rgba(59,130,246,.14)}
  .cal-heat.high{background:rgba(59,130,246,.22)}

  /* ====== Modales génériques (réutilisées) ====== */
  .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:flex-end; justify-content:center; z-index:50}
  .modal.show{display:flex}
  .sheet{background:#fff; width:100%; max-width:460px; border-radius:16px 16px 0 0; padding:14px}
  .sheet h3{margin:4px 0 10px; font-size:16px}
  .sheet .mini{font-size:12px; color:#6b7280}
  .sheet .line{display:flex; align-items:center; justify-content:space-between; margin:8px 0}
  .sheet .line .lbl{font-weight:800}
  .sheet .seg{min-width:80px}
  .tag{display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1e3a8a; font-weight:800; border:1px solid #c7d2fe}

  /* ====== Modale Avertissement (1ère ouverture) ====== */
  .warn-title{font-weight:900; font-size:16px; margin:0 0 8px}
  .warn-box{background:#fff; border:2px solid #e5e7eb; border-radius:12px; padding:10px}
  .warn-list{font-size:14px; margin:8px 0 0 16px}
  .warn-actions{display:flex; gap:8px; margin-top:12px; justify-content:space-between}
  .warn-actions .right{display:flex; gap:8px}
  .warn-note{font-size:12px; color:#6b7280}

  /* ====== À propos (liens internes) ====== */
  .about-links{display:flex; flex-wrap:wrap; gap:8px}
  .about-links .btn.small{white-space:nowrap}
  .pages-title{font-weight:900; font-size:16px; margin:0 0 10px}
  .page-content{max-height:55vh; overflow:auto; font-size:14px; line-height:1.45}
  .page-content h4{margin:12px 0 6px; font-size:15px}
  .page-content p{margin:6px 0}
  .page-content ul{margin:6px 0 6px 18px}
</style>
<style>
/* === [NOUVEAU] Charts CSS (v2.4.0) — portée limitée à #stats-charts === */
#stats-charts { margin-top: 12px; }

#stats-charts .row {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
}

#stats-charts .chart-legend {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  font-size: 0.9rem;
}

#stats-charts .legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 4px 8px;
  border-radius: 999px;
  background: var(--chip-bg, #f3f4f6);
  border: 1px solid var(--chip-bd, #e5e7eb);
  cursor: pointer;
  user-select: none;
}

#stats-charts .legend-swatch {
  width: 14px;
  height: 3px;
  border-radius: 2px;
  background: #bbb; /* surchargé en JS */
  display: inline-block;
}

#stats-charts .legend-item.is-muted {
  opacity: 0.45;
  text-decoration: line-through;
}

#stats-charts .chart-block { margin-top: 10px; }

#stats-charts .chart-caption {
  font-weight: 600;
  margin: 8px 0 4px;
  font-size: 1rem;
  opacity: 0.9;
}

#stats-charts canvas {
  width: 100%;
  height: auto;
  display: block;
  image-rendering: -webkit-optimize-contrast;
  image-rendering: crisp-edges;
}

#stats-charts .chart-empty {
  padding: 10px 12px;
  font-size: 0.95rem;
  color: #6b7280;
  background: #f9fafb;
  border: 1px dashed #e5e7eb;
  border-radius: 8px;
  margin-top: 8px;
}

#stats-charts .chart-actions {
  display: flex;
  gap: 8px;
  justify-content: flex-end;
  margin-top: 8px;
}
#stats-charts .chart-actions .btn {
  font-size: 0.9rem;
  padding: 6px 10px;
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 8px;
  cursor: pointer;
}
/* Petites tailles d'écran */
@media (max-width: 480px) {
  #stats-charts .title { font-size: 1rem; }
  #stats-charts .chart-caption { font-size: 0.95rem; }
  #stats-charts .legend-item { padding: 3px 6px; }
}

/* Force l'affichage du texte des boutons d'export */
#stats-charts .chart-actions .btn,
#chart-actions .btn {
  font-size: 14px !important;
  padding: 10px 16px !important;
  min-height: 40px !important;
  line-height: 1.4 !important;
  display: inline-block !important;
  overflow: visible !important;
  text-indent: 0 !important;
  white-space: normal !important;
  text-align: center !important;
  margin: 5px !important;
  color: #111 !important;
  background: #fff !important;
  border: 1px solid #ddd !important;
  border-radius: 8px !important;
  cursor: pointer !important;
}
</style>

<style id="sa-badges-layer-fix">
/* Garder le positionnement d'origine et simplement surélever les pastilles */
.cal-heat   { z-index: 1; }
.cal-badges { z-index: 2; }  /* .cal-badges reste en position:absolute via le CSS principal */
.cal-flag   { z-index: 3; }
</style>

<script id="sa-cal-pastilles-defaults">
document.addEventListener('DOMContentLoaded', function () {
  // 1) Forcer les filtres ON au chargement (si présents)
  ['filtre-c','filtre-j','filtre-a'].forEach(id => {
    const el = document.getElementById(id);
    if (el && !el.checked) el.checked = true;
  });
  // 2) Recalculer le calendrier si la fonction existe
  if (typeof renderCalendrier === 'function') {
    try { renderCalendrier(); } catch (e) { /* no-op */ }
  }
});
</script>


</head>

<body>
  <div class="debug-console" id="debug-console"></div>

  <div class="container">
    <!-- ===== Header avec nom + logo + date/heure ===== -->
    <div class="header" id="header">
      <div class="brand">
        <img src="ressources/logo.png" alt="StopAddict" onerror="this.style.display='none'">
        <div class="brand-name">StopAddict <span class="brand-ver">v2.3.1</span></div>
      </div>
      <div class="date" id="date-actuelle">—</div>
      <div class="heure" id="heure-actuelle">—</div>
    </div>

    <!-- ===== Statistiques rapides (top bar) ===== -->
    <div class="stats-rapides">
      <div class="stat-item"><div class="stat-label">Aujourd'hui</div><div class="stat-valeur" id="total-jour">0</div></div>
      <div class="stat-item"><div class="stat-label">Hier</div><div class="stat-valeur" id="total-hier">0</div></div>
      <div class="stat-item"><div class="stat-label">Coût jour</div><div class="stat-valeur" id="cout-jour">0€</div></div>
      <div class="stat-item"><div class="stat-label">Statut</div><div class="stat-valeur" id="objectif-statut">—</div></div>
    </div>

    <!-- ======================= ACCUEIL ======================= -->
    <div class="ecran actif" id="ecran-principal">
      <div class="card bar-grey">
        <div class="row">
          <div class="title">🚬 Clopes</div>
          <div class="count" id="compteur-clopes-total">0</div>
        </div>
        <div class="segment" id="seg-clopes"></div>
        <div class="pm">
          <button class="btn-round btn-minus" id="btn-clopes-moins" type="button" aria-label="Clopes -1">-</button>
          <button class="btn-round btn-plus"  id="btn-clopes-plus"  type="button" aria-label="Clopes +1">+</button>
        </div>
      </div>

      <div class="card bar-green">
        <div class="row">
          <div class="title">🌿 Pétards</div>
          <div class="count" id="compteur-joints">0</div>
        </div>
        <div class="pm">
          <button class="btn-round btn-minus" id="btn-joints-moins" type="button" aria-label="Pétards -1">-</button>
          <button class="btn-round btn-plus green" id="btn-joints-plus" type="button" aria-label="Pétards +1">+</button>
        </div>
      </div>

      <div class="card">
        <div class="row">
          <div class="title">🍺 Alcool</div>
          <div class="count" id="compteur-alcool-total">0</div>
        </div>
        <div class="segment" id="seg-alcool"></div>
        <div class="pm">
          <button class="btn-round btn-minus" id="btn-alc-moins" type="button" aria-label="Alcool -1">-</button>
          <button class="btn-round btn-plus"  id="btn-alc-plus"  type="button" aria-label="Alcool +1">+</button>
        </div>
      </div>

      <!-- Bandeau conseils / limites -->
      <div class="banner orange" id="banner-accueil">
        <div class="hello" id="hello-accueil">—</div>
        <div class="chips" id="chips-accueil"></div>
        <div class="row-slim">
          <div class="label">Clopes</div>
          <div class="bar"><span id="bar-clopes"></span></div>
          <div id="note-clopes" class="note">—</div>
        </div>
        <div class="row-slim">
          <div class="label">Pétards</div>
          <div class="bar"><span id="bar-joints"></span></div>
          <div id="note-joints" class="note">—</div>
        </div>
        <div class="row-slim" id="row-alcool" style="display:none">
          <div class="label">Alcool</div>
          <div class="bar"><span id="bar-alcool"></span></div>
          <div id="note-alcool" class="note">—</div>
        </div>
        <div class="adv-ctl">
          <span class="dots" id="adv-dots">● ◯ ◯</span>
          <a class="ctl" href="#" id="adv-prev">⟲</a>
          <a class="ctl" href="#" id="adv-pause">⸇</a>
          <a class="ctl" href="#" id="lien-limites">Limites</a>
        </div>
      </div>
    </div>

<!-- ======================= STATS ======================= -->
<div class="ecran" id="ecran-stats">
  <div class="tabs" role="tablist" aria-label="Périodes statistiques">
  <button class="tab" data-vue="jour" type="button">Jour</button>
  <button class="tab" data-vue="semaine" type="button">Semaine</button>
  <button class="tab" data-vue="mois" type="button">Mois</button>
  <button class="tab" data-vue="annee" type="button">Année</button>
</div>

      <div class="banner green" id="banner-stats">
        <div class="hello" id="hello-stats">—</div>
        <div class="chips" id="chips-stats"></div>
        <div class="row-slim">
          <div class="label">Clopes</div>
          <div class="bar"><span id="bar-clopes-periode"></span></div>
          <div id="note-clopes-periode" class="note">—</div>
        </div>
        <div class="row-slim">
          <div class="label">Pétards</div>
          <div class="bar"><span id="bar-joints-periode"></span></div>
          <div id="note-joints-periode" class="note">—</div>
        </div>
        <div class="row-slim" id="row-alcool-periode" style="display:none">
          <div class="label">Alcool</div>
          <div class="bar"><span id="bar-alcool-periode"></span></div>
          <div id="note-alcool-periode" class="note">—</div>
        </div>
        <a class="ctl" href="#" id="lien-limites-2" style="align-self:flex-end">Limites</a>
      </div>

      <div class="card stats-block" id="stats-contenu"></div>
      <!-- === [NOUVEAU] Graphiques Stats (v2.4.0) === -->
<div class="card" id="stats-charts" aria-labelledby="stats-charts-title">
  <div class="row" style="justify-content:space-between; align-items:center">
    <div class="title" id="stats-charts-title">Graphiques</div>
    <!-- Légende dynamique peuplée en JS (Partie 4) -->
    <div class="chart-legend" id="chart-legend" aria-label="Légende des séries"></div>
  </div>

  <!-- Courbes de consommation (unités) : Clopes / Pétards / Alcool -->
  <figure class="chart-block" id="block-consommations">
    <figcaption class="chart-caption">Consommations</figcaption>
    <canvas id="chart-consommations" width="960" height="260" role="img"
            aria-label="Courbes des consommations par période sélectionnée"></canvas>
    <!-- État vide géré en JS -->
  </figure>

  <!-- Courbes de coût et économies (€) : Coût / Économies -->
  <figure class="chart-block" id="block-cout-eco">
    <figcaption class="chart-caption">Coût & Économies (€)</figcaption>
    <canvas id="chart-cout-eco" width="960" height="260" role="img"
            aria-label="Courbes du coût et des économies par période sélectionnée"></canvas>
    <!-- État vide géré en JS -->
  </figure>

  <!-- Zone d’actions optionnelles (export image, etc.) : alimentée en Partie 4 -->
  <div class="chart-actions" id="chart-actions"></div>
</div>
<!-- === [FIN] Graphiques Stats === -->
    </div>

<script>
// Re-render auto si la taille de #stats-charts change (évite les labels tronqués)
(function() {
  function safeRerender() {
    // relance le rendu des graphes et force l'ajustement des canvases
    if (typeof updateStatsBloc === 'function') updateStatsBloc();
    window.dispatchEvent(new Event('resize'));
  }

  function attachResizeObserver() {
    const sc = document.getElementById('stats-charts');
    if (!sc || sc._ro) return; // évite d'attacher plusieurs observateurs
    sc._ro = new ResizeObserver(safeRerender);
    sc._ro.observe(sc);
  }

  // Lance l'attache quand la page est prête
  if (document.readyState !== 'loading') attachResizeObserver();
  else document.addEventListener('DOMContentLoaded', attachResizeObserver);
})();
</script>
<script>
// Bouton "Exporter CSV (séries affichées)" dans #chart-actions
(function(){
  function getSeriesForCurrentView(){
    // 1) Si exposé par le module charts (idéal)
    if (window.StopAddictCharts?.buildSeriesForCurrentView) {
      try { return window.StopAddictCharts.buildSeriesForCurrentView(); } catch(e){}
    }
    // 2) Sinon, si buildSeries() est visible dans le scope global
    try { if (typeof buildSeries === 'function') return buildSeries(); } catch(e){}
    return null;
  }

  function exportStatsCSV(){
    const s = getSeriesForCurrentView();
    if (!s || !s.labels) { alert("Aucune série à exporter (vue vide)."); return; }

    // Construire des colonnes d'après ce qui est disponible
    const rows = [];
    const header = ["label"];
    const hasC = Array.isArray(s.consos?.clopes);
    const hasJ = Array.isArray(s.consos?.joints);
    const hasA = Array.isArray(s.consos?.alcool);
    const hasCo = Array.isArray(s.cout);
    const hasEc = Array.isArray(s.economies);

    if (hasC) header.push("Clopes");
    if (hasJ) header.push("Joints");
    if (hasA) header.push("Alcool");
    if (hasCo) header.push("Coût (€)");
    if (hasEc) header.push("Économies (€)");
    rows.push(header);

    for (let i=0; i<s.labels.length; i++){
      const line = [s.labels[i]];
      if (hasC) line.push(+((s.consos.clopes[i] ?? 0)).toFixed(2));
      if (hasJ) line.push(+((s.consos.joints[i] ?? 0)).toFixed(2));
      if (hasA) line.push(+((s.consos.alcool[i] ?? 0)).toFixed(2));
      if (hasCo) line.push(+((s.cout[i] ?? 0)).toFixed(2));
      if (hasEc) line.push(+((s.economies[i] ?? 0)).toFixed(2));
      rows.push(line);
    }

    // CSV ; + BOM (Excel FR)
    const csv = "\uFEFF" + rows.map(r => r.join(';')).join('\n');
    const vue = (window.vueStats || 'jour');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href = url;
    a.download = `stopaddict_stats_${vue}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function ensureButton(){
    const bar = document.getElementById('chart-actions');
    if (!bar) return;
    bar.hidden = false;
    if (!bar.querySelector('#btn-export-stats')){
      const b = document.createElement('button');
      b.id = 'btn-export-stats';
      b.type = 'button';
      b.className = 'btn';
      b.textContent = 'Exporter CSV (séries affichées)';
      b.addEventListener('click', exportStatsCSV);
      bar.appendChild(b);
    }
  }

  if (document.readyState !== 'loading') ensureButton();
  else document.addEventListener('DOMContentLoaded', ensureButton);
})();
</script>


    <!-- ======================= CALENDRIER ======================= -->
    <div class="ecran" id="ecran-calendrier">
      <div class="card">
        <div class="cal-controls">
          <button class="btn small" id="cal-prev" type="button">⟵</button>
          <div class="cal-month" id="cal-titre">—</div>
          <button class="btn small" id="cal-next" type="button">⟶</button>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px">
          <label class="tag"><input type="checkbox" id="filtre-c" checked> Clopes</label>
          <label class="tag"><input type="checkbox" id="filtre-j" checked> Pétards</label>
          <label class="tag"><input type="checkbox" id="filtre-a" checked> Alcool</label>
          <button class="btn small alt" id="cal-today" type="button">Aujourd'hui</button>
        </div>
        <div class="cal-grid" id="cal-entete"></div>
        <div class="cal-grid" id="cal-grille"></div>
      </div>
    </div>

    <!-- ======================= HABITUDES ======================= -->
    <div class="ecran" id="ecran-habitudes">
      <div class="card">
        <div class="section-title">🧭 Habitudes — Clopes & Pétards (min/max / jour)</div>
        <div class="grid-2">
          <div class="param"><label>Clopes classiques — Min</label><input type="number" id="hab-min-cl-class" value="0"></div>
          <div class="param"><label>Clopes classiques — Max</label><input type="number" id="hab-max-cl-class" value="0"></div>

          <div class="param"><label>Clopes roulées — Min</label><input type="number" id="hab-min-cl-roul" value="0"></div>
          <div class="param"><label>Clopes roulées — Max</label><input type="number" id="hab-max-cl-roul" value="0"></div>

          <div class="param"><label>Clopes à tubes — Min</label><input type="number" id="hab-min-cl-tube" value="0"></div>
          <div class="param"><label>Clopes à tubes — Max</label><input type="number" id="hab-max-cl-tube" value="0"></div>

          <div class="param"><label>Pétards — Min</label><input type="number" id="hab-min-joint" value="0"></div>
          <div class="param"><label>Pétards — Max</label><input type="number" id="hab-max-joint" value="0"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🧭 Habitudes — Alcool (min/max / jour)</div>
        <div class="grid-2">
          <div class="param"><label>Bière — Min</label><input type="number" id="hab-min-biere" value="0"></div>
          <div class="param"><label>Bière — Max</label><input type="number" id="hab-max-biere" value="0"></div>

          <div class="param"><label>Alcool fort — Min</label><input type="number" id="hab-min-fort" value="0"></div>
          <div class="param"><label>Alcool fort — Max</label><input type="number" id="hab-max-fort" value="0"></div>

          <div class="param"><label>Liqueur — Min</label><input type="number" id="hab-min-liqueur" value="0"></div>
          <div class="param"><label>Liqueur — Max</label><input type="number" id="hab-max-liqueur" value="0"></div>
          <div class="param"><span class="hint">Ces plages alimentent les conseils et les repères dans les Stats.</span></div>
        </div>
      </div>
    </div>

    <!-- ======================= RÉGLAGES ======================= -->
    <div class="ecran" id="ecran-params">
      <div class="card">
        <div class="section-title">👤 Personnalisation</div>
        <div class="grid-2">
          <div class="param">
            <label for="prenom-utilisateur">Votre prénom</label>
            <input id="prenom-utilisateur" type="text" placeholder="Ex : Nicolas">
          </div>
          <div class="param"><span class="hint">Affiché dans les conseils & stats.</span></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🚬 Cigarettes « classiques » (paquet)</div>
        <div class="grid-2">
          <div class="param"><label>J'en fume</label><input type="checkbox" id="enable-classiques"></div>
          <div class="param"><label>Prix du paquet (€)</label><input type="number" step="0.01" id="prix-paquet" value="11.00"></div>
          <div class="param"><label>Cigarettes / paquet</label><input type="number" id="cigs-par-paquet" value="20"></div>
          <div class="param"><span class="hint">Le coût unitaire = prix_paquet / cigs_par_paquet.</span></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🚬 Cigarettes « roulées »</div>
        <div class="grid-2">
          <div class="param"><label>J'en fume</label><input type="checkbox" id="enable-roulees"></div>
          <div class="param"><label>Tabac 30 g — prix (€)</label><input type="number" step="0.01" id="prix-tabac-roul" value="18.30"></div>
          <div class="param"><label>Clopes / 30 g (roulées)</label><input type="number" id="cigs-par-30g-roul" value="55"></div>

          <div class="param"><label>Petites feuilles — prix carnet (€)</label><input type="number" step="0.01" id="prix-feuille-petite" value="1.20"></div>
          <div class="param"><label>Feuilles / carnet (petites)</label><input type="number" id="feuilles-petite-par-carnet" value="100"></div>

          <div class="param"><label>Filtres — prix sachet (€)</label><input type="number" step="0.01" id="prix-filtre-ocb" value="1.50"></div>
          <div class="param"><label>Filtres / sachet</label><input type="number" id="filtres-par-sachet" value="150"></div>
          <div class="param"><label>Utiliser filtre</label><input type="checkbox" id="use-filtre-roulee" checked></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🚬 Cigarettes « à tubes »</div>
        <div class="grid-2">
          <div class="param"><label>J'en fume</label><input type="checkbox" id="enable-tubes"></div>
          <div class="param"><label>Tabac 30 g — clopes (tubées)</label><input type="number" id="cigs-par-30g-tube" value="50"></div>
          <div class="param"><label>Boîte de tubes — prix (€)</label><input type="number" step="0.01" id="prix-tubes" value="2.80"></div>
          <div class="param"><label>Tubes / boîte</label><input type="number" id="tubes-par-boite" value="100"></div>
          <div class="param"><span class="hint">Le tube inclut papier + filtre.</span></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🌿 Cannabis (pétards)</div>
        <div class="grid-2">
          <div class="param"><label>Prix du gramme (€)</label><input type="number" step="0.01" id="prix-gramme" value="5.60"></div>
          <div class="param"><label>Grammes / joint</label><input type="number" step="0.1" id="grammes-par-joint" value="0.8"></div>

          <div class="param"><label>Grandes feuilles — prix carnet (€)</label><input type="number" step="0.01" id="prix-feuille-grande" value="1.60"></div>
          <div class="param"><label>Feuilles / carnet (grandes)</label><input type="number" id="feuilles-grande-par-carnet" value="32"></div>

          <div class="param"><label>Utiliser filtre</label><input type="checkbox" id="use-filtre-joint"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🍻 Alcool — catégories & prix</div>
        <div class="grid-2">
          <div class="param"><label>Activer Bière</label><input type="checkbox" id="enable-biere"></div>
          <div class="param"><label>Bière — prix / unité (€)</label><input type="number" step="0.01" id="prix-biere" value="2.50"></div>
          <div class="param"><label>Unité bière (ex. 33 cl)</label><input type="text" id="unite-biere" value="33 cl"></div>

          <div class="param"><label>Activer Alcool fort</label><input type="checkbox" id="enable-fort"></div>
          <div class="param"><label>Alcool fort — prix / dose (€)</label><input type="number" step="0.01" id="prix-fort" value="3.00"></div>
          <div class="param"><label>Unité alcool fort (ex. 4 cl)</label><input type="text" id="unite-fort" value="4 cl"></div>

          <div class="param"><label>Activer Liqueur</label><input type="checkbox" id="enable-liqueur"></div>
          <div class="param"><label>Liqueur — prix / dose (€)</label><input type="number" step="0.01" id="prix-liqueur" value="2.80"></div>
          <div class="param"><label>Unité liqueur (ex. 6 cl)</label><input type="text" id="unite-liqueur" value="6 cl"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">🎯 Limites (0 = pas de limite)</div>
        <div class="grid-2">
          <div class="param"><label>Clopes / jour (global)</label><input type="number" id="limite-clopes" value="0"></div>
          <div class="param"><label>Pétards / jour</label><input type="number" id="limite-joints" value="0"></div>

          <div class="param"><label>Bière / jour</label><input type="number" id="limite-biere" value="0"></div>
          <div class="param"><label>Alcool fort / jour</label><input type="number" id="limite-fort" value="0"></div>
          <div class="param"><label>Liqueur / jour</label><input type="number" id="limite-liqueur" value="0"></div>
          <div class="param"><span class="hint">Le bandeau affiche des barres de progression pour les limites renseignées.</span></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">📅 Objectifs & dates (facultatif)</div>
        <div class="grid-2">
          <div class="param"><label>Clopes — Début de réduction</label><input type="date" id="date-reduc-clopes"></div>
          <div class="param"><label>Clopes — Objectif d'arrêt</label><input type="date" id="date-stop-clopes"></div>
          <div class="param"><label>Clopes — Plus censé fumer après</label><input type="date" id="date-no-clopes"></div>
          <div class="param"><label>Pétards — Début de réduction</label><input type="date" id="date-reduc-joints"></div>
          <div class="param"><label>Pétards — Objectif d'arrêt</label><input type="date" id="date-stop-joints"></div>
          <div class="param"><label>Pétards — Plus censé fumer après</label><input type="date" id="date-no-joints"></div>
          <div class="param"><label>Alcool — Début de réduction</label><input type="date" id="date-reduc-alcool"></div>
          <div class="param"><label>Alcool — Objectif d'arrêt</label><input type="date" id="date-stop-alcool"></div>
          <div class="param"><label>Alcool — Plus censé boire après</label><input type="date" id="date-no-alcool"></div>

          <div class="param"><span class="hint">Ces dates servent au Calendrier (rubans ⚙) et aux conseils (compte à rebours / suivi post-objectif). Tout est optionnel.</span></div>
        </div>
      </div>

      <!-- ===== À PROPOS (liens internes) ===== -->
      <div class="card">
        <div class="section-title">ℹ️ À propos</div>
        <div class="about-links">
          <button class="btn small" id="btn-open-warn" type="button">Voir l'avertissement</button>
          <button class="btn small" id="btn-open-manuel" type="button">Manuel d'utilisation</button>
          <button class="btn small" id="btn-open-cgv" type="button">Conditions générales de vente (CGV)</button>
          <button class="btn small" id="btn-open-mentions" type="button">Mentions légales</button>
          <a class="btn small alt" href="mailto:stopmauvaiseshabitudes@gmail.com">Contact support</a>
        </div>
      </div>

      <!-- ===== RAZ & sauvegarde ===== -->
      <div class="card">
        <div class="section-title">🧹 RAZ & sauvegarde</div>
        <div class="grid-2">
          <div class="param"><button class="btn small" id="btn-raz-jour" type="button">RAZ du jour</button></div>
          <div class="param"><button class="btn small alt" id="btn-raz-periode" type="button">RAZ de la période (Stats active)</button></div>
          <div class="param"><button class="btn small warn" id="btn-raz-histo" type="button">RAZ historique (conso)</button></div>
          <div class="param"><button class="btn small alt" id="btn-raz-reglages" type="button">RAZ réglages (usine)</button></div>

          <div class="param"><button class="btn small" id="btn-export-csv" type="button">Exporter CSV</button></div>
          <div class="param"><button class="btn small" id="btn-export-json" type="button">Sauvegarder JSON</button></div>
	  <div class="param"><button class="btn small warn" id="btn-purge-local" type="button">Purger les données locales (Stats)</button></div>
          <div class="param"><span class="hint">Une « Annuler » apparaît pendant 10 s après une RAZ (snapshot local).</span></div>
        </div>
      </div>

      <!-- ===== Journal & DEBUG ===== -->
      <div class="card">
        <div class="section-title">🛠️ Journal & DEBUG</div>
        <div class="grid-2">
          <div class="param"><label>Overlay DEBUG (afficher)</label><input type="checkbox" id="toggle-debug"></div>
          <div class="param"><button class="btn small" id="btn-copy-logs" type="button">Copier les logs</button></div>
          <div class="param"><button class="btn small alt" id="btn-clear-logs" type="button">Vider les logs</button></div>
          <div class="param"><span class="hint">Astuce : 5 tapes rapides sur la date (en haut) ouvrent/ferment l'overlay.</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= NAV ======================= -->
  <div class="nav">
    <button id="nav-principal" class="actif" type="button"><span class="ico">🏠</span>Accueil</button>
    <button id="nav-stats" type="button"><span class="ico">📊</span>Stats</button>
    <button id="nav-calendrier" type="button"><span class="ico">🗓️</span>Calendrier</button>
    <button id="nav-habitudes" type="button"><span class="ico">🧭</span>Habitudes</button>
    <button id="nav-params" type="button"><span class="ico">⚙️</span>Réglages</button>
  </div>

  <!-- ======================= MODALE JOUR (Calendrier) ======================= -->
  <div class="modal" id="cal-modal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="cal-jour-titre">
      <h3 id="cal-jour-titre">—</h3>
      <div class="mini" id="cal-jour-resume">—</div>
      <div class="divider" style="margin:10px 0"></div>

      <div class="line"><span class="lbl">Clopes</span> <span id="cal-jour-c"></span></div>
      <div class="segment" id="cal-jour-seg-c"></div>
      <div class="pm" aria-label="Actions clopes (jour)">
        <button class="btn-round btn-minus" id="cal-c-moins" type="button">−1</button>
        <button class="btn-round btn-plus"  id="cal-c-plus"  type="button">+1</button>
      </div>

      <div class="divider" style="margin:10px 0"></div>

      <div class="line"><span class="lbl">Pétards</span> <span id="cal-jour-j"></span></div>
      <div class="pm" aria-label="Actions pétards (jour)">
        <button class="btn-round btn-minus" id="cal-j-moins" type="button">−1</button>
        <button class="btn-round btn-plus green" id="cal-j-plus" type="button">+1</button>
      </div>

      <div class="divider" style="margin:10px 0"></div>

      <div class="line"><span class="lbl">Alcool</span> <span id="cal-jour-a"></span></div>
      <div class="segment" id="cal-jour-seg-a"></div>
      <div class="pm" aria-label="Actions alcool (jour)">
        <button class="btn-round btn-minus" id="cal-a-moins" type="button">−1</button>
        <button class="btn-round btn-plus"  id="cal-a-plus"  type="button">+1</button>
      </div>

      <div style="display:flex; justify-content:space-between; margin-top:12px">
        <button class="btn alt" id="cal-jour-raz" type="button">RAZ du jour</button>
        <button class="btn" id="cal-jour-fermer" type="button">Fermer</button>
      </div>
    </div>
  </div>

  <!-- Snackbar -->
  <div class="snackbar" id="snackbar">Action enregistrée — <a href="#" id="undo-link">Annuler</a></div>

  <!-- ======================= MODALE AVERTISSEMENT (1ère ouverture) ======================= -->
  <div class="modal" id="modal-warn" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="warn-title">
      <h3 class="warn-title" id="warn-title">Avertissement — Public majeur (18+)</h3>
      <div class="warn-box">
        <p><strong>StopAddict</strong> est une application d'auto-suivi et d'aide à la réduction/arrêt des consommations (tabac, alcool, cannabis).</p>
        <ul class="warn-list">
          <li>Réservée aux personnes de 18 ans et plus.</li>
          <li>Ne fait pas la promotion de ces produits.</li>
          <li>Ne remplace pas un accompagnement médical, psychologique ou social. En cas de difficulté, consultez un professionnel.</li>
          <li>Utilisez StopAddict de façon responsable.</li>
        </ul>
        <p class="warn-note">Besoin d'aide ? <a href="#" id="open-ressources-from-warn">Ressources et numéros utiles</a></p>
        <div style="margin-top:8px">
          <label><input type="checkbox" id="chk-warn-18"> J'ai 18 ans ou plus</label><br>
          <label><input type="checkbox" id="chk-warn-hide"> Ne plus réafficher ce message</label>
        </div>
        <div class="warn-actions">
          <button class="btn warn" id="btn-warn-quit" type="button">Quitter</button>
          <div class="right">
            <button class="btn alt" id="btn-warn-cancel" type="button">Annuler</button>
            <button class="btn" id="btn-warn-accept" type="button" disabled>J'accepte et continuer</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= MODALE PAGES (Manuel / CGV / Mentions / Avertissement) ======================= -->
  <div class="modal" id="modal-page" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="page-title">
      <h3 class="pages-title" id="page-title">—</h3>
      <div class="page-content" id="page-content">
        <!-- Contenu injecté par le script (manuel, cgv, mentions, avertissement complet) -->
      </div>
      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:12px">
        <button class="btn alt" id="btn-page-close" type="button">Fermer</button>
      </div>
    </div>
  </div>

<script>
/* ===================== DEBUG ===================== */
let debugMessages = [];
function debugLog(msg, type='INFO'){
  const ts = new Date().toLocaleTimeString();
  const line = '['+ts+'] '+type+': '+msg;
  debugMessages.push(line); 
  if (debugMessages.length > 200) debugMessages.shift();
  try{ console.log(line); }catch(e){}
  const el = document.getElementById('debug-console');
  if (el && el.classList.contains('show')){ 
    el.innerHTML = debugMessages.map(x=>x.replace(/</g,'&lt;')).join('<br>'); 
    el.scrollTop = el.scrollHeight; 
  }
}

/* ===================== STORAGE & STATE ===================== */
const K_DONNEES='app_donnees_v23';
const K_PARAMS ='app_parametres_v23';
const K_PRENOM ='app_prenom_v23';
const K_HAB    ='app_habitudes_v23';
const K_VUE    ='app_vue_stats_v23';
const K_SNAP   ='app_snapshot_v23';
const K_DATES  ='app_dates_v23';
const K_DEBUG  ='app_debug_overlay_v23';
const K_WARN   ='app_warn_v23'; // avertissement 18+

let prenomUtilisateur = '';
let vueStats = 'jour';
let derniereAction = null; // {group, subtype, delta, date}
let snapshot = null;

let donnees = {}; // date -> { cl_class, cl_roul, cl_tube, joints, alc_biere, alc_fort, alc_liqueur, timestamps:[] }

let params = {
  enable_classiques:false, prix_paquet:11.00, cigs_par_paquet:20,
  enable_roulees:false, prix_tabac_roul:18.30, cigs_par_30g_roul:55, prix_feuille_petite:1.20, feuilles_petite_par_carnet:100,
  prix_filtre_ocb:1.50, filtres_par_sachet:150, use_filtre_roulee:true,
  enable_tubes:false, cigs_par_30g_tube:50, prix_tubes:2.80, tubes_par_boite:100,
  prix_gramme:5.60, grammes_par_joint:0.8, prix_feuille_grande:1.60, feuilles_grande_par_carnet:32, use_filtre_joint:false,
  enable_biere:false, prix_biere:2.50, unite_biere:'33 cl',
  enable_fort:false,  prix_fort:3.00,  unite_fort:'4 cl',
  enable_liqueur:false, prix_liqueur:2.80, unite_liqueur:'6 cl',
  limite_clopes:0, limite_joints:0, limite_biere:0, limite_fort:0, limite_liqueur:0
};

let habitudes = {
  min_cl_class:0, max_cl_class:0,
  min_cl_roul:0,  max_cl_roul:0,
  min_cl_tube:0,  max_cl_tube:0,
  min_joint:0,    max_joint:0,
  min_biere:0,    max_biere:0,
  min_fort:0,     max_fort:0,
  min_liqueur:0,  max_liqueur:0
};

let datesObj = {
  reduc_clopes:null, stop_clopes:null, no_clopes:null,
  reduc_joints:null, stop_joints:null, no_joints:null,
  reduc_alcool:null, stop_alcool:null, no_alcool:null
};

function dateKey(d=new Date()){
  return (typeof keyLocal === 'function')
    ? keyLocal(d)
    : [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-');
}


function keyStrictLocal(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}



function ydayKey(offset){ const d=new Date(); d.setDate(d.getDate()+offset); return dateKey(d); }

function firstDayOfMonth(year, month){ return new Date(year, month, 1); }
function lastDayOfMonth(year, month){ return new Date(year, month+1, 0); }
function startOfWeek(d){ const t=new Date(d); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day); t.setHours(0,0,0,0); return t; }
function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
function startOfYear(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
function endOfYear(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

function getJour(key){
  if (!donnees[key]) donnees[key] = {cl_class:0, cl_roul:0, cl_tube:0, joints:0, alc_biere:0, alc_fort:0, alc_liqueur:0, timestamps:[]};
  return donnees[key];
}

function compatLoad(){
  try{
    const d = localStorage.getItem(K_DONNEES); if (d) donnees = JSON.parse(d);
    const p = localStorage.getItem(K_PARAMS);  if (p) Object.assign(params, JSON.parse(p));
    const n = localStorage.getItem(K_PRENOM);  if (n) prenomUtilisateur = n;
    const h = localStorage.getItem(K_HAB);     if (h) Object.assign(habitudes, JSON.parse(h));
    const v = localStorage.getItem(K_VUE);     if (v) vueStats = v;
    const dt= localStorage.getItem(K_DATES);   if (dt) Object.assign(datesObj, JSON.parse(dt));
    const dbg=localStorage.getItem(K_DEBUG);   if (dbg==='1') document.getElementById('debug-console').classList.add('show');
    debugLog('Données chargées v2.3.1');
  }catch(e){ debugLog('Erreur chargement: '+e.message,'ERROR'); }
}

function persist(){
  try{
     window.donnees = donnees;
    localStorage.setItem(K_DONNEES, JSON.stringify(donnees));
    localStorage.setItem(K_PARAMS, JSON.stringify(params));
    localStorage.setItem(K_PRENOM, prenomUtilisateur);
    localStorage.setItem(K_HAB, JSON.stringify(habitudes));
    localStorage.setItem(K_VUE, vueStats);
    localStorage.setItem(K_DATES, JSON.stringify(datesObj));
    localStorage.setItem(K_DEBUG, document.getElementById('debug-console').classList.contains('show') ? '1':'0');
  }catch(e){ debugLog('Erreur sauvegarde: '+e.message,'ERROR'); }
}

/* ===================== COÛTS - FONCTION CENTRALISÉE ===================== */
function calculerCoutJour(jour) {
  if (!jour) return 0;
  
  const coutClassique = (params.prix_paquet||0)/Math.max(1,(params.cigs_par_paquet||20));
  
  const coutRoulee = (() => {
    const base=(params.prix_tabac_roul||0)/Math.max(1,(params.cigs_par_30g_roul||1));
    const feuille=(params.prix_feuille_petite||0)/Math.max(1,(params.feuilles_petite_par_carnet||1));
    const filtre=params.use_filtre_roulee ? (params.prix_filtre_ocb||0)/Math.max(1,(params.filtres_par_sachet||1)) : 0;
    return base+feuille+filtre;
  })();
  
  const coutTube = (() => {
    const base=(params.prix_tabac_roul||0)/Math.max(1,(params.cigs_par_30g_tube||1));
    const tube=(params.prix_tubes||0)/Math.max(1,(params.tubes_par_boite||1));
    return base+tube;
  })();
  
  const coutJoint = (() => {
    const base=(params.prix_gramme||0)*(params.grammes_par_joint||0);
    const feuille=(params.prix_feuille_grande||0)/Math.max(1,(params.feuilles_grande_par_carnet||1));
    const filtre=params.use_filtre_joint ? (params.prix_filtre_ocb||0)/Math.max(1,(params.filtres_par_sachet||1)) : 0;
    return base+feuille+filtre;
  })();
  
  const coutBiere = (params.prix_biere||0);
  const coutFort = (params.prix_fort||0);
  const coutLiqueur = (params.prix_liqueur||0);

  return (jour.cl_class * coutClassique) + 
         (jour.cl_roul * coutRoulee) + 
         (jour.cl_tube * coutTube) + 
         (jour.joints * coutJoint) + 
         (jour.alc_biere * coutBiere) + 
         (jour.alc_fort * coutFort) + 
         (jour.alc_liqueur * coutLiqueur);
}

/* ===================== UI HELPERS ===================== */
function byId(id){ return document.getElementById(id); }
function setText(id, txt){ const el=byId(id); if (el) el.textContent=txt; }
function setHTML(id, html){ const el=byId(id); if (el) el.innerHTML=html; }
function setBarWidth(id, p){ const el=byId(id); if (el) el.style.width=(p==null?'0%':p+'%'); }
function pct(v, lim){ if (!lim || lim<=0) return null; return Math.max(0, Math.min(100, Math.round((v/lim)*100))); }

/* ===================== HEADER ===================== */
function updateHeader(){
  const now=new Date();
  setText('date-actuelle', now.toLocaleDateString('fr-FR',{weekday:'long', day:'numeric', month:'long'}));
  setText('heure-actuelle', now.toLocaleTimeString('fr-FR',{hour:'2-digit', minute:'2-digit'}));
}

function statutEmoji(){
  const d=getJour(dateKey());
  const ratios=[];
  if (params.limite_clopes>0){ const tot=d.cl_class+d.cl_roul+d.cl_tube; ratios.push(tot/params.limite_clopes); }
  if (params.limite_joints>0){ ratios.push(d.joints/params.limite_joints); }
  const alcLim = (params.limite_biere||0)+(params.limite_fort||0)+(params.limite_liqueur||0);
  if (alcLim>0){ const aval=d.alc_biere+d.alc_fort+d.alc_liqueur; ratios.push(aval/alcLim); }
  if (!ratios.length) return '✅';
  const r=Math.max(...ratios);
  if (r<0.7) return '🟢'; if (r<=1) return '🟡'; return '🔴';
}

function updateTopStats(){
  const auj=getJour(dateKey()), hier=getJour(ydayKey(-1));
  setText('compteur-clopes-total', (auj.cl_class+auj.cl_roul+auj.cl_tube));
  setText('compteur-joints', auj.joints);
  setText('compteur-alcool-total', (auj.alc_biere+auj.alc_fort+auj.alc_liqueur));
  setText('total-jour', (auj.cl_class+auj.cl_roul+auj.cl_tube)+auj.joints+(auj.alc_biere+auj.alc_fort+auj.alc_liqueur));
  setText('total-hier', (hier.cl_class+hier.cl_roul+hier.cl_tube)+hier.joints+(hier.alc_biere+hier.alc_fort+hier.alc_liqueur));
  
  const coutJour = calculerCoutJour(auj).toFixed(2).replace('.',',')+'€';
  setText('cout-jour', coutJour);
  setText('objectif-statut', statutEmoji());
}

/* ===================== SEGMENTS ===================== */
let segClopesSel='class';
let segAlcoolSel='biere';

function renderSegments(){
  const arrC=[];
  if (params.enable_classiques) arrC.push(['class','Classiques']);
  if (params.enable_roulees)    arrC.push(['roul','Roulées']);
  if (params.enable_tubes)      arrC.push(['tube','Tubes']);
  
  const sc=byId('seg-clopes');
  if (sc){ 
    sc.innerHTML='';
    if (arrC.length>1){
      arrC.forEach(([k,lab])=>{
        const b=document.createElement('button'); 
        b.className='seg'+(segClopesSel===k?' actif':''); 
        b.textContent=lab;
        b.addEventListener('click', ()=>{ segClopesSel=k; renderSegments(); });
        sc.appendChild(b);
      });
    } else if (arrC.length===1){ 
      segClopesSel=arrC[0][0]; 
    } else { 
      sc.innerHTML='<div class="chip" style="color:#1f2937;background:#fff;border:1px solid #e5e7eb">Activez un type dans Réglages</div>'; 
      segClopesSel='class'; // valeur par défaut sécurisée
    }
  }

  const arrA=[];
  if (params.enable_biere)   arrA.push(['biere','Bière']);
  if (params.enable_fort)    arrA.push(['fort','Alcool fort']);
  if (params.enable_liqueur) arrA.push(['liqueur','Liqueur']);
  
  const sa=byId('seg-alcool');
  if (sa){ 
    sa.innerHTML='';
    if (arrA.length>1){
      arrA.forEach(([k,lab])=>{
        const b=document.createElement('button'); 
        b.className='seg'+(segAlcoolSel===k?' actif':''); 
        b.textContent=lab;
        b.addEventListener('click', ()=>{ segAlcoolSel=k; renderSegments(); });
        sa.appendChild(b);
      });
    } else if (arrA.length===1){ 
      segAlcoolSel=arrA[0][0]; 
    } else { 
      sa.innerHTML='<div class="chip" style="color:#1f2937;background:#fff;border:1px solid #e5e7eb">Activez bière/fort/liqueur</div>'; 
      segAlcoolSel='biere'; // valeur par défaut sécurisée
    }
  }
}

/* ===================== CONSEILS ===================== */
let advQueue=[]; let advIndex=0; let advTimer=null; let advPaused=false;

function conseilCourt(p){ 
  if (p===null) return 'Aucune limite'; 
  if (p<70) return 'OK'; 
  if (p<=100) return 'Tu y es presque'; 
  return 'Au-delà '; 
}

function avgLastDays(keys, field){
  const vals=[]; 
  keys.forEach(k=>{ 
    if (donnees[k] && typeof donnees[k][field]==='number') vals.push(donnees[k][field]); 
  });
  if (!vals.length) return null;
  const sum=vals.reduce((a,b)=>a+b,0); 
  return sum/vals.length;
}

function periodKeys(nDays){
  const arr=[]; 
  const d=new Date();
  for(let i=1;i<=nDays;i++){ 
    const t=new Date(d); 
    t.setDate(t.getDate()-i); 
    arr.push(dateKey(t));
  }
  return arr;
}

// CORRECTION : Calcul de différence de jours plus précis
function daysDiff(to){ 
  const now = new Date();
  const target = new Date(to + 'T12:00:00'); // midi pour éviter les problèmes de fuseau
  now.setHours(12, 0, 0, 0); // midi aussi
  return Math.ceil((target - now) / 86400000); 
}

function buildAdviceQueue(ctx='accueil'){
  const d=getJour(dateKey());
  const tips=[];
  const nom = prenomUtilisateur ? (prenomUtilisateur+', ') : '';

  const totC=d.cl_class+d.cl_roul+d.cl_tube;
  if (params.limite_clopes>0){
    const p=pct(totC, params.limite_clopes);
    if (p>100) tips.push(`${nom}tu as dépassé ta limite clopes. Petite pause ? ✋`);
    else if (p>=70) tips.push(`${nom}clopes : ${p}% de ta limite — tu y es presque.`);
  }
  if (params.limite_joints>0){
    const p=pct(d.joints, params.limite_joints);
    if (p>100) tips.push(`Pétards : au-delà aujourdhui. Hydrate-toi 💧`);
    else if (p>=70) tips.push(`Pétards : ${p}% de la limite.`);
  }
  const limAlc=params.limite_biere+params.limite_fort+params.limite_liqueur;
  const totA=d.alc_biere+d.alc_fort+d.alc_liqueur;
  if (limAlc>0){
    const p=pct(totA, limAlc);
    if (p>100) tips.push(`Alcool : dépassement. Fais une pause & bois de leau 💧`);
    else if (p>=70) tips.push(`Alcool : ${p}% de la limite globale.`);
  }

  function habAlert(val, min, max, label){
    if (max>0 && val>max) tips.push(`${label} au-dessus de ton max habituel (${max}).`);
    else if (min>0 && val<min) tips.push(`${label} sous ton min habituel (${min}) — good 👍`);
  }
  habAlert(totC, habitudes.min_cl_class+habitudes.min_cl_roul+habitudes.min_cl_tube, habitudes.max_cl_class+habitudes.max_cl_roul+habitudes.max_cl_tube, 'Clopes');
  habAlert(d.joints, habitudes.min_joint, habitudes.max_joint, 'Pétards');
  habAlert(totA, habitudes.min_biere+habitudes.min_fort+habitudes.min_liqueur, habitudes.max_biere+habitudes.max_fort+habitudes.max_liqueur, 'Alcool');

  function addDateTips(kind, reduc, stop, no, todayVal){
    if (stop){ const dd=daysDiff(stop); if (dd>0) tips.push(`${kind} : J-${dd} avant ton objectif darrêt 💪`); }
    if (no){ const past = new Date(dateKey()) > new Date(no); if (past && todayVal>0) tips.push(`${kind} : après ta date darrêt — day by day, tu vas y arriver.`); }
    if (reduc){ tips.push(`${kind} : réduction engagée depuis le ${new Date(reduc).toLocaleDateString('fr-FR')}.`); }
  }
  addDateTips('Clopes', datesObj.reduc_clopes, datesObj.stop_clopes, datesObj.no_clopes, totC);
  addDateTips('Pétards', datesObj.reduc_joints, datesObj.stop_joints, datesObj.no_joints, d.joints);
  addDateTips('Alcool', datesObj.reduc_alcool, datesObj.stop_alcool, datesObj.no_alcool, totA);

  const keys14=periodKeys(14);
  const baseC = (avgLastDays(keys14, 'cl_class') ?? 0) + (avgLastDays(keys14, 'cl_roul') ?? 0) + (avgLastDays(keys14,'cl_tube') ?? 0);
  const baseJ = (avgLastDays(keys14, 'joints') ?? 0);
  const baseA = (avgLastDays(keys14, 'alc_biere') ?? 0) + (avgLastDays(keys14,'alc_fort') ?? 0) + (avgLastDays(keys14,'alc_liqueur') ?? 0);

  if (!tips.length){
    if (isFinite(baseC) && baseC>0){
      const delta=(totC - baseC)/baseC;
      if (delta<=-0.2) tips.push(`Clopes en baisse vs. 14 j — continue 👍`);
      else if (delta>=0.2) tips.push(`Clopes en hausse vs. 14 j — mini-pause ?`);
    }
    if (isFinite(baseJ) && baseJ>0){
      const delta=(d.joints - baseJ)/baseJ;
      if (delta<=-0.2) tips.push(`Pétards en baisse — bien joué 👍`);
      else if (delta>=0.2) tips.push(`Pétards en hausse — hydrate-toi 💧`);
    }
    if (isFinite(baseA) && baseA>0){
      const delta=(totA - baseA)/baseA;
      if (delta<=-0.2) tips.push(`Alcool en baisse — top 👍`);
      else if (delta>=0.2) tips.push(`Alcool en hausse — vas-y mollo.`);
    }
  }

  const cout = calculerCoutJour(d).toFixed(2);
  tips.push(`Coût estimé du jour : ${cout} €`);
  tips.push(`Prends 10 respirations profondes — ça aide 🫁`);
  tips.push(`Un verre deau maintenant ? 💧`);

  const uniq=[]; const seen=new Set();
  tips.forEach(t=>{ if(!seen.has(t)){ uniq.push(t); seen.add(t);} });
  advQueue = uniq.slice(0,6); advIndex=0;
  updateAdvDots(); setAdviceText();
}

function setAdviceText(){
  const elHello=byId('hello-accueil');
  const nom = prenomUtilisateur ? (prenomUtilisateur+', ') : '';
  if (!advQueue.length){ elHello.textContent = nom+'voici ton suivi du jour'; return; }
  elHello.textContent = advQueue[advIndex];
}

function nextAdvice(){ if (!advPaused){ advIndex=(advIndex+1)%Math.max(1,advQueue.length); setAdviceText(); updateAdvDots(); } }
function prevAdvice(){ if (!advPaused){ advIndex=(advIndex-1+advQueue.length)%Math.max(1,advQueue.length); setAdviceText(); updateAdvDots(); } }

function updateAdvDots(){
  const dots=byId('adv-dots');
  const n=Math.max(1, advQueue.length);
  let s=''; for(let i=0;i<n;i++) s += (i===advIndex?'● ':'◯ ');
  dots.textContent=s.trim();
}

function startAdviceRotation(){
  if (advTimer) clearInterval(advTimer);
  advTimer=setInterval(nextAdvice, 30000); // 30s
}

function pauseAdviceRotation(p){
  advPaused=p; 
  byId('adv-pause').textContent = p?'▶️':'⸇';
}

/* ===================== BANNERS & STATS ===================== */
function updateBannerAccueil(){
  const d=getJour(dateKey());
  const chips=[];
  const totC=d.cl_class+d.cl_roul+d.cl_tube;
  chips.push(`<span class="chip">Clopes : ${totC} (C ${d.cl_class} • R ${d.cl_roul} • T ${d.cl_tube})</span>`);
  chips.push(`<span class="chip">Pétards : ${d.joints}</span>`);
  const alcTot=d.alc_biere+d.alc_fort+d.alc_liqueur;
  chips.push(`<span class="chip">Alcool : ${alcTot} (B ${d.alc_biere} • F ${d.alc_fort} • L ${d.alc_liqueur})</span>`);
  const cout = calculerCoutJour(d).toFixed(2).replace('.',',');
  chips.push(`<span class="chip cost">${cout} €</span>`);
  setHTML('chips-accueil', chips.join(' '));

  const pC=pct(totC, params.limite_clopes);
  const pJ=pct(d.joints, params.limite_joints);
  setBarWidth('bar-clopes', pC); setText('note-clopes', conseilCourt(pC));
  setBarWidth('bar-joints', pJ); setText('note-joints', conseilCourt(pJ));

  const alcLim=params.limite_biere+params.limite_fort+params.limite_liqueur;
  const rowAlc=byId('row-alcool');
  if (alcLim>0){
    rowAlc.style.display='';
    const pA=pct(alcTot, alcLim);
    setBarWidth('bar-alcool', pA); setText('note-alcool', conseilCourt(pA));
  }else{
    rowAlc.style.display='none';
  }
  buildAdviceQueue('accueil');
}

function updateBannerStats(){
  const now = new Date();
  let d1,d2,label;
  if (vueStats==='jour'){ 
    d1=new Date(now); d1.setHours(0,0,0,0); 
    d2=new Date(now); d2.setHours(23,59,59,999); 
    label="Aujourdhui"; 
  }
  else if (vueStats==='semaine'){ d1=startOfWeek(now); d2=endOfWeek(now); label="Cette semaine"; }
  else if (vueStats==='mois'){ d1=startOfMonth(now); d2=endOfMonth(now); label="Ce mois-ci"; }
  else { d1=startOfYear(now); d2=endOfYear(now); label="Cette année"; }

  // CORRECTION : Calcul de jours plus précis
  const joursExacts = Math.ceil((d2.getTime() - d1.getTime()) / 86400000) + 1;
  const jours = Math.max(1, joursExacts);
  
  let clClass=0, clRoul=0, clTube=0, jo=0, b=0, f=0, l=0;
  Object.keys(donnees).forEach(k=>{
    const dt=new Date(k+'T00:00:00'); 
    if (dt<d1 || dt>d2) return;
    const x=donnees[k]; 
    clClass+=x.cl_class||0; clRoul+=x.cl_roul||0; clTube+=x.cl_tube||0; 
    jo+=x.joints||0; b+=x.alc_biere||0; f+=x.alc_fort||0; l+=x.alc_liqueur||0;
  });
  
  const totC=clClass+clRoul+clTube, totA=b+f+l;
  const chips=[];
  chips.push(`<span class="chip">Total : ${totC+jo+totA}</span>`);
  chips.push(`<span class="chip">Clopes : ${totC} (C ${clClass} • R ${clRoul} • T ${clTube})</span>`);
  chips.push(`<span class="chip">Pétards : ${jo}</span>`);
  chips.push(`<span class="chip">Alcool : ${totA} (B ${b} • F ${f} • L ${l})</span>`);
  
  const coutTotal = (clClass*calculerCoutJour({cl_class:1,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0})) + 
                   (clRoul*calculerCoutJour({cl_class:0,cl_roul:1,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0})) +
                   (clTube*calculerCoutJour({cl_class:0,cl_roul:0,cl_tube:1,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0})) +
                   (jo*calculerCoutJour({cl_class:0,cl_roul:0,cl_tube:0,joints:1,alc_biere:0,alc_fort:0,alc_liqueur:0})) +
                   (b*calculerCoutJour({cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:1,alc_fort:0,alc_liqueur:0})) +
                   (f*calculerCoutJour({cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:1,alc_liqueur:0})) +
                   (l*calculerCoutJour({cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:1}));
  
  const cout = coutTotal.toFixed(2).replace('.',',');
  setHTML('chips-stats', chips.join(' ') + ` <span class="chip cost">${cout} €</span>`);

  const limC = params.limite_clopes>0 ? params.limite_clopes*jours : null;
  const limJ = params.limite_joints>0 ? params.limite_joints*jours : null;
  const limA = (params.limite_biere+params.limite_fort+params.limite_liqueur)>0 ? (params.limite_biere+params.limite_fort+params.limite_liqueur)*jours : null;

  const pC = limC? Math.max(0, Math.min(100, Math.round((totC/limC)*100))) : null;
  const pJ = limJ? Math.max(0, Math.min(100, Math.round((jo/limJ)*100))) : null;
  const pA = limA? Math.max(0, Math.min(100, Math.round((totA/limA)*100))) : null;

  setBarWidth('bar-clopes-periode', pC); setText('note-clopes-periode', conseilCourt(pC));
  setBarWidth('bar-joints-periode', pJ); setText('note-joints-periode', conseilCourt(pJ));
  const row=byId('row-alcool-periode');
  if (limA!=null){ row.style.display=''; setBarWidth('bar-alcool-periode', pA); setText('note-alcool-periode', conseilCourt(pA)); }
  else { row.style.display='none'; }
  setText('hello-stats', (prenomUtilisateur?prenomUtilisateur+', ':'')+label);
}

function updateStatsBloc(){

  const now = new Date();
  let d1,d2,titre;
  if (vueStats==='jour'){ d1=new Date(now); d1.setHours(0,0,0,0); d2=new Date(now); d2.setHours(23,59,59,999); titre="Aujourdhui"; }
  else if (vueStats==='semaine'){ d1=startOfWeek(now); d2=endOfWeek(now); titre="Cette semaine"; }
  else if (vueStats==='mois'){ d1=startOfMonth(now); d2=endOfMonth(now); titre="Ce mois-ci"; }
  else { d1=startOfYear(now); d2=endOfYear(now); titre="Cette année"; }

  let clClass=0, clRoul=0, clTube=0, jo=0, b=0, f=0, l=0;
let totalCouts = 0;
const __ks = (typeof keysBetweenLocal==='function') ? keysBetweenLocal(d1,d2) : Object.keys(donnees||{});
for (const k of __ks){
  const x = (donnees||{})[k] || {};
  clClass += x.cl_class||0; clRoul += x.cl_roul||0; clTube += x.cl_tube||0;
  jo += x.joints||0; b += x.alc_biere||0; f += x.alc_fort||0; l += x.alc_liqueur||0;
  try { totalCouts += (typeof calculerCoutJour==='function' ? +calculerCoutJour(x) : 0); } catch(_){}
}
const totC=clClass+clRoul+clTube, totA=b+f+l;
  const cout = totalCouts.toFixed(2);

  const html = `
    <div style="text-align:center; font-weight:900; margin-bottom:6px">${titre}</div>
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:center">
      <div><div style="font-size:12px; color:#6b7280">Clopes (total)</div><div style="font-weight:900; font-size:18px">${totC}</div></div>
      <div><div style="font-size:12px; color:#6b7280">Pétards</div><div style="font-weight:900; font-size:18px">${jo}</div></div>

      <div><div style="font-size:12px; color:#6b7280">Classiques</div><div style="font-weight:900; font-size:18px">${clClass}</div></div>
      <div><div style="font-size:12px; color:#6b7280">Roulées</div><div style="font-weight:900; font-size:18px">${clRoul}</div></div>
      <div><div style="font-size:12px; color:#6b7280">Tubes</div><div style="font-weight:900; font-size:18px">${clTube}</div></div>

      <div style="grid-column:1 / -1"><div style="font-size:12px; color:#6b7280">Alcool (total)</div><div style="font-weight:900; font-size:18px">${totA} — B ${b} • F ${f} • L ${l}</div></div>

      <div style="grid-column:1 / -1"><div style="font-size:12px; color:#6b7280">Coût estimé</div><div style="font-weight:900; font-size:18px">${cout}€</div></div>
    </div>`;
  setHTML('stats-contenu', html);
}

/* ===================== ACTIONS & SNACKBAR ===================== */
const snackbar=document.getElementById('snackbar');
const undoLink=document.getElementById('undo-link');
let snackTimer=null;

function showSnackbar(msg="Action enregistrée"){
  snackbar.firstChild.textContent = msg+' — ';
  snackbar.classList.add('show');
  clearTimeout(snackTimer);
  snackTimer=setTimeout(()=> snackbar.classList.remove('show'), 3500);
}

// Sécurisation du système d'annulation
if (undoLink) {
  undoLink.addEventListener('click', (e)=>{
    e.preventDefault();
    if (!derniereAction) return;
    const a=derniereAction; 
    const d=getJour(a.date);
    if (a.group==='clopes'){
      if (a.subtype==='class') d.cl_class = Math.max(0, d.cl_class - a.delta);
      if (a.subtype==='roul')  d.cl_roul  = Math.max(0, d.cl_roul  - a.delta);
      if (a.subtype==='tube')  d.cl_tube  = Math.max(0, d.cl_tube  - a.delta);
    }else if (a.group==='joints'){
      d.joints = Math.max(0, d.joints - a.delta);
    }else if (a.group==='alcool'){
      if (a.subtype==='biere')   d.alc_biere   = Math.max(0, d.alc_biere   - a.delta);
      if (a.subtype==='fort')    d.alc_fort    = Math.max(0, d.alc_fort    - a.delta);
      if (a.subtype==='liqueur') d.alc_liqueur = Math.max(0, d.alc_liqueur - a.delta);
    }else if (a.group==='snapshot'){
      try{ donnees = JSON.parse(localStorage.getItem(K_SNAP)||'{}'); }catch(e){}
    }
    derniereAction=null;
    persist(); updateAllUI();
    snackbar.classList.remove('show');
  });
}

function enregistrerAction(group, subtype, delta){
  const key=dateKey(); 
  const d=getJour(key);
  
  // Validation des segments avant action
  if (group==='clopes' && !['class','roul','tube'].includes(subtype)) {
    debugLog(`Segment clopes invalide: ${subtype}, utilisation de class par défaut`, 'WARN');
    subtype = 'class';
  }
  if (group==='alcool' && !['biere','fort','liqueur'].includes(subtype)) {
    debugLog(`Segment alcool invalide: ${subtype}, utilisation de biere par défaut`, 'WARN');
    subtype = 'biere';
  }
  
  if (group==='clopes'){
    if (subtype==='class'){ d.cl_class=Math.max(0, d.cl_class+delta); }
    if (subtype==='roul'){  d.cl_roul =Math.max(0, d.cl_roul +delta); }
    if (subtype==='tube'){  d.cl_tube =Math.max(0, d.cl_tube +delta); }
  }else if (group==='joints'){ 
    d.joints = Math.max(0, d.joints + delta); 
  }
  else if (group==='alcool'){
    if (subtype==='biere'){ d.alc_biere=Math.max(0, d.alc_biere+delta); }
    if (subtype==='fort'){ d.alc_fort=Math.max(0, d.alc_fort+delta); }
    if (subtype==='liqueur'){ d.alc_liqueur=Math.max(0, d.alc_liqueur+delta); }
  }
  d.timestamps.push({group,subtype,delta,heure:new Date().toLocaleTimeString()});
  derniereAction={group,subtype,delta,date:key};
  persist(); updateAllUI();
  showSnackbar('Action enregistrée');
}

/* ===================== NAV ===================== */
function goto(screen){
  ['ecran-principal','ecran-stats','ecran-calendrier','ecran-habitudes','ecran-params'].forEach(id=>byId(id).classList.remove('actif'));
  byId('ecran-'+screen).classList.add('actif');
  ['nav-principal','nav-stats','nav-calendrier','nav-habitudes','nav-params'].forEach(id=>byId(id).classList.remove('actif'));
  byId('nav-'+screen).classList.add('actif');

  if (screen==='stats'){
    refreshStatsTabsUI();
    updateBannerStats();
    updateStatsBloc();
    buildAdviceQueue('stats');
    setTimeout(()=>{ updateStatsBloc(); window.dispatchEvent(new Event('resize')); }, 180);
  }
  if (screen==='calendrier'){ renderCalendrier(); }
}

// CORRECTION : Event listeners uniques pour la navigation
let navInitialized = false;
function initNavigation() {
  if (navInitialized) return;
  
  byId('nav-principal')?.addEventListener('click', ()=> goto('principal'));
  byId('nav-stats')?.addEventListener('click', ()=> goto('stats'));
  byId('nav-calendrier')?.addEventListener('click', ()=> goto('calendrier'));
  byId('nav-habitudes')?.addEventListener('click', ()=> goto('habitudes'));
  byId('nav-params')?.addEventListener('click', ()=> goto('params'));
  
  navInitialized = true;
}

/* ===================== STATS TABS ===================== */
function refreshStatsTabsUI(){
  document.querySelectorAll('#ecran-stats .tab').forEach(b=>{
    b.classList.toggle('actif', b.dataset.vue === vueStats);
  });
}

function setStatsView(v){
  vueStats = v;
  window.vueStats = vueStats; // <-- ajoute cette ligne
  persist();
  refreshStatsTabsUI();
  updateBannerStats();
  updateStatsBloc(); // Cette fonction appellera updateGraphiques()
}

// CORRECTION : Event listeners uniques pour les tabs
let statsTabsInitialized = false;
function initStatsTabs() {
  if (statsTabsInitialized) return;
  
  document.querySelectorAll('#ecran-stats .tab').forEach(b=>{
    b.addEventListener('click', ()=> setStatsView(b.dataset.vue));
  });
  
  statsTabsInitialized = true;
}

/* ===================== PARAMS BIND ===================== */
function bindNum(id, obj, key, isFloat=false){
  const el=byId(id); if(!el) return;
  el.value = (obj[key] ?? 0);
  const apply=()=>{ 
    let v=isFloat?parseFloat(el.value):parseInt(el.value); 
    if (isNaN(v)) v=0; 
    obj[key]=v; 
    persist(); updateAllUI(); 
  };
  el.addEventListener('blur', apply); 
  el.addEventListener('change', apply);
}

function bindText(id, obj, key){
  const el=byId(id); if(!el) return;
  el.value = (obj[key] ?? '');
  const apply=()=>{ obj[key]=el.value||''; persist(); updateAllUI(); };
  el.addEventListener('blur', apply); 
  el.addEventListener('change', apply);
}

function bindBool(id, obj, key){
  const el=byId(id); if(!el) return;
  el.checked = !!obj[key];
  el.addEventListener('change', ()=>{ obj[key]=!!el.checked; persist(); updateAllUI(); });
}

function bindDate(id, obj, key){
  const el=byId(id); if(!el) return;
  el.value = obj[key] || '';
  const apply=()=>{ obj[key]=el.value||null; persist(); updateAllUI(); };
  el.addEventListener('change', apply);
}

function initParamsUI(){
  const ip=byId('prenom-utilisateur'); 
  if (ip){ 
    ip.value = prenomUtilisateur; 
    ip.addEventListener('blur', ()=>{ 
      prenomUtilisateur=(ip.value||'').trim(); 
      persist(); updateAllUI(); 
    }); 
  }

  bindBool('enable-classiques', params, 'enable_classiques');
  bindNum('prix-paquet', params, 'prix_paquet', true);
  bindNum('cigs-par-paquet', params, 'cigs_par_paquet', false);

  bindBool('enable-roulees', params, 'enable_roulees');
  bindNum('prix-tabac-roul', params, 'prix_tabac_roul', true);
  bindNum('cigs-par-30g-roul', params, 'cigs_par_30g_roul', false);
  bindNum('prix-feuille-petite', params, 'prix_feuille_petite', true);
  bindNum('feuilles-petite-par-carnet', params, 'feuilles_petite_par_carnet', false);
  bindNum('prix-filtre-ocb', params, 'prix_filtre_ocb', true);
  bindNum('filtres-par-sachet', params, 'filtres_par_sachet', false);
  bindBool('use-filtre-roulee', params, 'use_filtre_roulee');

  bindBool('enable-tubes', params, 'enable_tubes');
  bindNum('cigs-par-30g-tube', params, 'cigs_par_30g_tube', false);
  bindNum('prix-tubes', params, 'prix_tubes', true);
  bindNum('tubes-par-boite', params, 'tubes_par_boite', false);

  bindNum('prix-gramme', params, 'prix_gramme', true);
  bindNum('grammes-par-joint', params, 'grammes_par_joint', true);
  bindNum('prix-feuille-grande', params, 'prix_feuille_grande', true);
  bindNum('feuilles-grande-par-carnet', params, 'feuilles_grande_par_carnet', false);
  bindBool('use-filtre-joint', params, 'use_filtre_joint');

  bindBool('enable-biere', params, 'enable_biere'); bindNum('prix-biere', params, 'prix_biere', true); bindText('unite-biere', params, 'unite_biere');
  bindBool('enable-fort', params, 'enable_fort');   bindNum('prix-fort', params, 'prix_fort', true);   bindText('unite-fort', params, 'unite_fort');
  bindBool('enable-liqueur', params, 'enable_liqueur'); bindNum('prix-liqueur', params, 'prix_liqueur', true); bindText('unite-liqueur', params, 'unite_liqueur');

  bindNum('limite-clopes', params, 'limite_clopes', false);
  bindNum('limite-joints', params, 'limite_joints', false);
  bindNum('limite-biere', params, 'limite_biere', false);
  bindNum('limite-fort', params, 'limite_fort', false);
  bindNum('limite-liqueur', params, 'limite_liqueur', false);

  bindNum('hab-min-cl-class', habitudes, 'min_cl_class'); bindNum('hab-max-cl-class', habitudes, 'max_cl_class');
  bindNum('hab-min-cl-roul', habitudes, 'min_cl_roul');   bindNum('hab-max-cl-roul', habitudes, 'max_cl_roul');
  bindNum('hab-min-cl-tube', habitudes, 'min_cl_tube');   bindNum('hab-max-cl-tube', habitudes, 'max_cl_tube');
  bindNum('hab-min-joint', habitudes, 'min_joint');       bindNum('hab-max-joint', habitudes, 'max_joint');
  bindNum('hab-min-biere', habitudes, 'min_biere');       bindNum('hab-max-biere', habitudes, 'max_biere');
  bindNum('hab-min-fort', habitudes, 'min_fort');         bindNum('hab-max-fort', habitudes, 'max_fort');
  bindNum('hab-min-liqueur', habitudes, 'min_liqueur');   bindNum('hab-max-liqueur', habitudes, 'max_liqueur');

  bindDate('date-reduc-clopes', datesObj, 'reduc_clopes');
  bindDate('date-stop-clopes',  datesObj, 'stop_clopes');
  bindDate('date-no-clopes',    datesObj, 'no_clopes');
  bindDate('date-reduc-joints', datesObj, 'reduc_joints');
  bindDate('date-stop-joints',  datesObj, 'stop_joints');
  bindDate('date-no-joints',    datesObj, 'no_joints');
  bindDate('date-reduc-alcool', datesObj, 'reduc_alcool');
  bindDate('date-stop-alcool',  datesObj, 'stop_alcool');
  bindDate('date-no-alcool',    datesObj, 'no_alcool');

  const dbgToggle = byId('toggle-debug');
  if (dbgToggle){
    dbgToggle.checked = byId('debug-console').classList.contains('show');
    dbgToggle.addEventListener('change', ()=>{
      const el=byId('debug-console');
      if (dbgToggle.checked) el.classList.add('show'); else el.classList.remove('show');
      persist();
    });
  }
}

/* ===================== CALENDRIER ===================== */
let calRef = new Date();

function renderCalendrier(){
  const ent = byId('cal-entete');
  if (ent){
    ent.innerHTML='';
    ['L','M','M','J','V','S','D'].forEach(d=>{
      const e=document.createElement('div');
      e.className='cal-dow';
      e.textContent=d;
      ent.appendChild(e);
    });
  }

  const y = calRef.getFullYear(), m = calRef.getMonth();
  const titre = calRef.toLocaleDateString('fr-FR',{month:'long', year:'numeric'});
  setText('cal-titre', titre[0].toUpperCase()+titre.slice(1));

  const first = firstDayOfMonth(y,m);
  const last  = lastDayOfMonth(y,m);
  const firstWeekday = (first.getDay()+6)%7;
  const daysInMonth = last.getDate();

  const grille = byId('cal-grille');
  if (!grille) return;
  grille.innerHTML='';

  // ——— 1) Cherche le volume max du mois, sans créer de jours vides
  let maxTot = 0;
  for (let d=1; d<=daysInMonth; d++){
    const k = keyStrictLocal(new Date(y, m, d));
    const rec = donnees[k];
    if (!rec) continue;
    const tot = (Number(rec.cl_class)||0) + (Number(rec.cl_roul)||0) + (Number(rec.cl_tube)||0)
              + (Number(rec.joints)||0)
              + (Number(rec.alc_biere)||0) + (Number(rec.alc_fort)||0) + (Number(rec.alc_liqueur)||0);
    if (tot>maxTot) maxTot = tot;
  }

  // ——— 2) Jours vides avant le 1er
  for (let i=0; i<firstWeekday; i++){
    const e=document.createElement('div');
    e.className='cal-cell cal-empty';
    grille.appendChild(e);
  }

  // ——— 3) Cases du mois
  const elC = byId('filtre-c'), showC = !elC || !!elC.checked;
  const elJ = byId('filtre-j'), showJ = !elJ || !!elJ.checked;
  const elA = byId('filtre-a'), showA = !elA || !!elA.checked;
  const todayStr = keyStrictLocal(new Date());

  for (let d=1; d<=daysInMonth; d++){
    const cell = document.createElement('div');
    cell.className = 'cal-cell';

    const n = document.createElement('div');
    n.className = 'cal-num';
    n.textContent = d;
    cell.appendChild(n);

    // Clé DU JOUR DE LA CASE (sécurisé)
    const k = keyStrictLocal(new Date(y, m, d));
    const rec = donnees[k] || null;

    const cClass = rec ? Number(rec.cl_class)||0 : 0;
    const cRoul  = rec ? Number(rec.cl_roul)||0  : 0;
    const cTube  = rec ? Number(rec.cl_tube)||0  : 0;
    const jnts   = rec ? Number(rec.joints)||0   : 0;
    const aBiere = rec ? Number(rec.alc_biere)||0: 0;
    const aFort  = rec ? Number(rec.alc_fort)||0 : 0;
    const aLiq   = rec ? Number(rec.alc_liqueur)||0:0;

    const totC = cClass + cRoul + cTube;
    const totJ = jnts;
    const totA = aBiere + aFort + aLiq;
    const tot  = totC + totJ + totA;

    // Chaleur (seulement si ce jour a un total > 0)
    if (tot>0){
      const heat = document.createElement('div');
      heat.className = 'cal-heat ' + (maxTot>0 && tot>(maxTot*0.66) ? 'high' : (maxTot>0 && tot>(maxTot*0.33) ? 'mid' : ''));
      cell.appendChild(heat);
    }

    // Pastilles (uniquement si au moins une à afficher)
    const needC = showC && totC>0;
    const needJ = showJ && totJ>0;
    const needA = showA && totA>0;
    if (needC || needJ || needA){
      const badges = document.createElement('div');
      badges.className = 'cal-badges';
      if (needC){ const b=document.createElement('div'); b.className='dot c'; badges.appendChild(b); }
      if (needJ){ const b=document.createElement('div'); b.className='dot j'; badges.appendChild(b); }
      if (needA){ const b=document.createElement('div'); b.className='dot a'; badges.appendChild(b); }
      cell.appendChild(badges);
    }

    // Ruban ⚙ (dates d’objectifs exactes)
    if (k===datesObj.stop_clopes || k===datesObj.stop_joints || k===datesObj.stop_alcool){
      const f=document.createElement('div'); f.className='cal-flag'; f.textContent='⚙';
      cell.appendChild(f);
    }

    // Sélection du jour
    if (k===todayStr){ cell.style.outline='2px solid #3b82f6'; }

    // Clic = ouvrir la modale sur LA même clé k
    cell.addEventListener('click', ()=> openDayModal(k));

    grille.appendChild(cell);
  }
}


// CORRECTION : Event listeners uniques pour le calendrier
let calInitialized = false;
function initCalendrier() {
  if (calInitialized) return;
  
  byId('cal-prev')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()-1); renderCalendrier(); });
  byId('cal-next')?.addEventListener('click', ()=>{ calRef.setMonth(calRef.getMonth()+1); renderCalendrier(); });
  byId('cal-today')?.addEventListener('click', ()=>{ calRef=new Date(); renderCalendrier(); });
  ['filtre-c','filtre-j','filtre-a'].forEach(id=> byId(id)?.addEventListener('change', renderCalendrier));
  
  calInitialized = true;
}

/* ===================== MODAL JOUR ===================== */
let modalKey=null;

function openDayModal(key){
  modalKey=key;
  const d=donnees[key]||{cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0};
  setText('cal-jour-titre', new Date(key).toLocaleDateString('fr-FR',{weekday:'long', day:'numeric', month:'long'}));
  setText('cal-jour-c', `${d.cl_class+d.cl_roul+d.cl_tube} (C ${d.cl_class} • R ${d.cl_roul} • T ${d.cl_tube})`);
  setText('cal-jour-j', `${d.joints}`);
  setText('cal-jour-a', `${d.alc_biere+d.alc_fort+d.alc_liqueur} (B ${d.alc_biere} • F ${d.alc_fort} • L ${d.alc_liqueur})`);

  // CORRECTION : Synchronisation des segments dans la modal
  const sc=byId('cal-jour-seg-c'); if (sc){ sc.innerHTML='';
    const arrC=[];
    if (params.enable_classiques) arrC.push(['class','Classiques']);
    if (params.enable_roulees)    arrC.push(['roul','Roulées']);
    if (params.enable_tubes)      arrC.push(['tube','Tubes']);
    if (arrC.length>1){
      arrC.forEach(([k,lab])=>{
        const b=document.createElement('button'); 
        b.className='seg'+(segClopesSel===k?' actif':''); 
        b.textContent=lab;
        b.addEventListener('click', ()=>{ segClopesSel=k; openDayModal(key); });
        sc.appendChild(b);
      });
    }
  }

  const sa=byId('cal-jour-seg-a'); if (sa){ sa.innerHTML='';
    const arrA=[];
    if (params.enable_biere)   arrA.push(['biere','Bière']);
    if (params.enable_fort)    arrA.push(['fort','Alcool fort']);
    if (params.enable_liqueur) arrA.push(['liqueur','Liqueur']);
    if (arrA.length>1){
      arrA.forEach(([k,lab])=>{
        const b=document.createElement('button'); 
        b.className='seg'+(segAlcoolSel===k?' actif':''); 
        b.textContent=lab;
        b.addEventListener('click', ()=>{ segAlcoolSel=k; openDayModal(key); });
        sa.appendChild(b);
      });
    }
  }

  const cout = calculerCoutJour(d).toFixed(2);
  setText('cal-jour-resume', `Coût estimé : ${cout} €`);

  openModal('cal-modal');
}

// CORRECTION : Event listeners uniques pour la modal jour
let modalJourInitialized = false;
function initModalJour() {
  if (modalJourInitialized) return;
  
  byId('cal-jour-fermer')?.addEventListener('click', ()=> closeModal('cal-modal'));
  byId('cal-jour-raz')?.addEventListener('click', ()=>{
    if (!modalKey) return;
    takeSnapshot();
    donnees[modalKey]={cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0,timestamps:[]};
    persist(); renderCalendrier(); updateAllUI(); showSnackbar('RAZ du jour');
  });

  byId('cal-c-plus')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); if(segClopesSel==='class') d.cl_class++; else if(segClopesSel==='roul') d.cl_roul++; else d.cl_tube++; persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });
  byId('cal-c-moins')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); if(segClopesSel==='class') d.cl_class=Math.max(0,d.cl_class-1); else if(segClopesSel==='roul') d.cl_roul=Math.max(0,d.cl_roul-1); else d.cl_tube=Math.max(0,d.cl_tube-1); persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });

  byId('cal-j-plus')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); d.joints++; persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });
  byId('cal-j-moins')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); d.joints=Math.max(0,d.joints-1); persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });

  byId('cal-a-plus')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); if(segAlcoolSel==='biere') d.alc_biere++; else if(segAlcoolSel==='fort') d.alc_fort++; else d.alc_liqueur++; persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });
  byId('cal-a-moins')?.addEventListener('click', ()=>{ if(!modalKey) return; const d=getJour(modalKey); if(segAlcoolSel==='biere') d.alc_biere=Math.max(0,d.alc_biere-1); else if(segAlcoolSel==='fort') d.alc_fort=Math.max(0,d.alc_fort-1); else d.alc_liqueur=Math.max(0,d.alc_liqueur-1); persist(); openDayModal(modalKey); renderCalendrier(); updateAllUI(); });
  
  modalJourInitialized = true;
}

/* ===================== EXPORTS & RAZ ===================== */
function takeSnapshot(){ 
  try{ 
    localStorage.setItem(K_SNAP, JSON.stringify(donnees)); 
    snapshot=true; 
    derniereAction={group:'snapshot'}; 
  }catch(e){
    debugLog('Erreur snapshot: '+e.message,'ERROR');
  }
}

function razJour(){
  takeSnapshot();
  const k=dateKey(); 
  donnees[k]={cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0,timestamps:[]};
  persist(); updateAllUI(); showSnackbar('RAZ du jour'); 
}

function razPeriode(){
if (!confirm('Confirmer la RAZ de la période affichée dans Stats ?')) return;
  takeSnapshot();
  const now=new Date(); let d1,d2;
  if (vueStats==='jour'){ d1=new Date(now); d1.setHours(0,0,0,0); d2=new Date(now); d2.setHours(23,59,59,999); }
  else if (vueStats==='semaine'){ d1=startOfWeek(now); d2=endOfWeek(now); }
  else if (vueStats==='mois'){ d1=startOfMonth(now); d2=endOfMonth(now); }
  else { d1=startOfYear(now); d2=endOfYear(now); }
  const __ks = (typeof keysBetweenLocal==='function') ? keysBetweenLocal(d1,d2) : Object.keys(donnees||{});
for (const k of __ks){
  donnees[k] = {cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0,timestamps:[]};
}
persist(); updateAllUI(); showSnackbar('RAZ de la période'); 
}

function razHistorique(){
  if (!confirm('Effacer TOUT lhistorique de consommation ?')) return;
  if (!confirm('Dernière confirmation : TOUT sera effacé (réglages conservés).')) return;
  takeSnapshot();
  donnees={};
  persist(); updateAllUI(); showSnackbar('RAZ historique'); 
}

function razReglages(){
  if (!confirm('Réinitialiser les réglages aux valeurs par défaut ?')) return;
  params = {
    enable_classiques:false, prix_paquet:11.00, cigs_par_paquet:20,
    enable_roulees:false, prix_tabac_roul:18.30, cigs_par_30g_roul:55, prix_feuille_petite:1.20, feuilles_petite_par_carnet:100,
    prix_filtre_ocb:1.50, filtres_par_sachet:150, use_filtre_roulee:true,
    enable_tubes:false, cigs_par_30g_tube:50, prix_tubes:2.80, tubes_par_boite:100,
    prix_gramme:5.60, grammes_par_joint:0.8, prix_feuille_grande:1.60, feuilles_grande_par_carnet:32, use_filtre_joint:false,
    enable_biere:false, prix_biere:2.50, unite_biere:'33 cl',
    enable_fort:false,  prix_fort:3.00,  unite_fort:'4 cl',
    enable_liqueur:false, prix_liqueur:2.80, unite_liqueur:'6 cl',
    limite_clopes:0, limite_joints:0, limite_biere:0, limite_fort:0, limite_liqueur:0
  };
  persist(); initParamsUI(); updateAllUI(); showSnackbar('Réglages réinitialisés'); 
}

function exportCSV(){
  const src = window.donnees || donnees;  // au cas où
  const rows = [['date','cl_class','cl_roul','cl_tube','joints','alc_biere','alc_fort','alc_liqueur','cout']];

  Object.keys(src).sort().forEach(k=>{
    const d = src[k] || {};
    const cout = (typeof calculerCoutJour === 'function' ? calculerCoutJour(d) : 0).toFixed(2);
    rows.push([k, d.cl_class||0, d.cl_roul||0, d.cl_tube||0, d.joints||0, d.alc_biere||0, d.alc_fort||0, d.alc_liqueur||0, cout]);
  });

  // Séparateur ; pour Excel FR + BOM pour l’ouverture directe
  const csv = '\uFEFF' + rows.map(r => r.join(';')).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url;
  a.download = 'stopaddict_v23.csv';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}


function exportJSON(){
  const data={prenomUtilisateur,params,habitudes,donnees,datesObj};
  const a=document.createElement('a'); 
  a.href='data:application/json;charset=utf-8,'+encodeURIComponent(JSON.stringify(data)); 
  a.download='stopaddict_backup_v23.json'; 
  a.click();
}

// CORRECTION : Event listeners uniques pour les RAZ et exports
let razExportInitialized = false;
function initRazExport() {
  if (razExportInitialized) return;
  
  byId('btn-raz-jour')?.addEventListener('click', razJour);
  byId('btn-raz-periode')?.addEventListener('click', razPeriode);
  byId('btn-raz-histo')?.addEventListener('click', razHistorique);
  byId('btn-raz-reglages')?.addEventListener('click', razReglages);
  byId('btn-export-csv')?.addEventListener('click', exportCSV);
  byId('btn-export-json')?.addEventListener('click', exportJSON);
  byId('btn-purge-local')?.addEventListener('click', purgeLocalStats);

  razExportInitialized = true;
}

/* ===================== CONSEILS CONTROLS ===================== */
let conseilsInitialized = false;
function initConseils() {
  if (conseilsInitialized) return;
  
  byId('adv-prev') ?.addEventListener('click',(e)=>{e.preventDefault(); prevAdvice();});
  byId('adv-pause')?.addEventListener('click',(e)=>{e.preventDefault(); pauseAdviceRotation(!advPaused);});
  
  conseilsInitialized = true;
}

/* ===================== LIENS LIMITES ===================== */
let limitesInitialized = false;
function initLimites() {
  if (limitesInitialized) return;
  
  byId('lien-limites')  ?.addEventListener('click', (e)=>{ e.preventDefault(); goto('params'); byId('limite-clopes').focus(); });
  byId('lien-limites-2')?.addEventListener('click', (e)=>{ e.preventDefault(); goto('params'); byId('limite-clopes').focus(); });
  
  limitesInitialized = true;
}

/* ===================== DEBUG UI ===================== */
let debugInitialized = false;
function initDebug() {
  if (debugInitialized) return;
  
  byId('btn-copy-logs')?.addEventListener('click', async ()=>{
    try{ 
      await navigator.clipboard.writeText(debugMessages.join('\n')); 
      showSnackbar('Logs copiés'); 
    }catch(e){ 
      alert('Copie impossible : '+e.message); 
    }
  });
  byId('btn-clear-logs')?.addEventListener('click', ()=>{
    debugMessages=[]; 
    const el=byId('debug-console'); 
    if (el) el.innerHTML=''; 
    showSnackbar('Logs vidés');
  });
  
  debugInitialized = true;
}

/* ===================== MODALES (helpers) ===================== */
function openModal(id){ 
  const m=byId(id); 
  if (m){ 
    m.classList.add('show'); 
    m.setAttribute('aria-hidden','false'); 
  } 
}

function closeModal(id){ 
  const m=byId(id); 
  if (m){ 
    m.classList.remove('show'); 
    m.setAttribute('aria-hidden','true'); 
  } 
}

let keydownInitialized = false;
function initKeydown() {
  if (keydownInitialized) return;
  
  document.addEventListener('keydown', (e)=>{ 
    if(e.key==='Escape'){ 
      closeModal('cal-modal'); 
      closeModal('modal-page'); 
      closeModal('modal-warn');
    }
  });
  
  keydownInitialized = true;
}

/* ===================== AVERTISSEMENT 18+ ===================== */
let reopenWarnAfterPage=false;

function setupWarnModal(){
  const chk18 = byId('chk-warn-18');
  const chkHide = byId('chk-warn-hide');
  const btnAccept = byId('btn-warn-accept');
  const btnCancel = byId('btn-warn-cancel');
  const btnQuit   = byId('btn-warn-quit');

  chk18?.addEventListener('change', ()=>{ btnAccept.disabled = !chk18.checked; });
  btnAccept?.addEventListener('click', ()=>{
    const val={accepted:true, hide: !!chkHide?.checked, ts: Date.now()};
    localStorage.setItem(K_WARN, JSON.stringify(val));
    closeModal('modal-warn');
  });
  btnCancel?.addEventListener('click', ()=>{
    if (chk18) chk18.checked=false;
    if (chkHide) chkHide.checked=false;
    btnAccept.disabled = true;
  });
  btnQuit?.addEventListener('click', ()=>{
    alert('Vous pouvez fermer longlet maintenant.');
  });

  byId('open-ressources-from-warn')?.addEventListener('click',(e)=>{
    e.preventDefault();
    reopenWarnAfterPage=true;
    setPageContent('ressources');
    closeModal('modal-warn');
    openModal('modal-page');
  });
}

function checkWarnOnStartup(){
  try{
    const raw = localStorage.getItem(K_WARN);
    const parsed = raw ? JSON.parse(raw) : null;
    if (!parsed || !parsed.accepted || !parsed.hide){
      openModal('modal-warn');
    }
  }catch(e){
    openModal('modal-warn');
  }
}

/* ===================== PAGES (Manuel / CGV / Mentions / Ressources) ===================== */
const EFFECTIVE_DATE = '15 septembre 2025';

function setPageContent(kind){
  const title = byId('page-title');
  const content = byId('page-content');
  if (!title || !content) return;

  let html='';
  if (kind==='manuel'){
    title.textContent='Manuel dutilisation — StopAddict';
    html = `
    <p><strong>Objectif :</strong> taider à suivre et réduire/arrêter tes consommations (tabac, alcool, cannabis), sans incitation.</p>
    <h4>1) Écran Accueil</h4>
    <ul>
      <li>Choisis le type (Clopes : Classiques/Roulées/Tubes ; Alcool : Bière/Fort/Liqueur) via les pastilles.</li>
      <li>Boutons <strong>+</strong>/<strong>−</strong> pour ajouter/retirer une unité.</li>
      <li>Bandeau conseil : progression vs limites du jour et tips dynamiques.</li>
    </ul>
    <h4>2) Stats</h4>
    <ul>
      <li>Onglets <em>Jour/Semaine/Mois/Année</em>. Totaux + coût estimé.</li>
      <li>Barres vs limites (si définies dans Réglages).</li>
    </ul>
    <h4>3) Calendrier</h4>
    <ul>
      <li>Chaleur = volume; pastilles = type consommé (clope/joint/alcool).</li>
      <li>Appuie sur un jour pour éditer ou RAZ ce jour.</li>
    </ul>
    <h4>4) Habitudes & Réglages</h4>
    <ul>
      <li><strong>Habitudes</strong> : min/max journaliers pour alimenter les conseils.</li>
      <li><strong>Réglages</strong> : activer les catégories, prix/unités, limites, dates dobjectifs.</li>
      <li><strong>RAZ & Sauvegarde</strong> : reset jour/période/historique, export CSV/JSON.</li>
    </ul>
    <h4>5) Données & confidentialité</h4>
    <ul>
      <li>Stockage <strong>local</strong> sur lappareil (localStorage). Aucune synchronisation externe.</li>
      <li>Tu peux exporter/supprimer à tout moment (voir RAZ & sauvegarde).</li>
    </ul>
    <p class="mini">Dernière mise à jour : ${EFFECTIVE_DATE}</p>`;
  } else if (kind==='cgv'){
    title.textContent='Conditions Générales de Vente (CGV)';
    html = `
    <p><strong>Prix public :</strong> 1,00 € TTC (ou équivalent devise locale selon Google Play).</p>
    <h4>1) Objet</h4><p>La présente licence te permet dutiliser StopAddict pour un usage personnel.</p>
    <h4>2) Achat & paiement</h4>
    <p>Lachat et le paiement sont gérés par Google Play. Les taxes, taux de change et disponibilité dépendent du Store.</p>
    <h4>3) Droit de rétractation</h4>
    <p>Contenu numérique fourni sur exécution immédiate : le droit de rétractation de lUE peut ne pas sappliquer une fois le téléchargement commencé, <em>sous réserve des règles de Google Play</em>.</p>
    <h4>4) Mises à jour</h4><p>Des mises à jour correctives ou évolutives peuvent être proposées sans obligation de disponibilité continue.</p>
    <h4>5) Responsabilité</h4>
    <p>StopAddict nest pas un dispositif médical. Aucune responsabilité pour dommages indirects. Utilisation responsable et conforme aux lois locales.</p>
    <h4>6) Support</h4>
    <p>Contact : <a href="mailto:stopmauvaiseshabitudes@gmail.com">stopmauvaiseshabitudes@gmail.com</a> (délai cible 72 h ouvrées).</p>
    <h4>7) Loi applicable & litiges</h4>
    <p>En labsence dentreprise constituée, ces CGV sont proposées à titre dinformation. La loi applicable et la juridiction pourront dépendre de ta localisation et des règles du Store.</p>
    <p class="mini">Entrée en vigueur : ${EFFECTIVE_DATE}</p>`;
  } else if (kind==='mentions'){
    title.textContent='Mentions légales';
    html = `
    <p><strong>Éditeur :</strong> À compléter (auto-entrepreneur — ouverture prévue décembre).<br>
    <strong>Contact :</strong> <a href="mailto:stopmauvaiseshabitudes@gmail.com">stopmauvaiseshabitudes@gmail.com</a><br>
    <strong>Hébergement :</strong> Application distribuée via Google Play Store. Données utilisateur stockées localement sur lappareil.</p>
    <p><strong>Protection des données :</strong> aucune collecte côté serveur. Les données que tu saisis restent sur lappareil. Export/RAZ disponibles.</p>
    <p><strong>Avertissement santé :</strong> réservé aux 18+. Lapp nincite pas à la consommation et ne remplace pas un accompagnement médical/psychologique/social.</p>
    <p class="mini">Entrée en vigueur : ${EFFECTIVE_DATE}</p>`;
  } else if (kind==='ressources'){
    title.textContent='Ressources et numéros utiles';
    html = `
    <ul>
      <li><strong>Urgences</strong> : 112 (UE) / 15 (FR — SAMU)</li>
      <li><strong>Tabac info service (FR)</strong> : 39 89 — tabac-info-service.fr</li>
      <li><strong>Alcool info service (FR)</strong> : 0 980 980 930 — alcool-info-service.fr</li>
      <li><strong>Drogues info service (FR)</strong> : 0 800 23 13 13 — drogues-info-service.fr</li>
    </ul>
    <p class="mini">Consulte les ressources locales dans ton pays si tu nes pas en France.</p>`;
  } else if (kind==='avertissement'){
    title.textContent='Avertissement — Public majeur (18+)';
    html = `
    <p><strong>StopAddict</strong> est une application dauto-suivi et daide à la réduction/arrêt (tabac, alcool, cannabis).</p>
    <ul>
      <li>Réservée aux personnes de 18 ans et plus.</li>
      <li>Ne fait pas la promotion de ces produits.</li>
      <li>Ne remplace pas un accompagnement médical/psychologique/social.</li>
      <li>Utilisez StopAddict de façon responsable.</li>
    </ul>`;
  }
  content.innerHTML = html;
}

let pagesInitialized = false;
function initPages() {
  if (pagesInitialized) return;
  
  byId('btn-open-manuel')  ?.addEventListener('click', ()=>{ setPageContent('manuel'); openModal('modal-page'); });
  byId('btn-open-cgv')     ?.addEventListener('click', ()=>{ setPageContent('cgv'); openModal('modal-page'); });
  byId('btn-open-mentions')?.addEventListener('click', ()=>{ setPageContent('mentions'); openModal('modal-page'); });
  byId('btn-open-warn')    ?.addEventListener('click', ()=>{ openModal('modal-warn'); });

  byId('btn-page-close')?.addEventListener('click', ()=>{
    closeModal('modal-page');
    if (reopenWarnAfterPage){
      reopenWarnAfterPage=false;
      openModal('modal-warn');
    }
  });
  
  pagesInitialized = true;
}

/* ===================== VISIBILITY (pause rotation) ===================== */
let visibilityInitialized = false;
function initVisibility() {
  if (visibilityInitialized) return;
  
  document.addEventListener('visibilitychange', ()=>{
    if (document.hidden){ 
      pauseAdviceRotation(true); 
    } else { 
      pauseAdviceRotation(false); 
      buildAdviceQueue(); 
      setAdviceText(); 
      startAdviceRotation(); 
    }
  });
  
  visibilityInitialized = true;
}

/* ===================== SECRET DEBUG GESTURE ===================== */
let tapCount=0; let tapTimer=null;
let gestureInitialized = false;
function initGesture() {
  if (gestureInitialized) return;
  
  byId('header')?.addEventListener('click', ()=>{
    tapCount++; 
    clearTimeout(tapTimer);
    tapTimer=setTimeout(()=> tapCount=0, 800);
    if (tapCount>=5){
      tapCount=0;
      const el=byId('debug-console');
      if (el.classList.contains('show')) el.classList.remove('show'); 
      else el.classList.add('show');
      persist();
    }
  });
  
  gestureInitialized = true;
}

/* ===================== GLOBAL UPDATE ===================== */
function updateAllUI(){
  updateHeader();
  renderSegments();
  updateTopStats();
  updateBannerAccueil();
  if (byId('ecran-stats').classList.contains('actif')){
    refreshStatsTabsUI();
    updateBannerStats();
    updateStatsBloc();
  }
  if (byId('ecran-calendrier').classList.contains('actif')){
    renderCalendrier();
  }
  persist();
}

/* ===================== BOUTONS ACTION - CORRECTION ===================== */
let actionsInitialized = false;
function initActions() {
  if (actionsInitialized) return;

  const btnClopesMoins = byId('btn-clopes-moins');
  const btnClopesPlus = byId('btn-clopes-plus');
  const btnJointsMoins = byId('btn-joints-moins');
  const btnJointsPlus = byId('btn-joints-plus');
  const btnAlcMoins = byId('btn-alc-moins');
  const btnAlcPlus = byId('btn-alc-plus');

  if (btnClopesMoins) {
    btnClopesMoins.addEventListener('click', ()=> {
      debugLog('Clic bouton clopes -1, segment: ' + segClopesSel);
      enregistrerAction('clopes', segClopesSel, -1);
    });
  }
  if (btnClopesPlus) {
    btnClopesPlus.addEventListener('click', ()=> {
      debugLog('Clic bouton clopes +1, segment: ' + segClopesSel);
      enregistrerAction('clopes', segClopesSel, +1);
    });
  }
  if (btnJointsMoins) {
    btnJointsMoins.addEventListener('click', ()=> {
      debugLog('Clic bouton joints -1');
      enregistrerAction('joints', null, -1);
    });
  }
  if (btnJointsPlus) {
    btnJointsPlus.addEventListener('click', ()=> {
      debugLog('Clic bouton joints +1');
      enregistrerAction('joints', null, +1);
    });
  }
  if (btnAlcMoins) {
    btnAlcMoins.addEventListener('click', ()=> {
      debugLog('Clic bouton alcool -1, segment: ' + segAlcoolSel);
      enregistrerAction('alcool', segAlcoolSel, -1);
    });
  }
  if (btnAlcPlus) {
    btnAlcPlus.addEventListener('click', ()=> {
      debugLog('Clic bouton alcool +1, segment: ' + segAlcoolSel);
      enregistrerAction('alcool', segAlcoolSel, +1);
    });
  }

  actionsInitialized = true;
  debugLog('Event listeners des boutons action attachés');
}

/* ===================== INIT ===================== */
function init(){
  try {
    debugLog('Début initialisation StopAddict v2.3.1 - Version corrigée');
    
    // Chargement des données
    compatLoad();
    debugLog('Données chargées avec succès');
    
    // Interface utilisateur
    updateHeader(); 
    setInterval(updateHeader, 60000);
    debugLog('Header initialisé');
    
    // Initialisation de tous les composants avec event listeners uniques
    initNavigation();
    initStatsTabs();
    initParamsUI();
    initCalendrier();
    initModalJour();
    initRazExport();
    initConseils();
    initLimites();
    initDebug();
    initKeydown();
    initPages();
    initVisibility();
    initGesture();
    initActions();
    
    debugLog('Tous les composants initialisés');
    
    renderSegments();
    debugLog('Segments rendus');
    
    updateAllUI();
    debugLog('Interface mise à jour');
    
    // Rotation des conseils
    startAdviceRotation();
    debugLog('Rotation des conseils démarrée');

    // Modales d'avertissement
    setupWarnModal();
    debugLog('Modal avertissement configurée');
    
    checkWarnOnStartup();
    debugLog('Vérification avertissement terminée');

    // Gestion des erreurs globales
    window.addEventListener('error', (e)=> {
      debugLog('Erreur globale: ' + (e.message || 'Erreur inconnue'), 'ERROR');
    });

    debugLog('Initialisation complète avec succès - Version corrigée');
    
  } catch(error) {
    debugLog('Erreur lors de l\'initialisation: ' + error.message, 'ERROR');
    console.error('Erreur init StopAddict:', error);
  }
}

// Initialisation au chargement du DOM
document.addEventListener('DOMContentLoaded', init);
</script>

<script>
(function(){
  if (!window.StopAddictCharts) return;

  // ---- État d’affichage (persisté en mémoire) ----
  const State = window.StopAddictChartsState = window.StopAddictChartsState || {
    visible: { clopes:true, joints:true, alcool:true, cout:true, economies:true }
  };

  // ---- Sélecteurs utiles ----
  const elCharts     = () => document.getElementById('stats-charts');
  const elLegend     = () => document.getElementById('chart-legend');
  const cConsos      = () => document.getElementById('chart-consommations');
  const cCoutEco     = () => document.getElementById('chart-cout-eco');
  const emptyConsos  = () => document.getElementById('empty-consos');
  const emptyCout    = () => document.getElementById('empty-cout');
  const actionsBar   = () => document.getElementById('chart-actions');

  // ---- Couleurs (cohérentes avec l’app) ----
  const COLORS = {
    clopes:    '#6b7280', // gris
    joints:    '#10b981', // vert
    alcool:    '#f59e0b', // orange
    cout:      '#7c3aed', // violet/gris foncé
    economies: '#2563eb'  // bleu
  };

  // ---- Outils divers ----
  const nfEUR0 = new Intl.NumberFormat('fr-FR',{ style:'currency', currency:'EUR', maximumFractionDigits:0 });
  const nfEUR2 = new Intl.NumberFormat('fr-FR',{ style:'currency', currency:'EUR', maximumFractionDigits:2 });
  function sum(a){ return (a||[]).reduce((s,x)=>s+(+x||0),0); }
  function max(a){ return (a||[]).reduce((m,x)=>Math.max(m, +x||0), 0); }
  function hasPositive(a){ return (a||[]).some(v => (+v||0) > 0); }

  // Ratio–indépendant : taille canvas au DPR pour netteté
  function fitCanvasToCSS(canvas){
    if (!canvas) return;
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const rect = canvas.getBoundingClientRect();
    const needResize = canvas.width !== Math.round(rect.width * dpr) || canvas.height !== Math.round(rect.height * dpr);
    if (needResize) {
      canvas.width  = Math.round(rect.width  * dpr);
      canvas.height = Math.round(rect.height * dpr);
    }
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0); // unités en CSS pixels
    return ctx;
  }

  // Grille & axes simples
  function niceStep(maxVal){
    // Pas "joli" pour graduations
    if (maxVal <= 10) return 2;
    const pow = Math.pow(10, Math.floor(Math.log10(maxVal)));
    const frac = maxVal / pow;
    if (frac <= 2) return 0.2 * pow;
    if (frac <= 5) return 0.5 * pow;
    return 1 * pow;
  }

  // Dessin d’un chart lignes (multi-séries)
  function drawLineChart(canvas, cfg){
    const ctx = fitCanvasToCSS(canvas);
    if (!ctx) return {points:[]};

    const W = canvas.getBoundingClientRect().width;
    const H = canvas.getBoundingClientRect().height;
    const PAD = { l: 48, r: 12, t: 16, b: 28 };

    ctx.clearRect(0,0,W,H);

    const labels = cfg.labels || [];
    const series = (cfg.series || []).filter(s => s && s.data && s.data.length === labels.length && s.visible!==false);

    // Domaines
    const yMax = Math.max(1, ...series.map(s => max(s.data)));
    const yStep = niceStep(yMax);
    const yAxisMax = Math.ceil(yMax / yStep) * yStep;

    const X0 = PAD.l, X1 = W - PAD.r;
    const Y0 = H - PAD.b, Y1 = PAD.t;

    function xAt(i){
      if (labels.length<=1) return (X0+X1)/2;
      return X0 + (i*(X1-X0)/(labels.length-1));
    }
    function yAt(v){
      const r = (yAxisMax === 0) ? 0 : (v / yAxisMax);
      return Y0 - r*(Y0 - Y1);
    }

    // Grille horizontale + labels Y
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillStyle = '#6b7280';
    ctx.strokeStyle = '#e5e7eb';
    ctx.lineWidth = 1;
    for (let y=0; y<=yAxisMax; y+=yStep){
      const yy = yAt(y);
      ctx.beginPath(); ctx.moveTo(X0, yy); ctx.lineTo(X1, yy); ctx.stroke();
      const txt = cfg.yFmt ? cfg.yFmt(y) : String(y);
      ctx.fillText(txt, 4, yy-2);
    }

    // Labels X (échantillonnage léger pour éviter la surcharge)
    const maxXLabels = Math.min(labels.length, 10);
    const stepX = Math.max(1, Math.floor(labels.length / maxXLabels));
    ctx.fillStyle = '#374151';
    for (let i=0;i<labels.length;i+=stepX){
      const xx = xAt(i);
      ctx.fillText(labels[i], xx-10, H-6);
    }

    // Séries (lignes + points)
    const pointsBySeries = {};
    ctx.lineWidth = 2;
    for (const s of series){
      ctx.strokeStyle = s.color || '#000';
      ctx.beginPath();
      for (let i=0;i<labels.length;i++){
        const x = xAt(i), y = yAt(+s.data[i]||0);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        (pointsBySeries[s.key] = pointsBySeries[s.key] || []).push({x,y,i,val:+s.data[i]||0});
      }
      ctx.stroke();

      // Points
      for (let i=0;i<labels.length;i++){
        const p = pointsBySeries[s.key][i];
        ctx.beginPath();
        ctx.arc(p.x, p.y, 2.5, 0, Math.PI*2);
        ctx.fillStyle = s.color || '#000';
        ctx.fill();
      }
    }

    return {pointsBySeries, xAt, yAt, X0,X1,Y0,Y1};
  }

  // Légende cliquable (toggle série)
  function renderLegend(allSeries){
    const box = elLegend(); if (!box) return;
    box.innerHTML = '';
    const unique = [];
    for (const s of allSeries){
      if (!s) continue;
      if (unique.find(u => u.key===s.key)) continue;
      unique.push({key:s.key, label:s.label, color:s.color});
    }
    for (const s of unique){
      const item = document.createElement('div');
      item.className = 'legend-item'+(State.visible[s.key]===false?' is-muted':'');
      item.setAttribute('role','button');
      item.setAttribute('aria-pressed', String(State.visible[s.key]!==false));
      item.dataset.key = s.key;

      const sw = document.createElement('span');
      sw.className = 'legend-swatch';
      sw.style.background = s.color;
      const lab = document.createElement('span');
      lab.textContent = s.label;

      item.appendChild(sw); item.appendChild(lab);
      item.addEventListener('click', ()=>{
        State.visible[s.key] = !(State.visible[s.key]!==false);
        item.classList.toggle('is-muted', State.visible[s.key]===false);
        renderAll(); // redraw
      });
      box.appendChild(item);
    }
  }

  // Mapping index → dateKey pour le clic (Calendrier)
  function getDateKeysForCurrentView(){
    try{
      const now = new Date();
      let d1,d2,type=window.vueStats;
      if (type==='jour'){
        return []; // clic pas pertinent en vue horaire/fallback
      } else if (type==='semaine'){
        d1 = startOfWeek(now); d2 = endOfWeek(now);
        return window.StopAddictCharts._debug.listKeysBetween(d1,d2);
      } else if (type==='mois'){
        d1 = startOfMonth(now); d2 = endOfMonth(now);
        return window.StopAddictCharts._debug.listKeysBetween(d1,d2);
      } else {
        // année: 12 mois -> on retourne les 1ers jours de mois
        d1 = startOfYear(now);
        const keys = [];
        for (let m=0;m<12;m++){
          const dt = new Date(d1.getFullYear(), m, 1);
          keys.push(dateKey(dt));
        }
        return keys;
      }
    }catch(e){ return []; }
  }

  function gotoCalendarForIndex(i){
    const keys = getDateKeysForCurrentView();
    const k = keys[i];
    if (!k) return;

    // Essayer des hooks s’ils existent (aucun effet de bord sinon)
    if (typeof window.showEcran === 'function') window.showEcran('calendrier');
    if (typeof window.focusCalendrierDate === 'function')      window.focusCalendrierDate(k);
    else if (typeof window.setCalendarFocusDate === 'function') window.setCalendarFocusDate(k);
  }

  // Attach clic sur le point le plus proche
  function attachPointClick(canvas, layout){
    if (!canvas || !layout || !layout.pointsBySeries) return;
    const idxAny = (function(){
      // prendre n’importe une série visible pour le mapping des X
      const visKeys = Object.keys(layout.pointsBySeries);
      return visKeys.length ? layout.pointsBySeries[visKeys[0]] : null;
    })();
    if (!idxAny) return;

    canvas.onclick = (ev)=>{
      const rect = canvas.getBoundingClientRect();
      const x = ev.clientX - rect.left;
      let bestI = 0, bestDX = Infinity;
      for (let i=0;i<idxAny.length;i++){
        const dx = Math.abs(idxAny[i].x - x);
        if (dx < bestDX){ bestDX = dx; bestI = i; }
      }
      if (bestDX < 20) gotoCalendarForIndex(bestI);
    };
  }

  // Actions (export PNG)
  function ensureActions(){
    const bar = actionsBar(); if (!bar) return;
    if (bar.dataset.ready === '1') return;
    const btn1 = document.createElement('button');
    btn1.className = 'btn';
    btn1.textContent = 'Exporter conso (PNG)';
    btn1.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = 'consommations.png';
      a.href = cConsos().toDataURL('image/png');
      a.click();
    });

    const btn2 = document.createElement('button');
    btn2.className = 'btn';
    btn2.textContent = 'Exporter coût/éco (PNG)';
    btn2.addEventListener('click', ()=>{
      const a = document.createElement('a');
      a.download = 'cout_economies.png';
      a.href = cCoutEco().toDataURL('image/png');
      a.click();
    });

    bar.appendChild(btn1);
    bar.appendChild(btn2);
    bar.hidden = false;
    bar.dataset.ready = '1';
  }

  // ---- Rendu principal ----
  function renderAll(){
    const wrap = elCharts();
    if (!wrap) return;

    const data = window.StopAddictCharts.buildSeriesForCurrentView();
    if (!data) return;

    // Séries conso
    const sConsos = [
      { key:'clopes', label:'Clopes', color:COLORS.clopes,   data:data.consos.clopes,   visible: State.visible.clopes!==false },
      { key:'joints', label:'Pétards',color:COLORS.joints,   data:data.consos.joints,   visible: State.visible.joints!==false },
      { key:'alcool', label:'Alcool', color:COLORS.alcool,   data:data.consos.alcool,   visible: State.visible.alcool!==false },
    ];
    const anyConso = hasPositive(data.consos.clopes) || hasPositive(data.consos.joints) || hasPositive(data.consos.alcool);

    // Séries coût/éco
    const ecoVisible = State.visible.economies!==false && hasPositive(data.economies);
    const sCoutEco = [
      { key:'cout',      label:'Coût',      color:COLORS.cout,      data:data.cout,      visible: State.visible.cout!==false },
      ecoVisible ? { key:'economies', label:'Économies', color:COLORS.economies, data:data.economies, visible:true } : null
    ].filter(Boolean);

    // Légende (globale sur les 2 charts)
    renderLegend([ ...sConsos, ...sCoutEco ]);

    // États vides
    if (emptyConsos()) emptyConsos().hidden = anyConso;
    if (emptyCout())   emptyCout().hidden   = hasPositive(data.cout) || ecoVisible;

    // Rendu charts
    let layout1=null, layout2=null;
    if (cConsos()){
      layout1 = drawLineChart(cConsos(), {
        labels: data.labels,
        series: sConsos,
        yFmt: (v)=> String(Math.round(v))
      });
      attachPointClick(cConsos(), layout1);
    }
    if (cCoutEco()){
      const euroFmt = (arr)=> (max(arr) < 100 ? nfEUR2 : nfEUR0);
      layout2 = drawLineChart(cCoutEco(), {
        labels: data.labels,
        series: sCoutEco,
        yFmt: (v)=> (euroFmt(data.cout).format(v))
      });
      attachPointClick(cCoutEco(), layout2);
    }

    ensureActions();
  }

  // ---- Hooks non destructifs ----
  function softHookUpdateAllUI(){
    try{
      const prev = window.updateAllUI;
      if (typeof prev === 'function' && !prev.__chartsHooked){
        const wrapped = function(){
          const r = prev.apply(this, arguments);
          try{ renderAll(); }catch(e){}
          return r;
        };
        wrapped.__chartsHooked = true;
        window.updateAllUI = wrapped;
      }
    }catch(e){}
  }

  // Re-render sur resize
  let resizeTimer=null;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(()=> renderAll(), 120);
  });

  // Init au chargement + hook
  function initCharts(){
    if (!elCharts()) return; // écran pas monté
    softHookUpdateAllUI();
    renderAll();
  }

  // Plusieurs tentatives d’init pour couvrir les navigations internes
  document.addEventListener('DOMContentLoaded', initCharts);
  // Si l’app navigue par hash / classes d’écran :
  setTimeout(initCharts, 300);
  setTimeout(initCharts, 1000);

  // Expose pour forcer un redraw depuis ailleurs si besoin
  window.StopAddictCharts.render = renderAll;
})();
</script>
<!-- === [FIN] Charts Render (v2.4.0) === -->
<!-- === HOTFIX charts + RAZ + copier logs (non destructif) === -->
<script>
(function(){
  // 1) (Affichage Stats) Re-rendu quand l’écran "stats" devient visible
  //    + re-rendu quand on change Jour/Semaine/Mois/Année
  function hookShowEcran(){
    try{
      const prev = window.showEcran;
      if (typeof prev === 'function' && !prev.__chartsHook2){
        window.showEcran = function(name){
          const r = prev.apply(this, arguments);
          try{
            if (name === 'stats' && window.StopAddictCharts){
              setTimeout(()=> window.StopAddictCharts.render?.(), 50);
              setTimeout(()=> window.StopAddictCharts.render?.(), 300);
            }
          }catch(e){}
          return r;
        };
        window.showEcran.__chartsHook2 = true;
      }
    }catch(e){}
  }
  function hookSetStatsView(){
    try{
      const prev = window.setStatsView;
      if (typeof prev === 'function' && !prev.__chartsHook2){
        window.setStatsView = function(v){
	  window.vueStats = v;              // <= ligne ajoutée
          const r = prev.apply(this, arguments);
          try{ window.StopAddictCharts?.render?.(); }catch(e){}
          return r;
        };
        window.setStatsView.__chartsHook2 = true;
      }
    }catch(e){}
  }
  function observeStatsSize(){
    try{
      const wrap = document.getElementById('stats-charts');
      if (!wrap || !window.StopAddictCharts) return;
      if (window.__saChartsRO) return;
      const ro = new ResizeObserver(()=> window.StopAddictCharts.render?.());
      ro.observe(wrap);
      window.__saChartsRO = ro;
    }catch(e){}
  }

  // 2) (Vue Jour) Si on a des timestamps mais pas de détail horaire,
  //    basculer intelligemment en "1 point = total du jour"
  function patchBuildSeriesFallbackJour(){
    try{
      if (!window.StopAddictCharts || window.StopAddictCharts.__patched) return;
      const orig = window.StopAddictCharts.buildSeriesForCurrentView;
      if (typeof orig !== 'function') return;
      window.StopAddictCharts.buildSeriesForCurrentView = function(){
        const data = orig.apply(this, arguments);
        try{
          /* fallback neutralisé */ else {
                data.economies = [];
              }
            }
          }
        }catch(e){}
        return data;
      };
      window.StopAddictCharts.__patched = true;
    }catch(e){}
  }

  // 3) (RAZ usine) étendre pour effacer Habitudes + Réglages/prix
  function hookRazu(){
    const tryAttach = ()=>{
      const btn = document.querySelector('#btn-raz-usine, [data-action="raz-usine"]');
      if (!btn) return false;
      if (btn.__saHooked) return true;
      btn.addEventListener('click', ()=>{
        setTimeout(()=>{ // après le RAZ existant
          try{
            // Efface clés usuelles sans rien casser si absentes
            const prefixes = [
              'donnees','habitudes','reglages','prix','tarifs','limits','limites',
              'objectifs','sa_','stopaddict_'
            ];
            for (let i=0;i<localStorage.length; i++){
              const k = localStorage.key(i);
              if (!k) continue;
              if (prefixes.some(p => k.toLowerCase().startsWith(p))){
                // ne supprime pas les clés système de l’appli si tu en as besoin
                localStorage.removeItem(k);
                i = -1; // redémarrer l’itération (taille modifiée)
              }
            }
          }catch(e){}
          try{ window.updateAllUI?.(); }catch(e){}
        }, 50);
      });
      btn.__saHooked = true;
      return true;
    };
    // réessaie plusieurs fois (DOM dynamique)
    let tries = 0;
    const iv = setInterval(()=>{
      if (tryAttach() || ++tries>20) clearInterval(iv);
    }, 200);
  }

  // 4) (Copier les logs) activer le bouton si présent
  function enableCopyLogs(){
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs"], #btn-copy-logs');
      if (!btn) return;
      try{
        const dbg = document.getElementById('debug-overlay') || document.querySelector('.debug-overlay');
        const txt = dbg ? (dbg.innerText || dbg.textContent || '') :
                   JSON.stringify({ donnees: (window.donnees||{}), vue: window.vueStats }, null, 2);
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(txt);
        } else {
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta); ta.select();
          document.execCommand('copy'); document.body.removeChild(ta);
        }
        (window.showSnackbar||console.log)('Logs copiés dans le presse-papiers.');
      }catch(e){
        console.error('Copy logs error', e);
      }
    }, {passive:true});
  }

  // Init
  function init(){
    hookShowEcran();
    hookSetStatsView();
    observeStatsSize();
    patchBuildSeriesFallbackJour();
    hookRazu();
    enableCopyLogs();
    // Si on arrive déjà sur Stats :
    if (document.getElementById('stats-charts')) {
      setTimeout(()=> window.StopAddictCharts?.render?.(), 80);
      setTimeout(()=> window.StopAddictCharts?.render?.(), 350);
    }
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
<!-- === /HOTFIX === -->
<script>
/* === PATCH #1 : placeholders visibles + exports désactivés quand vide === */
(function(){
  function hasPositive(arr){ return Array.isArray(arr) && arr.some(v => (+v||0) > 0); }

  function togglePlaceholders(){
    try{
      if (!window.StopAddictCharts || typeof window.StopAddictCharts.buildSeriesForCurrentView!=='function') return;
      const data = window.StopAddictCharts.buildSeriesForCurrentView();
      if (!data) return;

      const c1 = document.getElementById('chart-consommations');
      const c2 = document.getElementById('chart-cout-eco');
      const e1 = document.getElementById('empty-consos');
      const e2 = document.getElementById('empty-cout');
      const bar = document.getElementById('chart-actions');

      const hasConso = hasPositive(data?.consos?.clopes) || hasPositive(data?.consos?.joints) || hasPositive(data?.consos?.alcool);
      const hasCost  = hasPositive(data?.cout);
      const hasEco   = hasPositive(data?.economies);

      if (c1 && e1){ c1.hidden = !hasConso; e1.hidden = !!hasConso; }
      if (c2 && e2){ const show2 = hasCost || hasEco; c2.hidden = !show2; e2.hidden = !!show2; }

      if (bar){
        const btns = bar.querySelectorAll('.btn');
        if (btns[0]) btns[0].disabled = !hasConso;        // Export conso
        if (btns[1]) btns[1].disabled = !(hasCost||hasEco); // Export coût/éco
      }
    }catch(e){ /* no-op */ }
  }

  // on hook le render existant pour appliquer le toggle après chaque tracé
  function hookRender(){
    try{
      const prev = window.StopAddictCharts && window.StopAddictCharts.render;
      if (typeof prev === 'function' && !prev.__patchPlaceholders){
        window.StopAddictCharts.render = function(){
          const r = prev.apply(this, arguments);
          togglePlaceholders();
          return r;
        };
        window.StopAddictCharts.render.__patchPlaceholders = true;
      }
    }catch(e){}
  }

  // init
  function init(){
    hookRender();
    // 2 appels espacés couvrent le temps que l’écran Stats se monte
    setTimeout(togglePlaceholders, 120);
    setTimeout(togglePlaceholders, 400);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  } else { init(); }
})();
</script>
<script>
/* === PATCH Étape 2/4 — graphes visibles (local keys + min-height) & copier logs robuste === */
(function(){

  /* 0) CSS injecté : s’assure d’une hauteur lisible du canvas + légende disabled */
  try{
    const css = `
      #stats-charts canvas{min-height:220px}
      #stats-charts .legend-item.is-disabled{opacity:.45; pointer-events:none}
      #stats-charts .chart-actions .btn[disabled]{opacity:.5; pointer-events:none}
    `;
    const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
  }catch(e){}

  /* 1) Semaine basée LUNDI (pour aligner l’appli et les graphes) */
  window.startOfWeek = function(d){
    const x=new Date(d); x.setHours(0,0,0,0);
    const dow = (x.getDay()+6)%7; // Lundi=0
    x.setDate(x.getDate()-dow);
    return x;
  };
  window.endOfWeek = function(d){
    const s=window.startOfWeek(d); const e=new Date(s);
    e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e;
  };
  window.startOfMonth = function(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); };
  window.endOfMonth   = function(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); };
  window.startOfYear  = function(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); };
  window.endOfYear    = function(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); };

  /* 2) Utilitaires LOCAL-KEYS (évite le décalage UTC) */
  function keyLocal(d){
    const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }
  function keysBetweenLocal(d1,d2){
    const out=[]; const s=new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(),0,0,0,0);
    const e=new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(),23,59,59,999);
    for(let t=new Date(s); t<=e; t=new Date(t.getTime()+86400000)){
      out.push(keyLocal(t));
    }
    return out;
  }

  /* 3) Recalcule entièrement les séries avec CLÉS LOCALES (remplace l’ancien builder) */
  function overrideBuildSeries(){
    const NS = window.StopAddictCharts; if(!NS) return;
    const refFor = NS.referenceParJourPourDate;
    // Remplace le builder
    NS.buildSeriesForCurrentView = function(){
      const now = new Date();
      let type = window.vueStats || 'mois';
      let d1,d2, granularity;
      if (type==='jour'){
        d1=new Date(now); d1.setHours(0,0,0,0);
        d2=new Date(now); d2.setHours(23,59,59,999);
        granularity='day'; // fallback 1 point si pas d’horaires
      } else if (type==='semaine'){
        d1=window.startOfWeek(now); d2=window.endOfWeek(now); granularity='day';
      } else if (type==='mois'){
        d1=window.startOfMonth(now); d2=window.endOfMonth(now); granularity='day';
      } else {
        d1=window.startOfYear(now); d2=window.endOfYear(now); granularity='month'; type='annee';
      }

      function getRec(k){ return (window.donnees||{})[k] || null; }
      function totC(r){ if(!r) return 0; return (r.cl_class||0)+(r.cl_roul||0)+(r.cl_tube||0); }
      function totA(r){ if(!r) return 0; return (r.alc_biere||0)+(r.alc_fort||0)+(r.alc_liqueur||0); }
      function joints(r){ return (r?.joints||0); }
      function coutKey(k){ const r=getRec(k); return r ? (+((window.calculerCoutJour(r)||0))) : 0; }

      const labels=[], cl=[], jo=[], al=[], cout=[], eco=[];

      if (type==='annee'){
        const year = d1.getFullYear();
        for (let m=0;m<12;m++){
          const mStart = new Date(year,m,1,0,0,0,0), mEnd = new Date(year,m+1,0,23,59,59,999);
          const ks = keysBetweenLocal(mStart,mEnd);
          let C=0,J=0,A=0, CO=0, EC=0;
          for (const k of ks){
            const r=getRec(k); C+=totC(r); J+=joints(r); A+=totA(r);
            const c=coutKey(k); CO+=c;
            const ref = refFor ? refFor(new Date(k)) : null;
            if (ref!=null) EC += Math.max(ref - c, 0);
          }
          labels.push(new Date(year,m,1).toLocaleString('fr-FR',{month:'short'}));
          cl.push(C); jo.push(J); al.push(A); cout.push(+CO.toFixed(2)); eco.push(+EC.toFixed(2));
        }
      } else if (type==='jour'){
        const k = keyLocal(now);
        const r=getRec(k);
        labels.push('Aujourd’hui');
        cl.push(totC(r)); jo.push(joints(r)); al.push(totA(r));
        const co = coutKey(k); cout.push(+co.toFixed(2));
        const ref = refFor ? refFor(now) : null;
        if (ref!=null) eco.push(Math.max(+ref - co, 0));
      } else {
        // semaine / mois — par jour
        const ks = keysBetweenLocal(d1,d2);
        const ref = refFor ? refFor(now) : null;
        for (const k of ks){
          const r=getRec(k);
          cl.push(totC(r)); jo.push(joints(r)); al.push(totA(r));
          const co = coutKey(k); cout.push(+co.toFixed(2));
          if (ref!=null) eco.push(Math.max(+ref - co, 0));
          labels.push(k.slice(5)); // MM-DD
        }
      }

      return { labels, consos:{clopes:cl, joints:jo, alcool:al}, cout, economies:eco };
    };
  }

  /* 4) Forcer un re-render propre + masquer exports si vide */
  function afterRenderToggle(){
  // Option simple: en vue Jour avec fallback 1 point, masquer les rubans/vides horaires
  try{
    const vue = (window.vueStats || 'jour');
    const d = window.StopAddictCharts?.buildSeriesForCurrentView?.();
    if (vue==='jour' && d && Array.isArray(d.labels) && d.labels.length===1){
      const hBands = document.querySelectorAll('[data-hour-ribbon], .hour-ribbon, .hours-band');
      hBands.forEach(el => el.style.display='none');
      const empties = [document.getElementById('empty-consos'), document.getElementById('empty-cout')];
      empties.forEach(el => { if (el) el.hidden = true; });
    }
  }catch(_){}

    function hasPos(a){ return Array.isArray(a) && a.some(v => (+v||0)>0); }
    const data = window.StopAddictCharts?.buildSeriesForCurrentView?.(); if (!data) return;
    const c1 = document.getElementById('chart-consommations');
    const c2 = document.getElementById('chart-cout-eco');
    const e1 = document.getElementById('empty-consos');
    const e2 = document.getElementById('empty-cout');
    const bar= document.getElementById('chart-actions');
    const show1 = hasPos(data.consos?.clopes)||hasPos(data.consos?.joints)||hasPos(data.consos?.alcool);
    const show2 = hasPos(data.cout)||hasPos(data.economies);
    if (c1&&e1){ c1.hidden=!show1; e1.hidden=!!show1; }
    if (c2&&e2){ c2.hidden=!show2; e2.hidden=!!show2; }
    if (bar){
      const b=bar.querySelectorAll('.btn');
      if (b[0]) b[0].disabled = !show1;
      if (b[1]) b[1].disabled = !show2;
    }
  }
  function hookRender(){
    const prev = window.StopAddictCharts?.render;
    if (typeof prev === 'function' && !prev.__afterToggle){
      window.StopAddictCharts.render = function(){
        const r = prev.apply(this, arguments);
        try{ afterRenderToggle(); }catch(e){}
        return r;
      };
      window.StopAddictCharts.render.__afterToggle = true;
    }
  }

  /* 5) Copier les logs — fallback PROMPT si writeText échoue */
  function robustCopyLogs(){
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs"], #btn-copy-logs');
      if (!btn) return;
      try{
        const dbg = document.getElementById('debug-overlay') || document.querySelector('.debug-overlay');
        const txt = dbg ? (dbg.innerText || dbg.textContent || '') :
                   JSON.stringify({ donnees:(window.donnees||{}), vue:window.vueStats }, null, 2);

        let ok = false;
        if (navigator.clipboard && navigator.clipboard.writeText){
          try{ await navigator.clipboard.writeText(txt); ok = true; }catch(e){}
        }
        if (!ok){
          try{
            const ta = document.createElement('textarea');
            ta.value = txt; document.body.appendChild(ta); ta.select();
            ok = document.execCommand('copy'); document.body.removeChild(ta);
          }catch(e){}
        }
        if (!ok){
          // Dernier recours pour Android (content://) : prompt avec long-press pour copier
          window.prompt('Copiez le texte ci-dessous (long-press puis Copier) :', txt);
        } else {
          (window.showSnackbar||console.log)('Logs copiés dans le presse-papiers.');
        }
      }catch(e){}
    }, {passive:true});
  }

  /* 6) Init */
  function init(){
    overrideBuildSeries();
    hookRender();
    robustCopyLogs();
    setTimeout(()=> window.StopAddictCharts?.render?.(), 100);
    setTimeout(()=> window.StopAddictCharts?.render?.(), 400);
  }
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init); else init();

})();
</script>
<script>
/* === PATCH Étape 3/4 — emoji + légende persistante + alignement arrondis + copier logs (robuste) === */
(function(){
  /* 0) Fix global — accepte Math.max([a,b,c]) (corrige le bug .ratios) */
  (function(){
    const __origMax = Math.max;
    if (!__origMax.__acceptArray){
      Math.max = function(...args){
        if (args.length===1 && Array.isArray(args[0])) {
          try { return __origMax.apply(Math, args[0]); } catch(e){ return NaN; }
        }
        return __origMax.apply(Math, args);
      };
      Math.max.__acceptArray = true;
    }
  })();

  /* 1) Légende persistante (garde “Économies” même si vide, grise si indisponible) */
  function persistLegend(){
    const box = document.getElementById('chart-legend');
    if (!box || !window.StopAddictCharts) return;
    const data = window.StopAddictCharts.buildSeriesForCurrentView?.();
    if (!data) return;

    const hasPos = arr => Array.isArray(arr) && arr.some(v => (+v||0)>0);

    const defs = [
      { key:'clopes',    label:'Clopes',    color:'#6b7280', present:hasPos(data?.consos?.clopes) },
      { key:'joints',    label:'Pétards',   color:'#10b981', present:hasPos(data?.consos?.joints) },
      { key:'alcool',    label:'Alcool',    color:'#f59e0b', present:hasPos(data?.consos?.alcool) },
      { key:'cout',      label:'Coût',      color:'#7c3aed', present:hasPos(data?.cout) },
      { key:'economies', label:'Économies', color:'#2563eb', present:hasPos(data?.economies) },
    ];

    const vis = (window.StopAddictChartsState = window.StopAddictChartsState || { visible:{} }).visible;
    box.innerHTML = '';
    defs.forEach(s=>{
      const item = document.createElement('div');
      item.className = 'legend-item' + ((vis[s.key]===false)?' is-muted':'') + (s.present?'':' is-disabled');
      item.setAttribute('role','button');
      item.dataset.key = s.key;

      const sw = document.createElement('span'); sw.className='legend-swatch'; sw.style.background=s.color;
      const lab= document.createElement('span'); lab.textContent=s.label;
      item.appendChild(sw); item.appendChild(lab);

      item.addEventListener('click', ()=>{
        if (!s.present) return; // grisé = non cliquable
        vis[s.key] = !(vis[s.key]!==false);
        item.classList.toggle('is-muted', vis[s.key]===false);
        window.StopAddictCharts.render?.();
      });
      box.appendChild(item);
    });
  }
  function hookLegend(){
    const prev = window.StopAddictCharts && window.StopAddictCharts.render;
    if (typeof prev==='function' && !prev.__legendPersist){
      window.StopAddictCharts.render = function(){
        const r = prev.apply(this, arguments);
        try{ persistLegend(); }catch(e){}
        return r;
      };
      window.StopAddictCharts.render.__legendPersist = true;
    }
  }

  /* 2) Alignement Mois/Année côté graphes : pas d’arrondi anticipé */
  function patchBuilderNoRounding(){
    const NS = window.StopAddictCharts; if (!NS) return;
    const old = NS.buildSeriesForCurrentView;
    if (typeof old!=='function' || old.__noRoundPatched) return;
    NS.buildSeriesForCurrentView = function(){
      const d = old.apply(this, arguments);
      // Garantit des nombres “bruts”
      if (Array.isArray(d.cout))      d.cout      = d.cout.map(v => +(+v||0));
      if (Array.isArray(d.economies)) d.economies = d.economies.map(v => +(+v||0));
      return d;
    };
    NS.buildSeriesForCurrentView.__noRoundPatched = true;
  }

  /* 3) Copier les logs — capture + fallback et évite le popup d’erreur */
  function overrideCopyLogs(){
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs"], #btn-copy-logs');
      if (!btn) return;
      ev.preventDefault(); ev.stopPropagation(); // on bloque le handler natif qui affiche l’alerte
      try{
        const dbg = document.getElementById('debug-overlay') || document.querySelector('.debug-overlay');
        const txt = dbg ? (dbg.innerText || dbg.textContent || '') :
                   JSON.stringify({ donnees:(window.donnees||{}), vue:window.vueStats }, null, 2);
        let ok = false;
        if (navigator.clipboard && navigator.clipboard.writeText){
          try{ await navigator.clipboard.writeText(txt); ok = true; }catch(e){}
        }
        if (!ok){
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta); ta.select();
          try{ ok = document.execCommand('copy'); }catch(e){}
          document.body.removeChild(ta);
        }
        if (!ok){
          window.prompt('Copiez le texte ci-dessous (long-press puis Copier) :', txt);
        } else {
          (window.showSnackbar||console.log)('Logs copiés dans le presse-papiers.');
        }
      }catch(e){}
    }, true); // capture
  }

  /* 4) Init */
  function init(){
    hookLegend();
    patchBuilderNoRounding();
    overrideCopyLogs();
    setTimeout(()=> window.StopAddictCharts?.render?.(), 80);
    setTimeout(()=> window.StopAddictCharts?.render?.(), 350);
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();
})();
</script>
<script>
/* === PATCH Étape 4/4 — bornes périodes unifiées + rendu lisible + journal complet === */
(function(){

  /* 1) BORNES PÉRIODE — unifie partout (y compris bandeau vert) en LOCAL TIME */
  function keyLocal(d){
    return [
      d.getFullYear(),
      String(d.getMonth()+1).padStart(2,'0'),
      String(d.getDate()).padStart(2,'0')
    ].join('-');
  }
  // (ré)expose ces helpers pour que tout le code existant les réutilise
  window.startOfWeek = function(d){
    const x=new Date(d); x.setHours(0,0,0,0);
    const dow=(x.getDay()+6)%7; // Lundi=0
    x.setDate(x.getDate()-dow);
    return x;
  };
  window.endOfWeek = function(d){ const s=startOfWeek(d), e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; };
  window.startOfMonth = function(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); };
  window.endOfMonth   = function(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); };
  window.startOfYear  = function(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); };
  window.endOfYear    = function(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); };

  // Forcer dateKey() et listKeysBetween() en LOCAL (si l’app les utilise)
  window.dateKey = function(d){ return keyLocal(d || new Date()); };
  window.listKeysBetween = function(d1,d2){
    const out=[]; const s=new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(),0,0,0,0);
    const e=new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(),23,59,59,999);
    for(let t=new Date(s); t<=e; t=new Date(t.getTime()+86400000)){ out.push(keyLocal(t)); }
    return out;
  };

  /* 2) JOURNAL COMPLET — capture console + navigations + clics clés */
  (function setupLogger(){
    const buf = (window.__saLogBuffer = window.__saLogBuffer || []);
    const ts  = ()=> new Date().toISOString().replace('T',' ').replace('Z','');
    function push(kind, msg){ try{ buf.push(`[${ts()}] ${kind}: ${msg}`); if (buf.length>5000) buf.shift(); }catch(e){} }

    // Monkey patch console
    ['log','info','warn','error'].forEach(fn=>{
      const prev = console[fn];
      if (!prev || prev.__saPatched) return;
      console[fn] = function(){ try{ push(fn.toUpperCase(), Array.from(arguments).map(x=>typeof x==='string'?x:JSON.stringify(x)).join(' ')); }catch(e){}; return prev.apply(console, arguments); };
      console[fn].__saPatched = true;
    });

    // Hooks de navigation/onglets
    (function hook(name){
      const prev = window[name];
      if (typeof prev==='function' && !prev.__saPatched){
        window[name] = function(){
          push('EVENT', `${name}(${Array.from(arguments).map(String).join(',')})`);
          return prev.apply(this, arguments);
        };
        window[name].__saPatched = true;
      }
    })('showEcran');
    (function hook(name){
      const prev = window[name];
      if (typeof prev==='function' && !prev.__saPatched){
        window[name] = function(){
          push('EVENT', `${name}(${Array.from(arguments).map(String).join(',')})`);
          return prev.apply(this, arguments);
        };
        window[name].__saPatched = true;
      }
    })('setStatsView');

    // Clics clés (boutons de RAZ / export / graphs)
    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest('button, [role="button"], a, .legend-item');
      if (!el) return;
      const lab = (el.innerText||el.textContent||'').trim().slice(0,60);
      const act = el.getAttribute('data-action') || el.id || el.className;
      push('CLICK', `${lab}  — ${act}`);
    }, true);

    // Bouton "Copier les logs" -> renvoie le buffer complet + vue + quelques compteurs
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs"], #btn-copy-logs');
      if (!btn) return;
      ev.preventDefault(); ev.stopPropagation();
      try{
        const payload = {
          vue: window.vueStats,
          taille_donnees: Object.keys(window.donnees||{}).length,
          memoire_logs: buf.length,
          extraits: buf.slice(-500) // suffisant et léger
        };
        const text = JSON.stringify(payload, null, 2);
        let ok=false;
        if (navigator.clipboard && navigator.clipboard.writeText){
          try{ await navigator.clipboard.writeText(text); ok=true; }catch(e){}
        }
        if (!ok){
          const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
          try{ ok=document.execCommand('copy'); }catch(e){}
          document.body.removeChild(ta);
        }
        if (!ok){ window.prompt('Copiez (long-press) :', text); }
        (window.showSnackbar||console.log)(ok?'Logs copiés.':'Logs affichés.');
      }catch(e){}
    }, true);
  })();

  /* 3) GRAPHIQUES — “jolis & lisibles” (lignes épaisses, X = jour du mois, 6 labels max) */
  function prettyDraw(canvas, cfg){
    const ctx = canvas.getContext('2d'); if (!ctx) return;
    // Ajuste la résolution au DPR
    const dpr = Math.max(1, window.devicePixelRatio||1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(320, Math.round(rect.width * dpr));
    canvas.height= Math.max(220, Math.round(rect.height* dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = rect.width, H = rect.height;
    const PAD = { l: 44, r: 10, t: 12, b: 26 };
    ctx.clearRect(0,0,W,H);

    // Labels X “courts”
    const rawLabels = cfg.labels || [];
    const labels = rawLabels.map(s => /^\d{2}-\d{2}$/.test(s) ? s.slice(3) : s); // "MM-DD" -> "DD"
    const series = (cfg.series||[]).filter(s=>s && s.visible!==false && s.data && s.data.length===labels.length);

    const yMax = Math.max(1, ...series.map(s => s.data.reduce((m,v)=>Math.max(m, +v||0), 0)));
    // Pas jolis (≈ 5 lignes)
    const steps = [1,2,5];
    const pow = Math.pow(10, Math.floor(Math.log10(yMax||1)));
    let yStep = steps.find(s => (s*pow)>= yMax/4) * pow;
    if (!yStep) yStep = pow;
    const yAxisMax = Math.ceil(yMax / yStep) * yStep;

    const X0=PAD.l, X1=W-PAD.r, Y0=H-PAD.b, Y1=PAD.t;
    const n = Math.max(1, labels.length-1);
    const xAt = i => (n===0? (X0+X1)/2 : X0 + (i*(X1-X0)/n));
    const yAt = v => Y0 - ( (v/(yAxisMax||1))*(Y0-Y1) );

    // Grille Y
    ctx.strokeStyle = '#e5e7eb'; ctx.fillStyle='#6b7280'; ctx.lineWidth=1;
    ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto';
    for (let y=0;y<=yAxisMax;y+=yStep){
      const yy=yAt(y); ctx.beginPath(); ctx.moveTo(X0,yy); ctx.lineTo(X1,yy); ctx.stroke();
      const txt = cfg.yFmt ? cfg.yFmt(y) : String(y);
      ctx.fillText(txt, 4, yy-2);
    }

    // Labels X (6 max)
    const maxX = Math.min(6, labels.length);
    const stepX = Math.max(1, Math.floor(labels.length / maxX));
    ctx.fillStyle='#374151';
    for (let i=0;i<labels.length;i+=stepX){
      const xx = xAt(i); ctx.fillText(labels[i], xx-8, H-6);
    }

    // Lignes
    for (const s of series){
      ctx.strokeStyle = s.color || '#111';
      ctx.lineWidth = 2.4;
      ctx.beginPath();
      for (let i=0;i<labels.length;i++){
        const x=xAt(i), y=yAt(+s.data[i]||0);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
      // Points discrets
      ctx.fillStyle = s.color || '#111';
      for (let i=0;i<labels.length;i++){
        const x=xAt(i), y=yAt(+s.data[i]||0);
        ctx.beginPath(); ctx.arc(x,y,1.6,0,Math.PI*2); ctx.fill();
      }
    }

    // Retourne mapping x->index pour le clic calendrier
    return { xAt, labelsCount: labels.length, xStart:X0, xEnd:X1 };
  }

  // Remplace le rendu précédent par un rendu “pretty”, sans changer l’ergonomie
  function installPrettyRender(){
    const NS = window.StopAddictCharts; if (!NS) return;
    const prev = NS.render;
    if (typeof prev!=='function' || prev.__prettyPatched) return;

    NS.render = function(){
      // Données
      const data = NS.buildSeriesForCurrentView?.(); if (!data) return;
      const COLORS = { clopes:'#6b7280', joints:'#10b981', alcool:'#f59e0b', cout:'#7c3aed', economies:'#2563eb' };
      // Conso
      const c1 = document.getElementById('chart-consommations');
      if (c1){
        const layout1 = prettyDraw(c1, {
          labels: data.labels,
          series: [
            {key:'clopes',    color:COLORS.clopes,    data:data.consos?.clopes,   visible:(window.StopAddictChartsState?.visible?.clopes!==false)},
            {key:'joints',    color:COLORS.joints,    data:data.consos?.joints,   visible:(window.StopAddictChartsState?.visible?.joints!==false)},
            {key:'alcool',    color:COLORS.alcool,    data:data.consos?.alcool,   visible:(window.StopAddictChartsState?.visible?.alcool!==false)}
          ],
          yFmt: (v)=> String(Math.round(v))
        });
        // Clic → Calendrier (approx. index le plus proche)
        c1.onclick = (ev)=>{
          const rect=c1.getBoundingClientRect(), x=ev.clientX-rect.left;
          const n=layout1.labelsCount-1; if (n<0) return;
          const t=(x-layout1.xStart)/(layout1.xEnd-layout1.xStart);
          const i=Math.max(0,Math.min(n, Math.round(t*n)));
          try{
            const now = new Date(); let d1,d2, type=window.vueStats||'mois';
            if (type==='semaine'){ d1=startOfWeek(now); d2=endOfWeek(now); }
            else if (type==='mois'){ d1=startOfMonth(now); d2=endOfMonth(now); }
            else if (type==='annee'){ d1=startOfYear(now); d2=endOfYear(now); }
            const keys = (type==='annee')
              ? Array.from({length:12},(_,m)=> keyLocal(new Date(d1.getFullYear(),m,1)))
              : window.listKeysBetween(d1,d2);
            const k = keys[i]; if (!k) return;
            if (typeof window.showEcran==='function') window.showEcran('calendrier');
            if (typeof window.focusCalendrierDate==='function') window.focusCalendrierDate(k);
            else if (typeof window.setCalendarFocusDate==='function') window.setCalendarFocusDate(k);
          }catch(e){}
        };
      }
      // Coût & Économies
      const c2 = document.getElementById('chart-cout-eco');
      if (c2){
        const euroFmt = (arr)=> ( (arr||[]).reduce((m,v)=>Math.max(m,+v||0),0) < 100 ? new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2})
                                                                               : new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}) );
        const fmt = euroFmt(data.cout);
        prettyDraw(c2, {
          labels: data.labels,
          series: [
            {key:'cout',      color:COLORS.cout,      data:data.cout,      visible:(window.StopAddictChartsState?.visible?.cout!==false)},
            {key:'economies', color:COLORS.economies, data:data.economies, visible:(window.StopAddictChartsState?.visible?.economies!==false)}
          ],
          yFmt: (v)=> fmt.format(v)
        });
      }

      // Placeholders & légende (recalcule après notre rendu)
      try{
        const hasPos = a => Array.isArray(a) && a.some(v => (+v||0)>0);
        const e1=document.getElementById('empty-consos'), e2=document.getElementById('empty-cout');
        if (c1 && e1){ const show1 = hasPos(data.consos?.clopes)||hasPos(data.consos?.joints)||hasPos(data.consos?.alcool); c1.hidden=!show1; e1.hidden=!!show1; }
        if (c2 && e2){ const show2 = hasPos(data.cout)||hasPos(data.economies); c2.hidden=!show2; e2.hidden=!!show2; }

        // Légende persistante (économies visible mais grisée si vide)
        const box=document.getElementById('chart-legend'); if (box){
          const vis=(window.StopAddictChartsState=window.StopAddictChartsState||{visible:{}}).visible;
          box.innerHTML='';
          [
            {k:'clopes',l:'Clopes',c:'#6b7280',p:hasPos(data.consos?.clopes)},
            {k:'joints',l:'Pétards',c:'#10b981',p:hasPos(data.consos?.joints)},
            {k:'alcool',l:'Alcool',c:'#f59e0b',p:hasPos(data.consos?.alcool)},
            {k:'cout',l:'Coût',c:'#7c3aed',p:hasPos(data.cout)},
            {k:'economies',l:'Économies',c:'#2563eb',p:hasPos(data.economies)},
          ].forEach(s=>{
            const it=document.createElement('div');
            it.className='legend-item'+(vis[s.k]===false?' is-muted':'')+(s.p?'':' is-disabled');
            it.setAttribute('role','button'); it.dataset.key=s.k;
            const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=s.c;
            const lb=document.createElement('span'); lb.textContent=s.l;
            it.appendChild(sw); it.appendChild(lb);
            it.addEventListener('click',()=>{ if(!s.p) return; vis[s.k]=!(vis[s.k]!==false); it.classList.toggle('is-muted', vis[s.k]===false); NS.render(); });
            box.appendChild(it);
          });
        }

        // Actions export: active seulement si données
        const bar=document.getElementById('chart-actions'); if (bar){
          const b=bar.querySelectorAll('.btn');
          if (b[0]) b[0].disabled = !(hasPos(data.consos?.clopes)||hasPos(data.consos?.joints)||hasPos(data.consos?.alcool));
          if (b[1]) b[1].disabled = !(hasPos(data.cout)||hasPos(data.economies));
        }
      }catch(e){}
    };
    NS.render.__prettyPatched = true;
  }

  /* 4) Init : installe le rendu lisible et relance les UI pour recalculer le bandeau vert */
  function init(){
    installPrettyRender();
    try{ window.updateAllUI?.(); }catch(e){}
    setTimeout(()=> window.StopAddictCharts?.render?.(), 60);
    setTimeout(()=> window.StopAddictCharts?.render?.(), 300);
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', init); else init();

})();
</script>
<script>
/* === FIX global — dates locales, périodes, graphes lisibles, logs verbeux (v2.4.final) === */
(function(){
  /* -- A) UTIL DATES LOCALES *sans* UTC (évite 31/01) -- */
  function keyLocal(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
  function parseKeyLocal(k){
    if (k instanceof Date) return new Date(k.getFullYear(), k.getMonth(), k.getDate(), 12,0,0,0);
    const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(String(k)||''); if (!m) return new Date();
    return new Date(+m[1], +m[2]-1, +m[3], 12,0,0,0); // midi local (anti-DST)
  }
  function startOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); return x; }
  function endOfWeek(d){ const s=startOfWeek(d), e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
  function startOfYear(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
  function endOfYear(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }
  function keysBetweenLocal(d1,d2){
    const out=[]; const s=new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(),0,0,0,0);
    const e=new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(),23,59,59,999);
    for(let t=new Date(s); t<=e; t=new Date(t.getTime()+86400000)) out.push(keyLocal(t));
    return out;
  }
  // Expose pour que le reste de l’app les réutilise
  window.dateKey = ()=> keyLocal(new Date());
  window.listKeysBetween = keysBetweenLocal;
  window.startOfWeek = startOfWeek; window.endOfWeek = endOfWeek;
  window.startOfMonth = startOfMonth; window.endOfMonth = endOfMonth;
  window.startOfYear = startOfYear; window.endOfYear = endOfYear;

  /* -- B) LOGS *très* verbeux (clics + inputs + calculs + périodes) -- */
  const SA_LOG = (function(){
    const buf = window.__saLogBuffer = window.__saLogBuffer || [];
    const ts = ()=> new Date().toISOString().replace('T',' ').replace('Z','');
    function push(kind, obj){
      try{
        const line = `[${ts()}] ${kind}: ` + (typeof obj==='string' ? obj : JSON.stringify(obj));
        buf.push(line); if (buf.length>8000) buf.shift();
      }catch(e){}
    }
    // Capture console
    ['log','info','warn','error'].forEach(fn=>{
      const prev = console[fn]; if (!prev || prev.__saPatched) return;
      console[fn] = function(){ try{ push(fn.toUpperCase(), Array.from(arguments)); }catch(e){}; return prev.apply(console, arguments); };
      console[fn].__saPatched = true;
    });
    // Clics
    document.addEventListener('click', (ev)=>{
      const el = ev.target.closest('button,[role="button"],a,input,select,.legend-item');
      if (!el) return;
      push('CLICK', {
        tag: el.tagName, id: el.id||null, cls: el.className||null,
        action: el.getAttribute('data-action')||null,
        text: (el.innerText||el.textContent||'').trim().slice(0,60)
      });
    }, true);
    // Inputs
    document.addEventListener('change', (ev)=>{
      const el=ev.target; if (!el) return;
      if (el.matches('input,select,textarea')){
        push('CHANGE', {id:el.id||null, name:el.name||null, val:el.value||el.checked||null});
      }
    }, true);
    // Copier les logs (écrase les anciens handlers avec capture + stopImmediate)
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs"], #btn-copy-logs'); if (!btn) return;
      ev.preventDefault(); ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation();
      const payload = {
        vue: window.vueStats,
        jours_en_memoire: Object.keys(window.donnees||{}).length,
        derniers_evenements: (window.__saLogBuffer||[]).slice(-600)
      };
      const text = JSON.stringify(payload, null, 2);
      let ok=false;
      if (navigator.clipboard?.writeText){ try{ await navigator.clipboard.writeText(text); ok=true; }catch(e){} }
      if (!ok){
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ ok=document.execCommand('copy'); }catch(e){}
        document.body.removeChild(ta);
      }
      if (!ok) window.prompt('Copiez (long-press) :', text);
      (window.showSnackbar||console.log)(ok?'Logs copiés.':'Logs affichés.');
    }, true);
    return { push };
  })();

  /* -- C) BUILDER GRAPHIQUES — recalcule proprement par période locale -- */
  function rebuildSeries(){
    try{
      const now=new Date(); let type=window.vueStats||'mois';
      let d1,d2, labels=[], C=[], J=[], A=[], CO=[], EC=[];
      const data=window.donnees||{};
      function rec(k){ return data[k]||null; }
      function totCl(r){ return (r?.cl_class||0)+(r?.cl_roul||0)+(r?.cl_tube||0); }
      function totAl(r){ return (r?.alc_biere||0)+(r?.alc_fort||0)+(r?.alc_liqueur||0); }
      function joints(r){ return (r?.joints||0); }
      function coutJour(k){ const r=rec(k); return r ? +((window.calculerCoutJour?.(r)||0)) : 0; }

      if (type==='jour'){
        const k = keyLocal(now);
        labels=['Aujourd’hui']; C=[totCl(rec(k))]; J=[joints(rec(k))]; A=[totAl(rec(k))];
        const co=coutJour(k); CO=[+co.toFixed(2)];
        const ref=window.StopAddictCharts?.referenceParJourPourDate?.(parseKeyLocal(k));
        EC = (ref!=null) ? [ Math.max(+ref - co, 0) ] : [];
      } else if (type==='semaine'){
        d1=startOfWeek(now); d2=endOfWeek(now);
        const ks = keysBetweenLocal(d1,d2);
        const ref=window.StopAddictCharts?.referenceParJourPourDate?.(now);
        ks.forEach(k=>{
          labels.push(k.slice(5)); C.push(totCl(rec(k))); J.push(joints(rec(k))); A.push(totAl(rec(k)));
          const co=coutJour(k); CO.push(+co.toFixed(2)); if (ref!=null) EC.push(Math.max(+ref-co,0));
        });
      } else if (type==='mois'){
        d1=startOfMonth(now); d2=endOfMonth(now);
        const ks = keysBetweenLocal(d1,d2);
        const ref=window.StopAddictCharts?.referenceParJourPourDate?.(now);
        ks.forEach(k=>{
          labels.push(k.slice(5)); C.push(totCl(rec(k))); J.push(joints(rec(k))); A.push(totAl(rec(k)));
          const co=coutJour(k); CO.push(+co.toFixed(2)); if (ref!=null) EC.push(Math.max(+ref-co,0));
        });
      } else { // annee
        d1=startOfYear(now); d2=endOfYear(now);
        for(let m=0;m<12;m++){
          const m1=new Date(d1.getFullYear(),m,1,0,0,0,0), m2=new Date(d1.getFullYear(),m+1,0,23,59,59,999);
          const ks=keysBetweenLocal(m1,m2); let c=0,j=0,a=0,co=0,ec=0;
          ks.forEach(k=>{ const r=rec(k); c+=totCl(r); j+=joints(r); a+=totAl(r); const cj=coutJour(k); co+=cj;
            const ref=window.StopAddictCharts?.referenceParJourPourDate?.(parseKeyLocal(k)); if (ref!=null) ec += Math.max(+ref-cj,0);
          });
          labels.push(new Date(d1.getFullYear(),m,1).toLocaleString('fr-FR',{month:'short'}));
          C.push(c); J.push(j); A.push(a); CO.push(+co.toFixed(2)); EC.push(+ec.toFixed(2));
        }
        type='annee';
      }

      const out={ labels, consos:{clopes:C, joints:J, alcool:A}, cout:CO, economies:EC };
      SA_LOG.push('SERIES', {type:window.vueStats||'mois', d1:keyLocal(d1||now), d2:keyLocal(d2||now), points:labels.length,
                              sumC:C.reduce((s,x)=>s+(+x||0),0), sumJ:J.reduce((s,x)=>s+(+x||0),0),
                              sumA:A.reduce((s,x)=>s+(+x||0),0), sumCO:CO.reduce((s,x)=>s+(+x||0),0), sumEC:EC.reduce((s,x)=>s+(+x||0),0)});
      return out;
    }catch(e){ SA_LOG.push('ERROR_BUILD', String(e)); return null; }
  }

  // branche sur l’espace charts
function installBuilder(){
  if(!window.StopAddictCharts) window.StopAddictCharts = {};
  if (typeof window.StopAddictCharts.buildSeriesForCurrentView !== 'function') {
    window.StopAddictCharts.buildSeriesForCurrentView = rebuildSeries;
  }
}

  /* -- D) Rendu lisible (allégé) -- */
  function prettyDraw(canvas, cfg){
    const dpr=Math.max(1,window.devicePixelRatio||1), rect=canvas.getBoundingClientRect();
    canvas.width=Math.max(340, Math.round(rect.width*dpr)); canvas.height=Math.max(220, Math.round(220*dpr));
    const ctx=canvas.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0);
    const W=rect.width, H=220, PAD={l:44,r:10,t:12,b:26};
    const X0=PAD.l,X1=W-PAD.r,Y0=H-PAD.b,Y1=PAD.t;
    ctx.clearRect(0,0,W,H);
    const labels=cfg.labels||[];
    const series=(cfg.series||[]).filter(s=>s&&s.visible!==false&&s.data&&s.data.length===labels.length);
    const yMax = Math.max(1, ...series.map(s => s.data.reduce((m,v)=>Math.max(m,+v||0),0)));
    const steps=[1,2,5], pow=Math.pow(10, Math.floor(Math.log10(yMax||1))); let yStep=steps.find(s=>(s*pow)>=yMax/4)*pow; if(!yStep) yStep=pow;
    const yAxisMax=Math.ceil(yMax/yStep)*yStep;
    const n=Math.max(1,labels.length-1); const xAt=i=> (n===0? (X0+X1)/2 : X0+(i*(X1-X0)/n)); const yAt=v=> Y0 - ((v/(yAxisMax||1))*(Y0-Y1));
    // grille Y
    ctx.strokeStyle='#e5e7eb'; ctx.fillStyle='#6b7280'; ctx.lineWidth=1; ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto';
    for(let y=0;y<=yAxisMax;y+=yStep){ const yy=yAt(y); ctx.beginPath(); ctx.moveTo(X0,yy); ctx.lineTo(X1,yy); ctx.stroke(); ctx.fillText(cfg.yFmt?cfg.yFmt(y):String(y),4,yy-2); }
    // X (6 labels max)
    const maxX=Math.min(6,labels.length), stepX=Math.max(1, Math.floor(labels.length/maxX)); ctx.fillStyle='#374151';
    for(let i=0;i<labels.length;i+=stepX){ const xx=xAt(i); const lb=/^\d{2}-\d{2}$/.test(labels[i])?labels[i].slice(3):labels[i]; ctx.fillText(lb, xx-8, H-6); }
    if ((labels.length-1) % stepX !== 0) {
	const xx = xAt(labels.length-1), lb = labels[labels.length-1];
	ctx.fillText(lb, xx-8, H-6);
    }
    // lignes
    for(const s of series){
      ctx.strokeStyle=s.color||'#111'; ctx.lineWidth=2.4; ctx.beginPath();
      for(let i=0;i<labels.length;i++){ const x=xAt(i),y=yAt(+s.data[i]||0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); } ctx.stroke();
    }
  }
  function installRenderer(){
    const NS=window.StopAddictCharts||{}; const COLORS={clopes:'#6b7280', joints:'#10b981', alcool:'#f59e0b', cout:'#7c3aed', economies:'#2563eb'};
    NS.render = function(){
      const data=NS.buildSeriesForCurrentView?.(); if(!data) return;
      const vis=(window.StopAddictChartsState=window.StopAddictChartsState||{visible:{}}).visible;
      const c1=document.getElementById('chart-consommations'), c2=document.getElementById('chart-cout-eco');
      const e1=document.getElementById('empty-consos'), e2=document.getElementById('empty-cout');
      // consos
      if (c1){
        const show1 = [data.consos?.clopes,data.consos?.joints,data.consos?.alcool].some(a=>Array.isArray(a)&&a.some(v=>(+v||0)>0));
        c1.hidden=!show1; if(e1) e1.hidden=!!show1;
        if (show1) prettyDraw(c1, {labels:data.labels, series:[
          {data:data.consos.clopes,  color:COLORS.clopes,  visible:vis.clopes!==false},
          {data:data.consos.joints,  color:COLORS.joints,  visible:vis.joints!==false},
          {data:data.consos.alcool,  color:COLORS.alcool,  visible:vis.alcool!==false}
        ], yFmt:(v)=>String(Math.round(v))});
      }
      // coût & économies
      if (c2){
        const hasCost = Array.isArray(data.cout) && data.cout.some(v=>(+v||0)>0);
        const hasEco  = Array.isArray(data.economies) && data.economies.some(v=>(+v||0)>0);
        const show2 = hasCost || hasEco; c2.hidden=!show2; if(e2) e2.hidden=!!show2;
        if (show2){
          const fmt = (data.cout.reduce((m,v)=>Math.max(m,+v||0),0)<100)
                      ? new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2})
                      : new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
          prettyDraw(c2, {labels:data.labels, series:[
            {data:data.cout,      color:COLORS.cout,      visible:vis.cout!==false},
            {data:data.economies, color:COLORS.economies, visible:vis.economies!==false}
          ], yFmt:(v)=>fmt.format(v)});
        }
      }
      // légende toujours visible (économies grisées si vide)
      (function renderLegend(){
        const box=document.getElementById('chart-legend'); if (!box) return;
        const has=(arr)=>Array.isArray(arr)&&arr.some(v=>(+v||0)>0);
        const defs=[
          {k:'clopes',l:'Clopes',c:COLORS.clopes,p:has(data.consos?.clopes)},
          {k:'joints',l:'Pétards',c:COLORS.joints,p:has(data.consos?.joints)},
          {k:'alcool',l:'Alcool',c:COLORS.alcool,p:has(data.consos?.alcool)},
          {k:'cout',l:'Coût',c:COLORS.cout,p:has(data.cout)},
          {k:'economies',l:'Économies',c:COLORS.economies,p:has(data.economies)}
        ];
        box.innerHTML=''; defs.forEach(s=>{
          const it=document.createElement('div'); it.className='legend-item'+((vis[s.k]===false)?' is-muted':'')+(s.p?'':' is-disabled'); it.setAttribute('role','button');
          const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=s.c; const lb=document.createElement('span'); lb.textContent=s.l;
          it.appendChild(sw); it.appendChild(lb); it.addEventListener('click',()=>{ if(!s.p) return; vis[s.k]=!(vis[s.k]!==false); it.classList.toggle('is-muted', vis[s.k]===false); NS.render(); });
          box.appendChild(it);
        });
      })();

      // export boutons
      (function toggleExports(){
        const bar=document.getElementById('chart-actions'); if(!bar) return;
        const b=bar.querySelectorAll('.btn');
        const has=(arr)=>Array.isArray(arr)&&arr.some(v=>(+v||0)>0);
        if(b[0]) b[0].disabled = !(has(data.consos?.clopes)||has(data.consos?.joints)||has(data.consos?.alcool));
        if(b[1]) b[1].disabled = !(has(data.cout)||has(data.economies));
      })();

      SA_LOG.push('RENDER', {vue:window.vueStats||'mois', labels:data.labels.length});
    };
    window.StopAddictCharts = NS;
  }

  /* -- E) Calendrier : focus sécurisé LOCAL (corrige 31/01) -- */
  (function fixCalendarFocus(){
    const want = (k)=> keyLocal(parseKeyLocal(k));
    const trySet = (k)=> {
      if (typeof window.setCalendarFocusDate==='function') return window.setCalendarFocusDate(want(k));
      if (typeof window.focusCalendrierDate==='function')  return window.focusCalendrierDate(want(k));
    };
    // clic sur un point de graphe -> on passe toujours une clé locale "YYYY-MM-DD"
    document.addEventListener('click', (ev)=>{
      const cv = ev.target.closest('canvas#chart-consommations, canvas#chart-cout-eco'); if (!cv) return;
      // le rendu actuel recalcule côté NS.render ; on ne mappe pas finement ici (déjà géré)
      // On logue juste pour traçabilité
      SA_LOG.push('CLICK_CANVAS', {id:cv.id, vue:window.vueStats});
    }, true);

    // expose util pour d’autres parties si besoin
    window.SA_focusDateKey = function(k){
      try{
        if (typeof window.showEcran==='function') window.showEcran('calendrier');
        setTimeout(()=> trySet(k), 10);
      }catch(e){}
    };
  })();

  /* -- F) Intégration : hooke l’UI pour recalculer après chaque action -- */
  (function installHooks(){
    const prev1=window.updateAllUI;
    if (typeof prev1==='function' && !prev1.__saPatched){
      window.updateAllUI=function(){ const r=prev1.apply(this, arguments); try{ window.StopAddictCharts?.render?.(); }catch(e){} return r; };
      window.updateAllUI.__saPatched=true;
    }
    const prev2 = window.setStatsView;
if (typeof prev2 === 'function' && !prev2.__saPatched){
  window.setStatsView = function(v){
    window.vueStats = v;  // ← AJOUT
    SA_LOG.push('SET_STATS_VIEW', v);
    const r = prev2.apply(this, arguments);
    try { window.StopAddictCharts?.render?.(); } catch(e) {}
    return r;
  };
  window.setStatsView.__saPatched = true;
}
  })();

  /* -- G) Détails UI : hauteur min canvas + style disabled -- */
  (function ensureCSS(){
    const css = `
      #stats-charts canvas{min-height:220px}
      #stats-charts .legend-item.is-disabled{opacity:.45;pointer-events:none}
      #stats-charts .chart-actions .btn[disabled]{opacity:.5;pointer-events:none}
    `;
    const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);
  })();

  // Boot
  function boot(){
    installBuilder();
    installRenderer();
    setTimeout(()=> window.StopAddictCharts?.render?.(), 80);
    setTimeout(()=> window.StopAddictCharts?.render?.(), 350);
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();
})();
</script>
<script>
/* === STOPADDICT – Correctif global “données + dates locales + graphes” (SA2) ===
   Objectifs :
   - Corriger UTC→local (calendrier, périodes)
   - Lire les données réelles (même si window.donnees est vide) : scan des sources + localStorage
   - Construire des séries pour Jour/Semaine/Mois/Année avec les mêmes bornes locales que l’UI
   - Graphes lisibles (non-plats) et logs détaillés pour contrôle
   NOTE : n’écrase rien de l’UI, s’intègre uniquement en lecture / rendu.
*/
(function SA2(){
  if (window.__SA2_INSTALLED) return; window.__SA2_INSTALLED = true;

  /* ---------- A) Utilitaires dates 100% LOCALES (anti-UTC décalage) ---------- */
  function sa2Key(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
  function sa2Parse(k){
    if (k instanceof Date) return new Date(k.getFullYear(), k.getMonth(), k.getDate(), 12,0,0,0);
    const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(String(k)||''); if(!m) return new Date();
    return new Date(+m[1], +m[2]-1, +m[3], 12,0,0,0); // midi local -> no DST shift
  }
  function sa2StartOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); return x; } // Lundi
  function sa2EndOfWeek(d){ const s=sa2StartOfWeek(d), e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
  function sa2StartOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
  function sa2EndOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
  function sa2StartOfYear(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
  function sa2EndOfYear(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }
  function sa2KeysBetween(d1, d2){
    const out=[]; const s=new Date(d1.getFullYear(), d1.getMonth(), d1.getDate(),0,0,0,0);
    const e=new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(),23,59,59,999);
    for(let t=new Date(s); t<=e; t=new Date(t.getTime()+86400000)) out.push(sa2Key(t));
    return out;
  }

  /* ---------- B) Logger utile (tampon mémoire) ---------- */
  const SA2LOG = (function(){
    const buf = window.__sa2Buf = window.__sa2Buf || [];
    const ts = ()=> new Date().toISOString().replace('T',' ').replace('Z','');
    function p(kind, obj){
      try {
        const line = `[${ts()}] ${kind}: ` + (typeof obj==='string'? obj : JSON.stringify(obj));
        buf.push(line); if (buf.length>8000) buf.shift();
      } catch(e){}
    }
    // exposer un copier-logs robuste (si tu veux tester)
    document.addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('[data-action="copy-logs-sa2"]'); if (!btn) return;
      ev.preventDefault(); ev.stopPropagation();
      const text = JSON.stringify({ derniers_evenements: buf.slice(-800) }, null, 2);
      let ok=false;
      if (navigator.clipboard?.writeText){ try{ await navigator.clipboard.writeText(text); ok=true; }catch(e){} }
      if (!ok){
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ ok=document.execCommand('copy'); }catch(e){}
        document.body.removeChild(ta);
      }
      if (!ok) window.prompt('Copiez (long-press) :', text);
    }, true);
    return { p };
  })();

  /* ---------- C) Collecte des données (lit là où c’est vraiment stocké) ---------- */
  function looksLikeDayRecord(v){
    if (!v || typeof v!=='object') return false;
    // quelques clés possibles de l’app
    const keys = ['cl_class','cl_roul','cl_tube','joints','alc_biere','alc_fort','alc_liqueur'];
    return keys.some(k => k in v);
  }
  function mergeDayMap(into, src){
    Object.keys(src||{}).forEach(k=>{
      if (/^\d{4}-\d{2}-\d{2}$/.test(k) && looksLikeDayRecord(src[k])){
        into[k] = Object.assign({cl_class:0,cl_roul:0,cl_tube:0,joints:0,alc_biere:0,alc_fort:0,alc_liqueur:0}, src[k]);
      }
    });
  }
  function harvestDayMap(){
    const map = {};
    // 1) objets globaux probables
    ['donnees','data','historique','saData'].forEach(name=>{
      try{ if (window[name] && typeof window[name]==='object') mergeDayMap(map, window[name]); }catch(e){}
    });
    // 2) localStorage : cherche “gros JSON par jours”
    try{
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        try{
          const val = JSON.parse(localStorage.getItem(k));
          if (val && typeof val==='object'){
            // cas 2a : objet “YYYY-MM-DD” -> record
            const keys = Object.keys(val);
            if (keys.length && keys.every(x=>/^\d{4}-\d{2}-\d{2}$/.test(x))){
              mergeDayMap(map, val);
              continue;
            }
            // cas 2b : structure imbriquée { days: {YYYY-MM-DD: {…}} }
            if (val.days && typeof val.days==='object'){
              mergeDayMap(map, val.days);
            }
          }
        }catch(e){}
      }
    }catch(e){}
    SA2LOG.p('SA2_DATA', {jours:Object.keys(map).length});
    return map;
  }

  /* ---------- D) Calculs par jour + coût (réutilise calculerCoutJour si dispo) ---------- */
  function totalsFromRecord(rec){
    return {
      clopes: (+rec.cl_class||0)+(+rec.cl_roul||0)+(+rec.cl_tube||0),
      joints: (+rec.joints||0),
      alcool: (+rec.alc_biere||0)+(+rec.alc_fort||0)+(+rec.alc_liqueur||0)
    };
  }
  function coutFromRecord(rec){
    if (typeof window.calculerCoutJour === 'function') {
      try { return +(window.calculerCoutJour(rec)||0); } catch(e){ return 0; }
    }
    // fallback minimal si calculerCoutJour n’existe pas : 0 (évite doublons de logique)
    return 0;
  }

  /* ---------- E) Builder de séries (aligne Jour/Semaine/Mois/Année sur LOCAL) ---------- */
  function buildSeries(){
    const now = new Date();
    const view = (window.vueStats || 'mois'); // 'jour'|'semaine'|'mois'|'annee'
    const dayMap = harvestDayMap();

    function dayRec(key){ return dayMap[key] || null; }
    const labels=[], Scl=[], Sjo=[], Sal=[], Sco=[], Sec=[];

    if (view === 'jour'){
      const k = sa2Key(now);
      const r = dayRec(k);
      const t = totalsFromRecord(r||{});
      labels.push('Aujourd’hui');
      Scl.push(t.clopes); Sjo.push(t.joints); Sal.push(t.alcool);
      const c = coutFromRecord(r||{}); Sco.push(+c.toFixed(2));
      // référence (si dispo)
      const ref = window.StopAddictCharts?.referenceParJourPourDate?.(sa2Parse(k));
      if (ref!=null) Sec.push(Math.max(+ref - c, 0));
    } else if (view === 'semaine'){
      const d1 = sa2StartOfWeek(now), d2 = sa2EndOfWeek(now);
      const ks = sa2KeysBetween(d1,d2);
      const ref = window.StopAddictCharts?.referenceParJourPourDate?.(now);
      ks.forEach(k=>{
        const r = dayRec(k), t = totalsFromRecord(r||{});
        labels.push(k.slice(5));
        Scl.push(t.clopes); Sjo.push(t.joints); Sal.push(t.alcool);
        const c = coutFromRecord(r||{}); Sco.push(+c.toFixed(2));
        if (ref!=null) Sec.push(Math.max(+ref - c, 0));
      });
    } else if (view === 'mois'){
      const d1 = sa2StartOfMonth(now), d2 = sa2EndOfMonth(now);
      const ks = sa2KeysBetween(d1,d2);
      const ref = window.StopAddictCharts?.referenceParJourPourDate?.(now);
      ks.forEach(k=>{
        const r = dayRec(k), t = totalsFromRecord(r||{});
        labels.push(k.slice(5));
        Scl.push(t.clopes); Sjo.push(t.joints); Sal.push(t.alcool);
        const c = coutFromRecord(r||{}); Sco.push(+c.toFixed(2));
        if (ref!=null) Sec.push(Math.max(+ref - c, 0));
      });
    } else { // annee
      const y1 = sa2StartOfYear(now), y2 = sa2EndOfYear(now);
      for (let m=0;m<12;m++){
        const m1=new Date(y1.getFullYear(), m, 1, 0,0,0,0);
        const m2=new Date(y1.getFullYear(), m+1, 0, 23,59,59,999);
        const ks = sa2KeysBetween(m1,m2);
        let tC=0,tJ=0,tA=0, cT=0, eT=0;
        ks.forEach(k=>{
          const r=dayRec(k), t = totalsFromRecord(r||{});
          tC+=t.clopes; tJ+=t.joints; tA+=t.alcool;
          const c = coutFromRecord(r||{}); cT += c;
          const ref = window.StopAddictCharts?.referenceParJourPourDate?.(sa2Parse(k));
          if (ref!=null) eT += Math.max(+ref - c, 0);
        });
        labels.push(new Date(y1.getFullYear(),m,1).toLocaleString('fr-FR',{month:'short'}));
        Scl.push(tC); Sjo.push(tJ); Sal.push(tA); Sco.push(+cT.toFixed(2)); Sec.push(+eT.toFixed(2));
      }
    }

    const out = { labels, consos:{clopes:Scl, joints:Sjo, alcool:Sal}, cout:Sco, economies:Sec };
    SA2LOG.p('SA2_SERIES', {
      vue:view, labels:labels.length,
      sumC:Scl.reduce((s,v)=>s+(+v||0),0),
      sumJ:Sjo.reduce((s,v)=>s+(+v||0),0),
      sumA:Sal.reduce((s,v)=>s+(+v||0),0),
      sumCO:Sco.reduce((s,v)=>s+(+v||0),0),
      sumEC:Sec.reduce((s,v)=>s+(+v||0),0)
    });
    return out;
  }

  /* ---------- F) Rendu lisible (canvas simple, 6 labels X max) ---------- */
  function drawLineChart(canvas, cfg){
    const ctx = canvas.getContext('2d'); if (!ctx) return;
    const dpr=Math.max(1, window.devicePixelRatio||1), rect=canvas.getBoundingClientRect();
    canvas.width=Math.max(340, Math.round(rect.width*dpr)); canvas.height=Math.max(220, Math.round(220*dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W=rect.width, H=220, PAD={l:44,r:10,t:12,b:26};
    const X0=PAD.l, X1=W-PAD.r, Y0=H-PAD.b, Y1=PAD.t;
    ctx.clearRect(0,0,W,H);

    const labels=cfg.labels||[];
    const series=(cfg.series||[]).filter(s=>s && s.visible!==false && s.data && s.data.length===labels.length);

    const ymax = Math.max(1, ...series.map(s => s.data.reduce((m,v)=>Math.max(m,+v||0),0)));
    const steps=[1,2,5], pw=Math.pow(10, Math.floor(Math.log10(ymax||1))); let yStep=steps.find(s=>(s*pw)>=ymax/4)*pw; if(!yStep) yStep=pw;
    const YMAX = Math.ceil(ymax/yStep)*yStep;

    const n=Math.max(1, labels.length-1);
    const xAt=i => (n===0? (X0+X1)/2 : X0 + (i*(X1-X0)/n));
    const yAt=v => Y0 - ((v/(YMAX||1))*(Y0-Y1));

    // Grille Y
    ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillStyle='#6b7280';
    for(let y=0;y<=YMAX;y+=yStep){ const yy=yAt(y); ctx.beginPath(); ctx.moveTo(X0,yy); ctx.lineTo(X1,yy); ctx.stroke(); ctx.fillText(cfg.yFmt?cfg.yFmt(y):String(y), 4, yy-2); }

    // Labels X (6 max)
    const maxX=Math.min(6, labels.length), stepX=Math.max(1, Math.floor(labels.length/maxX));
    ctx.fillStyle='#374151';
    for(let i=0;i<labels.length;i+=stepX){
      const lb = (/^\d{2}-\d{2}$/.test(labels[i]) ? labels[i].slice(3) : labels[i]);
      ctx.fillText(lb, xAt(i)-8, H-6);
    }

    // Courbes
    for (const s of series){
      ctx.strokeStyle = s.color||'#111'; ctx.lineWidth=2.4; ctx.beginPath();
      for(let i=0;i<labels.length;i++){ const x=xAt(i), y=yAt(+s.data[i]||0); if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); }
      ctx.stroke();
    }
  }

  function renderCharts(){
    if (!window.StopAddictCharts) window.StopAddictCharts = {};
    const COLORS = { clopes:'#6b7280', joints:'#10b981', alcool:'#f59e0b', cout:'#7c3aed', economies:'#2563eb' };

    const data = buildSeries(); if (!data) return;

    const vis=(window.StopAddictChartsState=window.StopAddictChartsState||{visible:{}}).visible;
    const c1=document.getElementById('chart-consommations');
    const c2=document.getElementById('chart-cout-eco');
    const e1=document.getElementById('empty-consos');
    const e2=document.getElementById('empty-cout');

    const hasPos = a => Array.isArray(a) && a.some(v => (+v||0)>0);

    // Consommations
    if (c1){
      const show1 = hasPos(data.consos?.clopes)||hasPos(data.consos?.joints)||hasPos(data.consos?.alcool);
      c1.hidden=!show1; if (e1) e1.hidden=!!show1;
      if (show1) drawLineChart(c1, { labels:data.labels, yFmt:v=>String(Math.round(v)), series:[
        {data:data.consos.clopes,  color:COLORS.clopes,  visible:vis.clopes!==false},
        {data:data.consos.joints,  color:COLORS.joints,  visible:vis.joints!==false},
        {data:data.consos.alcool,  color:COLORS.alcool,  visible:vis.alcool!==false},
      ]});
    }

    // Coût & Économies
    if (c2){
      const show2 = hasPos(data.cout)||hasPos(data.economies);
      c2.hidden=!show2; if (e2) e2.hidden=!!show2;
      if (show2){
        const fmt = (data.cout.reduce((m,v)=>Math.max(m,+v||0),0)<100)
          ? new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:2})
          : new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0});
        drawLineChart(c2, { labels:data.labels, yFmt:v=>fmt.format(v), series:[
          {data:data.cout,      color:COLORS.cout,      visible:vis.cout!==false},
          {data:data.economies, color:COLORS.economies, visible:vis.economies!==false},
        ]});
      }
    }

    // Légende persistante (économies grisées si vide)
    try{
      const box=document.getElementById('chart-legend'); if (box){
        box.innerHTML='';
        [
          {k:'clopes',l:'Clopes',c:COLORS.clopes,p:hasPos(data.consos?.clopes)},
          {k:'joints',l:'Pétards',c:COLORS.joints,p:hasPos(data.consos?.joints)},
          {k:'alcool',l:'Alcool',c:COLORS.alcool,p:hasPos(data.consos?.alcool)},
          {k:'cout',l:'Coût',c:COLORS.cout,p:hasPos(data.cout)},
          {k:'economies',l:'Économies',c:COLORS.economies,p:hasPos(data.economies)},
        ].forEach(s=>{
          const it=document.createElement('div'); it.className='legend-item'+((vis[s.k]===false)?' is-muted':'')+(s.p?'':' is-disabled'); it.setAttribute('role','button');
          const sw=document.createElement('span'); sw.className='legend-swatch'; sw.style.background=s.c;
          const lb=document.createElement('span'); lb.textContent=s.l;
          it.appendChild(sw); it.appendChild(lb);
          it.addEventListener('click',()=>{ if(!s.p) return; vis[s.k]=!(vis[s.k]!==false); it.classList.toggle('is-muted', vis[s.k]===false); renderCharts(); });
          box.appendChild(it);
        });
      }
    }catch(e){}

    // Exports : désactivés si vide
    try{
      const bar=document.getElementById('chart-actions'); if (bar){
        const b=bar.querySelectorAll('.btn');
        if (b[0]) b[0].disabled = !(hasPos(data.consos?.clopes)||hasPos(data.consos?.joints)||hasPos(data.consos?.alcool));
        if (b[1]) b[1].disabled = !(hasPos(data.cout)||hasPos(data.economies));
      }
    }catch(e){}
  }

  /* ---------- G) Intégration douce : re-render quand la vue change / UI se met à jour ---------- */
  (function hookUI(){
    const css = `
      #stats-charts canvas{min-height:220px}
      #stats-charts .legend-item.is-disabled{opacity:.45;pointer-events:none}
      #stats-charts .chart-actions .btn[disabled]{opacity:.5;pointer-events:none}
    `;
    const s=document.createElement('style'); s.textContent=css; document.head.appendChild(s);

    const prevUpd = window.updateAllUI;
    if (typeof prevUpd==='function' && !prevUpd.__sa2){
      window.updateAllUI = function(){ const r = prevUpd.apply(this, arguments); try{ renderCharts(); }catch(e){} return r; };
      window.updateAllUI.__sa2 = true;
    }
    const prevSet = window.setStatsView;
    if (typeof prevSet==='function' && !prevSet.__sa2){
      window.setStatsView = function(v){ const r = prevSet.apply(this, arguments); try{ renderCharts(); }catch(e){} return r; };
      window.setStatsView.__sa2 = true;
    }
  })();

  /* ---------- H) Calendrier : focus “clé locale” (corrige 31/08 vs 01/09) ---------- */
  ['setCalendarFocusDate','focusCalendrierDate'].forEach(fn=>{
    const prev = window[fn];
    if (typeof prev==='function' && !prev.__sa2){
      window[fn] = function(k){ const fixed = sa2Key(sa2Parse(k)); return prev.call(this, fixed); };
      window[fn].__sa2 = true;
    }
  });

  /* ---------- I) Boot initial ---------- */
  function boot(){
    SA2LOG.p('SA2_BOOT', 'start');
    try{ renderCharts(); }catch(e){ SA2LOG.p('SA2_ERR', String(e)); }
  }
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot); else boot();

})();
</script>
<script>
/* === STOPADDICT – Correctif SA3 (local dates + charts stables + bandeau) === */
(function SA3(){
  if (window.__SA3) return; window.__SA3 = true;

  /* 1) Dates : parse 'YYYY-MM-DD' en LOCAL (corrige 01→31/08) */
  (function patchDateParse(){
    const _parse = Date.parse;
    Date.parse = function(s){
      if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) {
        const [y,m,d] = s.split('-').map(Number);
        return new Date(y, m-1, d, 12, 0, 0, 0).getTime(); // midi local => jamais la veille
      }
      return _parse(s);
    };
  })();

  /* 2) Utils dates locales */
  function dKey(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
  function startOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); return x; }
  function endOfWeek(d){ const s=startOfWeek(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }
  function startOfYear(d){ return new Date(d.getFullYear(), 0, 1, 0,0,0,0); }
  function endOfYear(d){ return new Date(d.getFullYear(), 11, 31, 23,59,59,999); }

  /* 3) Logs compacts utiles */
  function log(kind, obj){ try{ console.log(kind, (typeof obj==='string'? obj : JSON.stringify(obj))); }catch(e){} }

  /* 4) Lecture des données “réelles” (même si window.donnees est vide) */
  function harvestDays(){
    const map = {};
    // sources globales connues
    ['donnees','data','historique','saData'].forEach(k=>{
      try{
        const v = window[k];
        if (v && typeof v==='object') {
          Object.keys(v).forEach(day=>{
            if (/^\d{4}-\d{2}-\d{2}$/.test(day) && v[day] && typeof v[day]==='object') map[day]=v[day];
          });
        }
      }catch(e){}
    });
    // localStorage : objets { "YYYY-MM-DD": {...} }      
    log('SA3_DATA', { jours:Object.keys(map).length });
    return map;
  }

  /* 5) Agrégation alignée sur l’UI (Jour/Semaine/Mois/Année) */
  function getView(){ try{ return (window.vueStats||'mois'); }catch(e){ return 'mois'; } }
  function sum(a){ return (a||[]).reduce((s,v)=>s+(+v||0),0); }
  function getCoutsForDay(rec){
    if (!rec) return 0;
    if (typeof window.calculerCoutJour === 'function'){
      try{ return +window.calculerCoutJour(rec) || 0; }catch(e){ return 0; }
    }
    return 0;
  }
  function totals(rec){
    if (!rec) return {cl:0,j:0,a:0};
    return {
      cl: (+rec.cl_class||0)+(+rec.cl_roul||0)+(+rec.cl_tube||0),
      j:  (+rec.joints||0),
      a:  (+rec.alc_biere||0)+(+rec.alc_fort||0)+(+rec.alc_liqueur||0),
    };
  }

  function buildSeries(){
    const dayMap = harvestDays();
    const now = new Date();
    const view = getView();
    const labels=[], Scl=[], Sjo=[], Sal=[], Sco=[], Sec=[];
    const refDaily = (window.StopAddictCharts && typeof window.StopAddictCharts.referenceParJourPourDate==='function')
      ? (d)=>+window.StopAddictCharts.referenceParJourPourDate(d)||0
      : ()=>0;

    function pushDay(date){
      const k = dKey(date), rec = dayMap[k]||null, t=totals(rec), c=getCoutsForDay(rec), r=refDaily(date);
      labels.push(k.slice(5));
      Scl.push(t.cl); Sjo.push(t.j); Sal.push(t.a);
      Sco.push(+c.toFixed(2));
      Sec.push(Math.max(r - c, 0));
    }

    if (view==='jour'){
  		// → 4 tranches horaires fixes pour le jour courant
  		const k = dKey(now);
  		const rec = dayMap[k] || null;
  		const t   = totals(rec);                 // totaux du jour (clopes/joints/alcool)
  		const c   = getCoutsForDay(rec);         // coût du jour
  		const r   = refDaily(now);               // référence pour économies

	 const labels4 = ["00–07","07–14","14–21","21–00"];
	  for (let i = 0; i < 4; i++){
    			labels.push(labels4[i]);
    			Scl.push((t.cl||0)/4);
    			Sjo.push((t.j||0)/4);
    			Sal.push((t.a||0)/4);
    			Sco.push((+c||0)/4);
    			Sec.push(Math.max((+r||0) - (+c||0), 0)/4);
 		 }
    } else if (view==='semaine'){
      let d = startOfWeek(now), end=endOfWeek(now);
      for (let x=new Date(d); x<=end; x.setDate(x.getDate()+1)) pushDay(x);
    } else if (view==='mois'){
      let d = startOfMonth(now), end=endOfMonth(now);
      for (let x=new Date(d); x<=end; x.setDate(x.getDate()+1)) pushDay(x);
    } else { // annee
      for (let m=0;m<12;m++){
        const m1=new Date(now.getFullYear(), m, 1), m2=new Date(now.getFullYear(), m+1, 0, 23,59,59,999);
        let tCl=0,tJo=0,tAl=0,tCo=0,tEc=0;
        for (let x=new Date(m1); x<=m2; x.setDate(x.getDate()+1)){
          const k = dKey(x), rec = dayMap[k]||null, t=totals(rec), c=getCoutsForDay(rec), r=refDaily(x);
          tCl+=t.cl; tJo+=t.j; tAl+=t.a; tCo+=c; tEc+=Math.max(r-c,0);
        }
        labels.push(new Date(now.getFullYear(), m, 1).toLocaleString('fr-FR',{month:'short'}));
        Scl.push(tCl); Sjo.push(tJo); Sal.push(tAl); Sco.push(+tCo.toFixed(2)); Sec.push(+tEc.toFixed(2));
      }
    }
    const out = { labels, consos:{clopes:Scl,joints:Sjo,alcool:Sal}, cout:Sco, economies:Sec };
    log('SA3_SERIES', { vue:view, labels:labels.length, sumC:sum(Scl), sumJ:sum(Sjo), sumA:sum(Sal), sumCO:sum(Sco), sumEC:sum(Sec) });
    return out;
  }

  /* 6) Dessin simple (canvas) + rendu idempotent */
  function draw(canvas, cfg){
    const ctx = canvas.getContext('2d'); if (!ctx) return;
    const dpr = Math.max(1, window.devicePixelRatio||1), rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(340, Math.round(rect.width*dpr)); canvas.height = Math.round(220*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    const W=rect.width, H=220, PAD={l:44,r:10,t:12,b:26}, X0=PAD.l, X1=W-PAD.r, Y0=H-PAD.b, Y1=PAD.t;
    ctx.clearRect(0,0,W,H);
    const labels=cfg.labels||[], series=cfg.series||[];
    const ymax=Math.max(1, ...series.map(s=>s.data.reduce((m,v)=>Math.max(m,+v||0),0)));
    const steps=[1,2,5], pw=Math.pow(10, Math.floor(Math.log10(ymax))); let st=steps.find(s=>(s*pw)>=ymax/4)*pw; if(!st) st=pw;
    const YMAX = Math.ceil(ymax/st)*st;
    const n=Math.max(1, labels.length-1);
    const xAt=i=> (n===0? (X0+X1)/2 : X0 + (i*(X1-X0)/n));
    const yAt=v=> Y0 - ((v/(YMAX||1))*(Y0-Y1));
    // grille Y + labels X (6 max)
    ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto'; ctx.fillStyle='#6b7280';
    for(let y=0;y<=YMAX;y+=st){ const yy=yAt(y); ctx.beginPath(); ctx.moveTo(X0,yy); ctx.lineTo(X1,yy); ctx.stroke(); ctx.fillText(String(y), 4, yy-2); }
    ctx.fillStyle='#374151'; const maxX=Math.min(6,labels.length), stepX=Math.max(1, Math.floor(labels.length/maxX));
    for(let i=0;i<labels.length;i+=stepX){ ctx.fillText(/^\d{2}-\d{2}$/.test(labels[i])?labels[i].slice(3):labels[i], xAt(i)-8, H-6); }
    // courbes
    for(const s of series){ ctx.strokeStyle=s.color; ctx.lineWidth=2.4; ctx.beginPath(); for(let i=0;i<labels.length;i++){ const x=xAt(i), y=yAt(+s.data[i]||0); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);} ctx.stroke(); }
  }

  function renderCharts(){
    const COLORS = { cl:'#6b7280', j:'#10b981', a:'#f59e0b', co:'#7c3aed', ec:'#2563eb' };
    const d = buildSeries(); if (!d) return;
    const c1=document.getElementById('chart-consommations');
    const c2=document.getElementById('chart-cout-eco');
    const has = arr => Array.isArray(arr) && arr.some(v => (+v||0)>0);
    if (c1){
      const show = has(d.consos.clopes)||has(d.consos.joints)||has(d.consos.alcool);
      c1.hidden=!show; const e1=document.getElementById('empty-consos'); if (e1) e1.hidden=show;
      if (show) draw(c1, { labels:d.labels, series:[
        { data:d.consos.clopes, color:COLORS.cl },
        { data:d.consos.joints, color:COLORS.j },
        { data:d.consos.alcool, color:COLORS.a },
      ]});
    }
    if (c2){
      const show = has(d.cout)||has(d.economies);
      c2.hidden=!show; const e2=document.getElementById('empty-cout'); if (e2) e2.hidden=show;
      if (show) draw(c2, { labels:d.labels, series:[
        { data:d.cout,      color:COLORS.co },
        { data:d.economies, color:COLORS.ec },
      ]});
    }
  }

  /* 7) Re-rendu quand l’UI bouge (sans conflit) */
  (function hookUI(){
    const prevUpd = window.updateAllUI;
    if (typeof prevUpd==='function' && !prevUpd.__sa3){
      window.updateAllUI = function(){ const r=prevUpd.apply(this, arguments); try{ renderCharts(); }catch(e){} return r; };
      window.updateAllUI.__sa3 = true;
    } else {
      document.addEventListener('DOMContentLoaded', ()=>{ try{ renderCharts(); }catch(e){} });
    }
    const prevSet = window.setStatsView;
    if (typeof prevSet==='function' && !prevSet.__sa3){
      window.setStatsView = function(v){ const r=prevSet.apply(this, arguments); try{ renderCharts(); }catch(e){} return r; };
      window.setStatsView.__sa3 = true;
    }
  })();

  /* 8) Bandeau orange : garder seulement “changer” et relancer le chrono */
  (function simplifyAdvice(){
    const pause = document.getElementById('adv-pause'); if (pause) pause.remove();
    const lim = document.getElementById('lien-limites'); if (lim) lim.remove();
    const prev = document.getElementById('adv-prev');
    if (prev){
      prev.addEventListener('click', ()=>{
        try{
          // relance propre du timer de 30 s si une fonction existe
          if (window.restartAdviceRotation) window.restartAdviceRotation(30000);
          else {
            // fallback simple : on stoppe et on relance via setTimeout
            clearTimeout(window.__advTimer);
            window.__advTimer = setTimeout(()=>{ try{ window.showNextAdvice && window.showNextAdvice(); }catch(e){} }, 30000);
          }
        }catch(e){}
      }, {capture:true});
    }
  })();

  /* 9) Boot initial */
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', renderCharts);
  else renderCharts();

})();
</script>
<script>
/* === SA-CAL-LOCAL v1 — Corrige le décalage -1 jour dans le calendrier === */
(function(){
  if (window.__SA_CAL_LOCAL__) return; window.__SA_CAL_LOCAL__ = true;

  // 1) Outils date 100% locaux (pas d'UTC)
  function keyLocal(d){
    if (!(d instanceof Date)) d = new Date(d);
    return [
      d.getFullYear(),
      String(d.getMonth()+1).padStart(2,'0'),
      String(d.getDate()).padStart(2,'0')
    ].join('-');
  }
  function dateLocalFromYmd(ymd){
    if (typeof ymd === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(ymd)){
      const [y,m,da] = ymd.split('-').map(Number);
      return new Date(y, m-1, da, 12, 0, 0, 0); // midi local => jamais la veille
    }
    return new Date(ymd);
  }

  // 2) Envelopper les fonctions d'ouverture/centrage calendrier pour imposer une clé locale
  ['focusCalendrierDate','setCalendarFocusDate'].forEach(fn=>{
    const prev = window[fn];
    if (typeof prev === 'function' && !prev.__sa_local){
      window[fn] = function(arg){
        // arg peut être "YYYY-MM-DD", un Date, ou autre
        let k;
        if (arg instanceof Date) {
          k = keyLocal(arg);
        } else if (typeof arg === 'string') {
          if (/^\d{4}-\d{2}-\d{2}$/.test(arg)) {
            k = arg;
          } else if (/^\d{4}-\d{2}-\d{2}T/.test(arg)) {
            k = keyLocal(new Date(arg));
          } else {
            // Dernier recours : on tente parse puis on repasse en clé locale
            k = keyLocal(new Date(arg));
          }
        } else {
          k = keyLocal(new Date());
        }
        return prev.call(this, k);
      };
      window[fn].__sa_local = true;
    }
  });

  // 3) Click sur la grille calendrier → normaliser en clé locale via #cal-titre
  function parseTitreMonthYear(){
    const h = document.getElementById('cal-titre');
    if (!h) return null;
    const txt = (h.textContent||'').trim().toLowerCase();
    // support "septembre 2025" (fr)
    const months = ['janvier','février','fevrier','mars','avril','mai','juin',
                    'juillet','août','aout','septembre','octobre','novembre','décembre','decembre'];
    const parts = txt.split(/\s+/);
    if (parts.length<2) return null;
    const y = parseInt(parts[parts.length-1], 10);
    const mName = parts.slice(0, parts.length-1).join(' ');
    let m = -1;
    for (let i=0;i<months.length;i++){
      const name = months[i];
      if (mName.indexOf(name) !== -1){
        // Corriger index pour variantes "fevrier/aout/decembre"
        const canon = ['janvier','février','mars','avril','mai','juin','juillet','août','septembre','octobre','novembre','décembre'];
        m = canon.findIndex(c => mName.indexOf(c)!==-1);
        if (m<0) { // fallback pour "fevrier/aout/decembre" sans accent
          const canon2 = ['janvier','fevrier','mars','avril','mai','juin','juillet','aout','septembre','octobre','novembre','decembre'];
          m = canon2.findIndex(c => mName.indexOf(c)!==-1);
        }
        break;
      }
    }
    if (m<0 || !y) return null;
    return {year:y, month:m}; // month: 0..11
  }

  function normalizeCellToKey(cell){
    // 1) si data-date déjà correct => localiser
    const raw = cell.getAttribute('data-date');
    if (raw && /^\d{4}-\d{2}-\d{2}$/.test(raw)) {
      return keyLocal(dateLocalFromYmd(raw));
    }
    // 2) sinon, reconstituer via jour affiché + #cal-titre
    const head = parseTitreMonthYear();
    if (!head) return null;
    // chercher le numéro de jour visible dans la case
    let dayNum = null;
    // essaie .textContent direct ou un span interne
    const txt = (cell.textContent||'').trim();
    const m = txt.match(/^(\d{1,2})/);
    if (m) dayNum = parseInt(m[1],10);
    if (!dayNum) return null;
    const d = new Date(head.year, head.month, dayNum, 12, 0, 0, 0);
    return keyLocal(d);
  }

  function handleCalClick(ev){
    const grid = document.getElementById('cal-grille');
    if (!grid) return;
    const target = ev.target.closest('[data-date], .cal-cell, .day'); // classes tolérantes
    if (!target || !grid.contains(target)) return;

    // On fabrique une clé LOCALE, puis on délègue aux fonctions natives
    const k = normalizeCellToKey(target);
    if (!k) return;

    ev.preventDefault();
    ev.stopImmediatePropagation();
    try { if (typeof window.showEcran==='function') window.showEcran('calendrier'); } catch(e){}
    if (typeof window.focusCalendrierDate==='function') { window.focusCalendrierDate(k); return; }
    if (typeof window.setCalendarFocusDate==='function') { window.setCalendarFocusDate(k); return; }

    // Fallback : ouvrir la modale si une fonction existe (nom générique)
    try { (window.openDayModal||window.ouvrirModalJour||window.afficherJour||function(){ })(k); } catch(e){}
  }

  // Installer le délégué de clic une seule fois
  document.addEventListener('click', function(ev){
    const grid = document.getElementById('cal-grille');
    if (grid && grid.contains(ev.target)) handleCalClick(ev);
  }, true);

  // 4) (optionnel doux) Répare les data-date si la grille est régénérée
  const grid = document.getElementById('cal-grille');
  if (grid && !grid.__sa_fix_observer){
    const obs = new MutationObserver(()=>{
      grid.querySelectorAll('[data-date]').forEach(cell=>{
        const k = normalizeCellToKey(cell);
        if (k) cell.setAttribute('data-date', k);
      });
    });
    obs.observe(grid, {childList:true, subtree:true});
    grid.__sa_fix_observer = true;
  }

})();
</script>
<script>
/* SA-CHART-UI v1 — Unifie placeholders + actions sous les charts */
(function(){
  if (window.__SA_CHART_UI__) return; window.__SA_CHART_UI__=true;

  function hasPos(arr){ return Array.isArray(arr) && arr.some(v => (+v||0) > 0); }

  function syncUI(){
    try{
      const NS = window.StopAddictCharts; if (!NS || typeof NS.buildSeriesForCurrentView!=='function') return;
      const S = NS.buildSeriesForCurrentView(); if (!S) return;

      const c1 = document.getElementById('chart-consommations');
      const c2 = document.getElementById('chart-cout-eco');
      const e1 = document.getElementById('empty-consos');
      const e2 = document.getElementById('empty-cout');
      const bar = document.getElementById('chart-actions');

      // visibilités
      const show1 = hasPos(S?.consos?.clopes) || hasPos(S?.consos?.joints) || hasPos(S?.consos?.alcool);
      const show2 = hasPos(S?.cout) || hasPos(S?.economies);

      if (c1) c1.hidden = !show1;
      if (e1) e1.hidden = !!show1;
      if (c2) c2.hidden = !show2;
      if (e2) e2.hidden = !!show2;

      // boutons PNG (0: conso, 1: cout/eco)
      if (bar){
        const btns = bar.querySelectorAll('.btn');
        if (btns[0]) btns[0].disabled = !show1;
        if (btns[1]) btns[1].disabled = !show2;
      }
    }catch(e){}
  }

  // Hooke les cycles de rendu déjà en place (SA3 l’appelle à chaque changement de vue)
  const prevUpd = window.updateAllUI;
  if (typeof prevUpd==='function' && !prevUpd.__sa_chart_ui){
    window.updateAllUI = function(){ const r=prevUpd.apply(this, arguments); syncUI(); return r; };
    window.updateAllUI.__sa_chart_ui=true;
  }
  const prevSet = window.setStatsView;
  if (typeof prevSet === 'function' && !prevSet.__sa_chart_ui){
  window.setStatsView = function(v){
    window.vueStats = v;  // ← AJOUT
    const r = prevSet.apply(this, arguments);.
    syncUI();
    return r;
  };
  window.setStatsView.__sa_chart_ui = true;
}


  // Premier passage
  if (document.readyState==='loading') document.addEventListener('DOMContentLoaded', syncUI); else syncUI();
})();
</script>
<script>
/* SA-AXES v1 — Granularités: Jour(24h)/Semaine(7j)/Mois(par semaines)/Année(12m) */
(function(){
  if (window.__SA_AXES__) return; window.__SA_AXES__=true;

  // Helpers locaux cohérents
  function key(d){ return [d.getFullYear(), String(d.getMonth()+1).padStart(2,'0'), String(d.getDate()).padStart(2,'0')].join('-'); }
  function startOfWeek(d){ const x=new Date(d); x.setHours(0,0,0,0); const dow=(x.getDay()+6)%7; x.setDate(x.getDate()-dow); return x; }
  function endOfWeek(d){ const s=startOfWeek(d), e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }
  function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0,0); }
  function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999); }

  // Source de vérité jour -> record (on lit dans les structures existantes)
  function harvestDays(){
    const map={};
    ['donnees','data','historique','saData'].forEach(n=>{
      const v=window[n]; if (v && typeof v==='object'){
        Object.keys(v).forEach(k=>{ if(/^\d{4}-\d{2}-\d{2}$/.test(k) && v[k] && typeof v[k]==='object') map[k]=v[k]; });
      }
    });
    return map;
  }

  function totals(r){ return { cl:(+r?.cl_class||0)+(+r?.cl_roul||0)+(+r?.cl_tube||0), j:(+r?.joints||0), a:(+r?.alc_biere||0)+(+r?.alc_fort||0)+(+r?.alc_liqueur||0) }; }
  function cost(r){ if(!r) return 0; try{ return +(window.calculerCoutJour?.(r)||0); }catch(e){ return 0; } }
  function refDaily(d){ try{ const f=window.StopAddictCharts?.referenceParJourPourDate; return (typeof f==='function')? +f(d)||0 : 0; }catch(e){ return 0; } }

  function buildSeriesAX(){
    const view = (window.vueStats||'mois');
    const now = new Date();
    const days = harvestDays();
    const labels=[], C=[], J=[], A=[], CO=[], EC=[];

    if (view==='jour'){
  		const k = key(now);
  		const r = days[k] || null;
 		const t = totals(r);

      const totalC = t.cl;
                const totalJ = t.j;
                const totalA = t.a;

               const co  = cost(r);
               const ref = refDaily(now);

  // 4 tranches horaires fixes
              const labels4 = ["00–07","07–14","14–21","21–00"];
              for (let i = 0; i < 4; i++) {
                      labels.push(labels4[i]);
                      C.push(totalC / 4);
                      J.push(totalJ / 4);
                       A.push(totalA / 4);
                       CO.push(co / 4);
                     EC.push(Math.max(ref - co, 0) / 4);
                    }

    } else if (view==='semaine'){
      const d1=startOfWeek(now), d2=endOfWeek(now);
      for(let d=new Date(d1); d<=d2; d.setDate(d.getDate()+1)){
        const k=key(d), r=days[k]||null, t=totals(r), co=cost(r), ref=refDaily(d);
        labels.push(['Lu','Ma','Me','Je','Ve','Sa','Di'][(d.getDay()+6)%7]);
	C.push(t.cl); J.push(t.j); A.push(t.a); CO.push(+co.toFixed(2)); EC.push(Math.max(ref-co,0));
      }
    } else if (view==='mois'){
      // regrouper par semaines (lun→dim)
      const m1=startOfMonth(now), m2=endOfMonth(now);
      // première semaine couvrant le début du mois
      let wStart = startOfWeek(m1);
      while (wStart <= m2){
        const wEnd = endOfWeek(wStart);
        let c=0,j=0,a=0,co=0,ec=0, ref=0, dayCount=0;
        for(let d=new Date(wStart); d<=wEnd && d<=m2; d.setDate(d.getDate()+1)){
          if (d<m1) continue; // ne pas compter les jours de la semaine appartenant au mois précédent
          const k=key(d), r=days[k]||null, t=totals(r), coD=cost(r), refD=refDaily(d);
          c+=t.cl; j+=t.j; a+=t.a; co+=coD; ec+=Math.max(refD-coD,0); dayCount++;
        }
        labels.push('S' + (labels.length + 1));
        C.push(c); J.push(j); A.push(a); CO.push(+co.toFixed(2)); EC.push(+ec.toFixed(2));
        wStart = new Date(wEnd.getFullYear(), wEnd.getMonth(), wEnd.getDate()+1, 0,0,0,0);
      }
    } else { // annee
      const y=now.getFullYear();
      for(let m=0;m<12;m++){
        const m1=new Date(y,m,1), m2=new Date(y,m+1,0,23,59,59,999);
        let c=0,j=0,a=0,co=0,ec=0;
        for(let d=new Date(m1); d<=m2; d.setDate(d.getDate()+1)){
          const k=key(d), r=days[k]||null, t=totals(r), coD=cost(r), refD=refDaily(d);
          c+=t.cl; j+=t.j; a+=t.a; co+=coD; ec+=Math.max(refD-coD,0);
        }
        labels.push(new Date(y,m,1).toLocaleString('fr-FR',{month:'short'}));
        C.push(c); J.push(j); A.push(a); CO.push(+co.toFixed(2)); EC.push(+ec.toFixed(2));
      }
    }
    return { labels, consos:{clopes:C, joints:J, alcool:A}, cout:CO, economies:EC };
  }

  // Remplace seulement le builder (on garde ton rendu SA3 existant)
  if (!window.StopAddictCharts) window.StopAddictCharts = {};
  window.StopAddictCharts.buildSeriesForCurrentView = buildSeriesAX;

  // Re-render immédiat pour aligner l’UI
  try{ window.updateAllUI?.(); }catch(e){}
})();
</script>
<script>
/* SA-CSV v1 — Export CSV (Excel) des séries affichées */
(function(){
  if (window.__SA_CSV__) return; window.__SA_CSV__=true;

  function ensureButton(){
    const bar = document.getElementById('chart-actions'); if (!bar) return null;
    let btn = bar.querySelector('#btn-export-csv');
    if (!btn){
      btn = document.createElement('button');
      btn.id = 'btn-export-csv';
      btn.className = 'btn';
      btn.textContent = 'Exporter CSV (Excel)';
      bar.appendChild(btn);
    }
    return btn;
  }

  function csvEscape(s){ if (s==null) return ''; s=String(s); if (s.includes(';')||s.includes('"')||s.includes('\n')) s='"'+s.replace(/"/g,'""')+'"'; return s; }

  function buildCSV(){
    const NS = window.StopAddictCharts; if (!NS) return '';
    const st = window.StopAddictChartsState || {visible:{}};
    const S = NS.buildSeriesForCurrentView?.(); if (!S) return '';

    // colonnes selon légende visible
    const cols = ['label'];
    if (st.visible?.clopes!==false) cols.push('clopes');
    if (st.visible?.joints!==false) cols.push('joints');
    if (st.visible?.alcool!==false) cols.push('alcool');
    if (st.visible?.cout!==false) cols.push('cout');
    if (st.visible?.economies!==false) cols.push('economies');

    const lines = [];
    lines.push(cols.join(';'));

    for (let i=0;i<S.labels.length;i++){
      const row = [S.labels[i]];
      if (cols.includes('clopes')) row.push(S.consos?.clopes?.[i] ?? '');
      if (cols.includes('joints')) row.push(S.consos?.joints?.[i] ?? '');
      if (cols.includes('alcool')) row.push(S.consos?.alcool?.[i] ?? '');
      if (cols.includes('cout')) row.push(S.cout?.[i] ?? '');
      if (cols.includes('economies')) row.push(S.economies?.[i] ?? '');
      lines.push(row.map(csvEscape).join(';'));
    }
    return '\uFEFF' + lines.join('\n'); // BOM UTF-8 pour Excel
  }

  function downloadCSV(){
    const view = window.vueStats || 'mois';
    const csv = buildCSV(); if (!csv) return;
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `stopaddict_${view}.csv`;
    document.body.appendChild(a); a.click(); document.body.removeChild(a);
    URL.revokeObjectURL(a.href);
  }

  const btn = ensureButton();
  if (btn){
    btn.addEventListener('click', (e)=>{ e.preventDefault(); downloadCSV(); });
  }
})();
</script>
<script>
/* SA-DIAG v1 — Logger central + intégration au bouton "Copier les logs" */
(function(){
  if (window.__SA_DIAG__) return; window.__SA_DIAG__=true;
  const buf = window.__sa_diag_buf = window.__sa_diag_buf || [];
  const ts = ()=> new Date().toISOString().replace('T',' ').replace('Z','');

  function log(kind, obj){
    try{ buf.push(`[${ts()}] ${kind}: ` + (typeof obj==='string'? obj : JSON.stringify(obj))); if (buf.length>8000) buf.shift(); }catch(e){}
  }

  // Trace les (re)calculs de séries
  const NS = window.StopAddictCharts || {};
  const origBuild = NS.buildSeriesForCurrentView;
  if (typeof origBuild==='function' && !origBuild.__sa_diag){
    NS.buildSeriesForCurrentView = function(){
      const v = window.vueStats || 'mois';
      const out = origBuild.apply(this, arguments);
      try{
        const sum = a => (a||[]).reduce((s,x)=>s+(+x||0),0);
        log('SERIES_SUMMARY', {vue:v, labels:out?.labels?.length||0,
          sumC:sum(out?.consos?.clopes), sumJ:sum(out?.consos?.joints), sumA:sum(out?.consos?.alcool),
          sumCO:sum(out?.cout), sumEC:sum(out?.economies)});
      }catch(e){}
      return out;
    };
    NS.buildSeriesForCurrentView.__sa_diag=true;
    window.StopAddictCharts = NS;
  }

  // Clics calendrier (on note la clé demandée)
  document.addEventListener('click', (ev)=>{
    const grid = document.getElementById('cal-grille');
    if (grid && grid.contains(ev.target)){
      const cell = ev.target.closest('[data-date], .cal-cell, .day');
      if (cell){
        const raw = cell.getAttribute('data-date') || (cell.textContent||'').trim();
        log('CAL_CLICK', {raw});
      }
    }
  }, true);

  // Intègre le buffer diag au bouton "Copier les logs"
  document.addEventListener('click', async (ev)=>{
    const btn = ev.target.closest('#btn-copy-logs,[data-action="copy-logs"]'); if (!btn) return;
    ev.preventDefault(); ev.stopPropagation();
    try{
      const payload = {
        vue: window.vueStats,
        diag: buf.slice(-600)
      };
      const text = JSON.stringify(payload, null, 2);
      let ok=false;
      if (navigator.clipboard?.writeText){ try{ await navigator.clipboard.writeText(text); ok=true; }catch(e){} }
      if (!ok){
        const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select();
        try{ ok=document.execCommand('copy'); }catch(e){}
        document.body.removeChild(ta);
      }
      if (!ok) window.prompt('Copiez (long-press) :', text);
    }catch(e){}
  }, true);

  // Première trace
  log('BOOT', {vue: window.vueStats});
})();
</script>
<script>
/* === SA-CAL-WRITE v1 — Force l’écriture sur le jour sélectionné (clé locale) === */
(function(){
  if (window.__SA_CAL_WRITE__) return; window.__SA_CAL_WRITE__ = true;

  // --- Utils: clé locale YYYY-MM-DD (sans UTC)
  function keyLocal(d){
    if (!(d instanceof Date)) d = new Date(d);
    return [
      d.getFullYear(),
      String(d.getMonth()+1).padStart(2,'0'),
      String(d.getDate()).padStart(2,'0')
    ].join('-');
  }
  function parseYmdLocal(s){
    if (typeof s === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(s)) {
      const [y,m,da] = s.split('-').map(Number);
      return new Date(y, m-1, da, 12, 0, 0, 0); // midi local => jamais la veille
    }
    return null;
  }

  // --- État override actif quand la modale "jour" est affichée
  window.__sa_current_date_key = window.__sa_current_date_key || null;

  // 1) À chaque focus d’un jour via le calendrier, capture la clé locale
  ['focusCalendrierDate','setCalendarFocusDate'].forEach(fn=>{
    const prev = window[fn];
    if (typeof prev === 'function' && !prev.__sa_cal_write){
      window[fn] = function(arg){
        // normalise l’argument en clé locale
        let k;
        if (arg instanceof Date) k = keyLocal(arg);
        else if (typeof arg === 'string') {
          if (/^\d{4}-\d{2}-\d{2}$/.test(arg)) k = arg;
          else if (/^\d{4}-\d{2}-\d{2}T/.test(arg)) k = keyLocal(new Date(arg));
          else { const d = new Date(arg); k = keyLocal(d); }
        } else k = keyLocal(new Date());
        window.__sa_current_date_key = k; // active l’override
        return prev.call(this, k);
      };
      window[fn].__sa_cal_write = true;
    }
  });

  // 2) Si un “dateKey()” global existe et sert aux écritures, on le fait pointer sur la clé sélectionnée
  (function patchDateKey(){
    const prev = window.dateKey;
    window.dateKey = function(){
      if (window.__sa_current_date_key) return window.__sa_current_date_key; // override actif
      if (typeof prev === 'function') {
        try {
          const k = prev(); // compat : peut déjà renvoyer une chaîne
          if (typeof k === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(k)) return k;
          if (k instanceof Date) return keyLocal(k);
        } catch(e){}
      }
      return keyLocal(new Date());
    };
  })();

  // 3) En cas d’écriture qui construirait sa propre Date, on injecte la clé dans la modale pour servir de référence
  function exposeModalKey(){
    const dlg = document.getElementById('cal-jour'); if (!dlg) return;
    // si la modale porte déjà la bonne clé, on la garde
    if (dlg.dataset && dlg.dataset.date && /^\d{4}-\d{2}-\d{2}$/.test(dlg.dataset.date)) return;
    if (window.__sa_current_date_key) {
      dlg.dataset.date = window.__sa_current_date_key;
    }
  }

  // 4) Quand on clique dans la modale (boutons +1/-1), on (ré)impose la clé override juste avant les handlers natifs
  document.addEventListener('click', function(ev){
    const dlg = document.getElementById('cal-jour');
    if (!dlg || !dlg.contains(ev.target)) return;
    // on s’assure que la modale porte la clé et on (ré)active l’override
    exposeModalKey();
    const k = (dlg.dataset && dlg.dataset.date) ? dlg.dataset.date : null;
    if (k && /^\d{4}-\d{2}-\d{2}$/.test(k)) window.__sa_current_date_key = k;
  }, true);

  // 5) À la fermeture de la modale, on lève l’override (retour au comportement normal)
  document.addEventListener('click', function(ev){
    const btn = ev.target.closest('#cal-jour-fermer, [data-action="cal-jour-fermer"]');
    if (!btn) return;
    window.__sa_current_date_key = null;
    const dlg = document.getElementById('cal-jour'); if (dlg && dlg.dataset) delete dlg.dataset.date;
  }, true);

  // 6) Sécurité : si on change d’écran (Stats/Accueil/Habitudes/Réglages), on lève l’override
  document.addEventListener('click', function(ev){
    const nav = ev.target.closest('#nav-stats,#nav-principal,#nav-habitudes,#nav-params,#nav-calendrier');
    if (!nav) return;
    if (nav.id !== 'nav-calendrier') { // rester actif uniquement en calendrier
      window.__sa_current_date_key = null;
      const dlg = document.getElementById('cal-jour'); if (dlg && dlg.dataset) delete dlg.dataset.date;
    }
  }, true);

  // 7) Premier passage : si la modale est déjà ouverte, on fixe la clé au besoin
  document.addEventListener('DOMContentLoaded', function(){
    const dlg = document.getElementById('cal-jour');
    if (dlg && window.__sa_current_date_key) exposeModalKey();
  });
})();
</script>
<script>
(function(){
  function onReady(fn){ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }

  onReady(function(){
    // 1) Afficher la barre d’actions globale si elle existe
    const globalBar = document.getElementById('chart-actions');
    if (globalBar) {
      globalBar.hidden = false;
      }

    // 2) Pour chaque canvas connu, ajouter au besoin : bouton export + bandeau d’abscisses
    const canvasIds = ['chart-consommations', 'chart-cout-eco'];
    canvasIds.forEach(setupForCanvas);

    // 3) Recalcule la bandeau d’abscisses quand on change de vue
    const viewRadios = document.querySelectorAll('[name="stats-view"]');
    viewRadios.forEach(r => r.addEventListener('change', refreshAllXAxis));
    const viewSelect = document.getElementById('stats-view');
    if (viewSelect) viewSelect.addEventListener('change', refreshAllXAxis);

    // ---- helpers -------------------------------------------------------------

    function setupForCanvas(id){
      const cv = document.getElementById(id);
      if (!cv) return;
      const wrap = cv.parentElement || cv;

      // Bouton export local si pas de barre globale
      if (!globalBar && !wrap.querySelector('.btn-export-csv')) {
        const actions = document.createElement('div');
        actions.className = 'chart-actions';
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-export-csv';
        btn.textContent = 'Exporter CSV (Excel)';
        btn.addEventListener('click', function(){
          exportNearestTableCSV(cv, filenamePrefix() + '_' + id + '.csv');
        });
        actions.appendChild(btn);
        wrap.appendChild(actions);
      }

      // Bandeau des abscisses (en dessous du canvas)
      /* désactivé */ if (false && !wrap.querySelector('.x-axis-overlay')) {
        const xbar = document.createElement('div');
        xbar.className = 'x-axis-overlay';
        xbar.style.fontSize = '12px';
        xbar.style.opacity  = '0.8';
        xbar.style.marginTop = '6px';
        xbar.style.display = 'grid';
        xbar.style.gridAutoFlow = 'column';
        xbar.style.justifyContent = 'space-between';
        xbar.style.userSelect = 'none';
        wrap.appendChild(xbar);
      }
      refreshXAxisFor(wrap.querySelector('.x-axis-overlay'));
    }

    function refreshAllXAxis(){
      document.querySelectorAll('.x-axis-overlay').forEach(refreshXAxisFor);
    }

    function refreshXAxisFor(container){
      if (!container) return;
      const labels = labelsFor(currentView());
      container.innerHTML = '';
      labels.forEach(l=>{
        const s = document.createElement('span');
        s.textContent = l;
        s.style.whiteSpace = 'nowrap';
        container.appendChild(s);
      });
    }

    function currentView(){
      return document.querySelector('[name="stats-view"]:checked')?.value
          || document.getElementById('stats-view')?.value
          || 'jour';
    }

    function labelsFor(view){
  		switch(view){
    			case 'jour':
    			case 'day':
      				return ['00h–07h','07h–14h','14h–21h','21h–00h'];
    			case 'semaine':
    			case 'week':
      				return ['Lu','Ma','Me','Je','Ve','Sa','Di'];
    			case 'mois':
    			case 'month':
      				return ['S1','S2','S3','S4','S5'];
    			case 'annee':
    			case 'year':
      				return ['01–03','03–06','06–09','09–12'];
    			default:
     				return [];
  		}
}



    function filenamePrefix(){
      const v = currentView();
      return 'stats_' + (v || 'vue');
    }

    // ---- export CSV ----------------------------------------------------------


    function exportNearestTableCSV(canvas, filename){
      const tbl = canvas?.parentElement?.querySelector('table') || canvas?.closest('section,div')?.querySelector('table');
      if (!tbl) { alert("Tableau des données introuvable."); return; }
      downloadCSV(filename, tableToCSV(tbl));
    }

    function tableToCSV(table){
      const lines = [];
      for (const row of table.rows){
        const cells = Array.from(row.cells).map(td=>{
          let txt = td.innerText.replace(/\r?\n|\r/g,' ').trim();
          if (/[",;\t;]/.test(txt)) txt = '"' + txt.replace(/"/g,'""') + '"';
          return txt;
        });
        // séparateur ; compatible Excel FR
        lines.push(cells.join(';'));
      }
      return lines.join('\n');
    }

    function downloadCSV(filename, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = filename;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }
  });
})();
</script>
<script>
// Purge ciblée des données locales liées aux jours (YYYY-MM-DD) pour éviter les artefacts dans les Stats
function purgeLocalStats(){
  if (!confirm("Confirmer la purge des données locales (Stats) ?\n\nCela efface, dans le stockage du navigateur, les éléments qui ressemblent à des journées (YYYY-MM-DD).\nVos réglages et données internes restent intacts.")) return;

  const keysToRemove = [];
  for (let i = 0; i < localStorage.length; i++) {
    const K = localStorage.key(i);
    let val = null;
    try { val = JSON.parse(localStorage.getItem(K) || 'null'); } catch(e) {}
    if (!val || typeof val !== 'object') continue;

    // 1) Objet directement indexé par yyyy-mm-dd
    const ks = Object.keys(val);
    const looksLikeDaysMap = ks.length > 0 && ks.every(x => /^\d{4}-\d{2}-\d{2}$/.test(x));

    // 2) Objet { days: { yyyy-mm-dd: {...} } }
    const hasDaysObject = !!(val.days && typeof val.days === 'object'
      && Object.keys(val.days).some(x => /^\d{4}-\d{2}-\d{2}$/.test(x)));

    if (looksLikeDaysMap || hasDaysObject) {
      keysToRemove.push(K);
    }
  }

  keysToRemove.forEach(K => localStorage.removeItem(K));

  // Rafraîchit l'UI et les graphes
  try { updateAllUI?.(); } catch(e){}
  try { updateStatsBloc?.(); } catch(e){}
  window.dispatchEvent(new Event('resize'));

  alert("Purge terminée : " + keysToRemove.length + " clé(s) supprimée(s) du stockage local.");
}
</script>

<script>
/* ========== FIX 1 : Checkbox "J'en fume" (Cannabis) ========== */
(function(){
  if (window.__fix_enable_joints) return; window.__fix_enable_joints = true;

  // 1) Garantir la clé dans params
  if (typeof window.params === 'object' && window.params) {
    if (!('enable_joints' in window.params)) {
      window.params.enable_joints = true; // défaut : activé
      try { window.persist && window.persist(); } catch(e){}
    }
  }

  // 2) Injection DOM robuste dans la section Cannabis
  function findCannabisGrid(){
    // cherche un titre contenant "Cannabis", puis la grille immédiatement après
    const titles = document.querySelectorAll('.section-title, h3, h4');
    for (const t of titles) {
      const txt = (t.textContent||'').trim().toLowerCase();
      if (txt.includes('cannabis')) {
        const grid = t.nextElementSibling;
        if (grid && (grid.classList?.contains('grid-2') || grid.classList?.contains('grid'))) {
          return grid;
        }
      }
    }
    // fallback : id/ancres nommées
    return document.querySelector('#params-cannabis .grid-2, #params-cannabis .grid');
  }

  function injectCheckbox(){
    const grid = findCannabisGrid();
    if (!grid) return false;
    if (grid.querySelector('#enable-joints')) return true; // déjà là

    const wrap = document.createElement('div');
    wrap.className = 'param';

    const label = document.createElement('label');
    label.setAttribute('for','enable-joints');
    label.textContent = "J'en fume";

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = 'enable-joints';
    input.checked = !!(window.params && window.params.enable_joints);

    // Petite mise en forme cohérente avec le reste
    label.style.display = 'inline-block';
    label.style.marginRight = '8px';
    input.style.transform = 'translateY(2px)';

    wrap.appendChild(label);
    wrap.appendChild(input);

    // on l’insère en tête de la grille
    grid.insertBefore(wrap, grid.firstChild);
    return true;
  }

  function bindCheckbox(){
    const chk = document.getElementById('enable-joints');
    if (!chk || chk.__bound) return;
    chk.__bound = true;

    chk.addEventListener('change', function(){
      if (typeof window.params === 'object' && window.params) {
        window.params.enable_joints = !!chk.checked;
      }
      try { window.persist && window.persist(); } catch(e){}
      try { window.updateAllUI && window.updateAllUI(); } catch(e){}
      console.log('[FIX] enable_joints =', !!chk.checked);
    });
  }

  function init(){
    if (injectCheckbox()) { bindCheckbox(); }
    else { setTimeout(init, 150); } // DOM pas prêt → on réessaie
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

/* ========== FIX 2 : Libellés des deux boutons en bas de Stats ========== */
(function(){
  if (window.__fix_stats_buttons_labels) return; window.__fix_stats_buttons_labels = true;

  function ensureLabels(){
    // cible large : section stats
    const stats = document.getElementById('ecran-stats') || document.querySelector('[data-screen="stats"]');
    if (!stats) return;

    // trouve des boutons sans texte visible (icône seule)
    const btns = stats.querySelectorAll('button, a.btn, .btn');
    btns.forEach((b)=>{
      const txt = (b.textContent || '').trim();
      const hasMeaningful = txt && !/^[\W_]+$/.test(txt); // pas juste des emojis/symboles

      // heuristique : si vide ou juste symbole, on pose un libellé selon l’ID ou l’ordre
      if (!hasMeaningful) {
        const id = (b.id||'').toLowerCase();
        if (id.includes('csv')) {
          b.textContent = 'Exporter CSV';
        } else if (id.includes('json') || id.includes('save')) {
          b.textContent = 'Sauvegarder JSON';
        } else if (!b.textContent.trim()) {
          // fallback : premier bouton → CSV, deuxième → JSON
          if (!b.__fixedLabel) {
            const siblings = Array.from(btns);
            const idx = siblings.indexOf(b);
            b.textContent = (idx === 0) ? 'Exporter CSV' : 'Sauvegarder JSON';
            b.__fixedLabel = true;
          }
        }
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureLabels);
  } else {
    ensureLabels();
  }
})();
</script>
<script>
/* ========== FIX 1 : Checkbox "J'en fume" (Cannabis) ========== */
(function(){
  if (window.__fix_enable_joints) return; window.__fix_enable_joints = true;

  // 1) Garantir la clé dans params
  if (typeof window.params === 'object' && window.params) {
    if (!('enable_joints' in window.params)) {
      window.params.enable_joints = true; // défaut : activé
      try { window.persist && window.persist(); } catch(e){}
    }
  }

  // 2) Injection DOM robuste dans la section Cannabis
  function findCannabisGrid(){
    // cherche un titre contenant "Cannabis", puis la grille immédiatement après
    const titles = document.querySelectorAll('.section-title, h3, h4');
    for (const t of titles) {
      const txt = (t.textContent||'').trim().toLowerCase();
      if (txt.includes('cannabis')) {
        const grid = t.nextElementSibling;
        if (grid && (grid.classList?.contains('grid-2') || grid.classList?.contains('grid'))) {
          return grid;
        }
      }
    }
    // fallback : id/ancres nommées
    return document.querySelector('#params-cannabis .grid-2, #params-cannabis .grid');
  }

  function injectCheckbox(){
    const grid = findCannabisGrid();
    if (!grid) return false;
    if (grid.querySelector('#enable-joints')) return true; // déjà là

    const wrap = document.createElement('div');
    wrap.className = 'param';

    const label = document.createElement('label');
    label.setAttribute('for','enable-joints');
    label.textContent = "J'en fume";

    const input = document.createElement('input');
    input.type = 'checkbox';
    input.id = 'enable-joints';
    input.checked = !!(window.params && window.params.enable_joints);

    // Petite mise en forme cohérente avec le reste
    label.style.display = 'inline-block';
    label.style.marginRight = '8px';
    input.style.transform = 'translateY(2px)';

    wrap.appendChild(label);
    wrap.appendChild(input);

    // on l’insère en tête de la grille
    grid.insertBefore(wrap, grid.firstChild);
    return true;
  }

  function bindCheckbox(){
    const chk = document.getElementById('enable-joints');
    if (!chk || chk.__bound) return;
    chk.__bound = true;

    chk.addEventListener('change', function(){
      if (typeof window.params === 'object' && window.params) {
        window.params.enable_joints = !!chk.checked;
      }
      try { window.persist && window.persist(); } catch(e){}
      try { window.updateAllUI && window.updateAllUI(); } catch(e){}
      console.log('[FIX] enable_joints =', !!chk.checked);
    });
  }

  function init(){
    if (injectCheckbox()) { bindCheckbox(); }
    else { setTimeout(init, 150); } // DOM pas prêt → on réessaie
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

/* ========== FIX 2 : Libellés des deux boutons en bas de Stats ========== */
(function(){
  if (window.__fix_stats_buttons_labels) return; window.__fix_stats_buttons_labels = true;

  function ensureLabels(){
    // cible large : section stats
    const stats = document.getElementById('ecran-stats') || document.querySelector('[data-screen="stats"]');
    if (!stats) return;

    // trouve des boutons sans texte visible (icône seule)
    const btns = stats.querySelectorAll('button, a.btn, .btn');
    btns.forEach((b)=>{
      const txt = (b.textContent || '').trim();
      const hasMeaningful = txt && !/^[\W_]+$/.test(txt); // pas juste des emojis/symboles

      // heuristique : si vide ou juste symbole, on pose un libellé selon l’ID ou l’ordre
      if (!hasMeaningful) {
        const id = (b.id||'').toLowerCase();
        if (id.includes('csv')) {
          b.textContent = 'Exporter CSV';
        } else if (id.includes('json') || id.includes('save')) {
          b.textContent = 'Sauvegarder JSON';
        } else if (!b.textContent.trim()) {
          // fallback : premier bouton → CSV, deuxième → JSON
          if (!b.__fixedLabel) {
            const siblings = Array.from(btns);
            const idx = siblings.indexOf(b);
            b.textContent = (idx === 0) ? 'Exporter CSV' : 'Sauvegarder JSON';
            b.__fixedLabel = true;
          }
        }
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureLabels);
  } else {
    ensureLabels();
  }
})();
</script>
<script>
/* ========== FIX LABELS BOUTONS STATS (robuste, compatible icônes/SVG) ========== */
(function(){
  if (window.__fix_stats_labels_v2) return; window.__fix_stats_labels_v2 = true;

  function isMeaningfulText(el){
    const txt = (el.textContent || '').replace(/\s+/g,' ').trim();
    // considère qu’il n’y a pas de “vrai” texte si seulement symboles/emoji
    return /[A-Za-zÀ-ÖØ-öø-ÿ0-9]/.test(txt);
  }

  function addLabel(btn, label){
    if (!btn) return;
    // si un label est déjà présent, on ne double pas
    if (btn.querySelector('.btn-label')) return;

    const span = document.createElement('span');
    span.className = 'btn-label';
    span.textContent = label;
    // style minimal pour s’afficher à côté d’une icône
    span.style.marginLeft = '8px';
    span.style.fontWeight = '600';
    span.style.fontSize = '0.95rem';
    btn.appendChild(span);

    // accessibilité
    if (!btn.getAttribute('aria-label')) btn.setAttribute('aria-label', label);
    if (!btn.title) btn.title = label;
  }

  function ensureStatsButtonsLabels(){
    const stats = document.getElementById('ecran-stats') || document.querySelector('[data-screen="stats"]');
    if (!stats) return;

    // On cherche d’abord une zone d’actions en bas
    const actionZones = [
      stats.querySelector('.stats-actions'),
      stats.querySelector('.actions'),
      stats.querySelector('.stats-footer'),
      stats // fallback : tout l’écran stats
    ].filter(Boolean);

    // Agrège les boutons potentiels
    const btns = [];
    actionZones.forEach(zone=>{
      zone.querySelectorAll('button, .btn, a.btn').forEach(b => btns.push(b));
    });

    if (!btns.length) return;

    // 1) Pose les bons libellés si on reconnaît csv/json
    btns.forEach(b=>{
      const id = (b.id||'').toLowerCase();
      const dataAct = (b.getAttribute('data-action')||'').toLowerCase();
      const hint = id + ' ' + dataAct;

      if (hint.includes('csv')) addLabel(b, 'Exporter CSV');
      else if (hint.includes('json') || hint.includes('save')) addLabel(b, 'Sauvegarder JSON');
    });

    // 2) Si aucun label textuel lisible, on nomme les DEUX derniers boutons trouvés
    const needs = btns.filter(b => !isMeaningfulText(b) && !b.querySelector('.btn-label'));
    if (needs.length >= 2){
      addLabel(needs[needs.length-2], 'Exporter CSV');
      addLabel(needs[needs.length-1], 'Sauvegarder JSON');
    } else if (needs.length === 1){
      // au moins un bouton : on lui met un libellé par défaut
      addLabel(needs[0], 'Exporter CSV');
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', ensureStatsButtonsLabels);
  } else {
    ensureStatsButtonsLabels();
  }
})();
</script>
<script>
/* === SA_EXPORT_ENABLE_FIX v1 — active les deux boutons d’export quand les stats sont prêtes === */
(function () {
  function enableExports() {
    ['btn-export-csv', 'btn-export-stats'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.removeAttribute('disabled');           // enlève l'état désactivé
      el.classList.remove('disabled');          // au cas où
      el.style.opacity = '';                    // nettoie un éventuel override inline
      el.style.pointerEvents = '';              // idem
    });
  }

  // 1) À l’ouverture de la page
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', enableExports);
  } else {
    enableExports();
  }

  // 2) Quand on navigue vers l’écran "Stats"
  const prevGoto = window.goto;
  if (typeof prevGoto === 'function' && !prevGoto.__sa_export_fix) {
    window.goto = function (screen) {
      const r = prevGoto.apply(this, arguments);
      if (screen === 'stats') setTimeout(enableExports, 50);
      return r;
    };
    window.goto.__sa_export_fix = true;
  }

  // 3) Après chaque rendu des graphes (sécurité supplémentaire)
  const NS = window.StopAddictCharts || {};
  const prevRender = NS.render;
  if (typeof prevRender === 'function' && !prevRender.__sa_export_fix) {
    NS.render = function () {
      const out = prevRender.apply(this, arguments);
      // le rendu est async côté chart → petit délai
      setTimeout(enableExports, 0);
      return out;
    };
    NS.render.__sa_export_fix = true;
    window.StopAddictCharts = NS;
  }
})();
</script>
<script>
/* === FIX LABELS EXPORT - Version robuste avec style forcé === */
(function(){
  if (window.__fix_export_v2) return; 
  window.__fix_export_v2 = true;

  function forceButtonLabels(){
    // Trouve la zone d'actions sous les graphiques
    const chartActions = document.getElementById('chart-actions');
    if (!chartActions) {
      console.log('[FIX] chart-actions introuvable');
      return;
    }

    // Trouve TOUS les boutons dans cette zone
    const allButtons = chartActions.querySelectorAll('button, .btn');
    console.log('[FIX] Boutons trouvés:', allButtons.length);

    if (allButtons.length < 2) return;

    // Premier bouton = Export complet
    const btn1 = allButtons[0];
    btn1.textContent = 'Exporter historique complet (Excel)';
    btn1.style.fontSize = '0.9rem';
    btn1.style.padding = '8px 12px';
    btn1.style.minWidth = '200px';
    btn1.style.whiteSpace = 'normal';
    btn1.style.lineHeight = '1.3';
    btn1.title = 'Télécharge toutes vos données';

    // Deuxième bouton = Export vue actuelle
    const btn2 = allButtons[1];
    const vue = window.vueStats || 'mois';
    const labels = {
      'semaine': 'cette semaine',
      'mois': 'ce mois',
      'annee': 'cette année', jour: 'aujourd’hui', };
    btn2.textContent = `Exporter ${labels[vue] || 'la vue actuelle'}`;
    btn2.style.fontSize = '0.9rem';
    btn2.style.padding = '8px 12px';
    btn2.style.minWidth = '180px';
    btn2.style.whiteSpace = 'normal';
    btn2.style.lineHeight = '1.3';
    btn2.title = 'Télécharge uniquement le graphique affiché';

    console.log('[FIX] Labels appliqués:', btn1.textContent, '|', btn2.textContent);
  }

  // Essaie plusieurs fois au chargement
  function tryMultiple(){
    forceButtonLabels();
    setTimeout(forceButtonLabels, 100);
    setTimeout(forceButtonLabels, 300);
    setTimeout(forceButtonLabels, 600);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tryMultiple);
  } else {
    tryMultiple();
  }

  // Quand on change de vue
  const prevSet = window.setStatsView;
  if (typeof prevSet === 'function' && !prevSet.__fix_v2) {
    window.setStatsView = function(v){
      const r = prevSet.apply(this, arguments);
      setTimeout(forceButtonLabels, 100);
      return r;
    };
    window.setStatsView.__fix_v2 = true;
  }

  // Quand on ouvre Stats
  const prevGoto = window.goto;
  if (typeof prevGoto === 'function' && !prevGoto.__fix_v2) {
    window.goto = function(screen){
      const r = prevGoto.apply(this, arguments);
      if (screen === 'stats') setTimeout(forceButtonLabels, 150);
      return r;
    };
    window.goto.__fix_v2 = true;
  }
})();
</script>
<script>
/* === FIX RENDER INITIAL STATS + Vue par défaut === */
(function(){
  if (window.__STATS_INIT_FIX) return;
  window.__STATS_INIT_FIX = true;

  var prevGoto = window.goto;
  if (typeof prevGoto === 'function') {
    window.goto = function(screen){
      // AVANT d'appeler goto original, vérifie si c'est la première visite
      if (screen === 'stats' || screen === 'ecran-stats') {
        var stored = null;
        try {
          stored = localStorage.getItem('app_vue_stats_v23');
        } catch(e) {}
        
        // Si pas de préférence sauvegardée OU si c'est "jour", force "semaine" par défaut
        // (car "jour" était la valeur par défaut avant, on veut "semaine" maintenant)
        if (!stored || stored === 'null' || stored === '""' || stored === '' || stored === '"jour"' || stored === 'jour') {
          console.log('[STATS_INIT] Force semaine par défaut (première visite ou ancien défaut)');
          window.vueStats = 'jour';
          try {
            localStorage.setItem('app_vue_stats_v23', '"jour"');
          } catch(e) {}
          
          // Synchronise les boutons immédiatement
          setTimeout(function(){
            try {
              if (typeof refreshStatsTabsUI === 'function') {
                refreshStatsTabsUI();
                console.log('[STATS_INIT] Tabs UI synchronisés sur jour');
              }
            } catch(e) {}
          }, 10);
        } else {
          console.log('[STATS_INIT] Préférence utilisateur détectée:', stored);
        }
      }
      
      var r = prevGoto.apply(this, arguments);
      
      if (screen === 'stats' || screen === 'ecran-stats') {
        setTimeout(function(){
          try {
            // Force a resize to recalc Chart.js layout
            try { window.dispatchEvent(new Event('resize')); } catch(e){}
            // Re-render charts if the app exposes a render hook
            if (window.StopAddictCharts && typeof window.StopAddictCharts.render === 'function') {
              window.StopAddictCharts.render();
            }
          } catch(e) {}
        }, 200);
      }
      return r;
    };
  }

  try { console.log('[STATS_INIT] Fix installé'); } catch(e){}
})();
</script>
<script>
/* ========================================================================
   SA_JOUR_FINAL - Vue "Jour" avec tranches horaires (AUTONOME)
   ======================================================================== */
(function(){
  if (window.__SA_JOUR_FINAL) return;
  window.__SA_JOUR_FINAL = true;

  console.log('[SA_JOUR_FINAL] Démarrage...');

  // Parse l'heure (ex: "14h30" → 14)
  function parseHeure(str) {
    if (!str || typeof str !== 'string') return null;
    const m = str.match(/^(\d{1,2})/);
    if (!m) return null;
    const h = parseInt(m[1], 10);
    return (h >= 0 && h <= 23) ? h : null;
  }

  // Détermine la tranche (0-3)
  function getTranche(h) {
    if (h == null || h < 0 || h > 23) return null;
    if (h < 7) return 0;
    if (h < 14) return 1;
    if (h < 21) return 2;
    return 3;
  }

  // Trouve la clé du jour
  function getDateKey() {
    try {
      if (typeof window.dateKey === 'function') {
        return window.dateKey(new Date());
      }
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth() + 1).padStart(2, '0');
      const d = String(now.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    } catch(e) {
      return null;
    }
  }

  // Distribue les timestamps dans les tranches
  function distributeTimestamps(record) {
    const tranches = [{cl:0,j:0,a:0},{cl:0,j:0,a:0},{cl:0,j:0,a:0},{cl:0,j:0,a:0}];
    
    if (!record || !Array.isArray(record.timestamps)) {
      return tranches;
    }

    for (let i = 0; i < record.timestamps.length; i++) {
      const ts = record.timestamps[i];
      if (!ts) continue;

      const h = parseHeure(ts.heure);
      const t = getTranche(h);
      if (t === null) continue;

      const delta = Math.abs(parseInt(ts.delta) || 0);
      const group = ts.group;

      if (group === 'clopes') tranches[t].cl += delta;
      else if (group === 'joints') tranches[t].j += delta;
      else if (group === 'alcool') tranches[t].a += delta;
    }

    return tranches;
  }

  // Calcule le coût
  function getCout(record) {
    try {
      if (typeof window.calculerCoutJour === 'function' && record) {
        return parseFloat(window.calculerCoutJour(record)) || 0;
      }
    } catch(e) {}
    return 0;
  }

  // Construit les séries pour "jour"
  function buildSeriesJour() {
    console.log('[SA_JOUR_FINAL] Construction séries jour');

    const labels = ['00–07', '07–14', '14–21', '21–00'];

    try {
      const key = getDateKey();
      if (!key) {
        console.warn('[SA_JOUR_FINAL] Pas de clé');
        return {labels, consos:{clopes:[0,0,0,0],joints:[0,0,0,0],alcool:[0,0,0,0]}, cout:[0,0,0,0], economies:[0,0,0,0]};
      }

      const donnees = window.donnees || {};
      const record = donnees[key];
      
      if (!record) {
        console.log('[SA_JOUR_FINAL] Pas de données pour', key);
        return {labels, consos:{clopes:[0,0,0,0],joints:[0,0,0,0],alcool:[0,0,0,0]}, cout:[0,0,0,0], economies:[0,0,0,0]};
      }

      const tranches = distributeTimestamps(record);
      
      const C = tranches.map(t => Math.max(0, t.cl));
      const J = tranches.map(t => Math.max(0, t.j));
      const A = tranches.map(t => Math.max(0, t.a));

      const coutTotal = getCout(record);
      const CO = [coutTotal/4, coutTotal/4, coutTotal/4, coutTotal/4];
      const EC = [0, 0, 0, 0];

      console.log('[SA_JOUR_FINAL] Séries OK:', {C, J, A});

      return {labels, consos:{clopes:C, joints:J, alcool:A}, cout:CO, economies:EC};

    } catch(e) {
      console.error('[SA_JOUR_FINAL] Erreur:', e);
      return {labels, consos:{clopes:[0,0,0,0],joints:[0,0,0,0],alcool:[0,0,0,0]}, cout:[0,0,0,0], economies:[0,0,0,0]};
    }
  }

  // Installation IMMÉDIATE
  function install() {
    if (!window.StopAddictCharts) window.StopAddictCharts = {};
    
    const originalBuild = window.StopAddictCharts.buildSeriesForCurrentView;
    
    window.StopAddictCharts.buildSeriesForCurrentView = function() {
      const view = window.vueStats || 'mois';
      
      if (view === 'jour') {
        return buildSeriesJour();
      }
      
      if (typeof originalBuild === 'function') {
        return originalBuild.apply(this, arguments);
      }
      
      return null;
    };
    
    console.log('[SA_JOUR_FINAL] Hook installé');
  }

  // Installation immédiate
  install();
  
  // Réinstalle après 100ms au cas où un autre script écrase
  setTimeout(install, 100);
  
})();
</script>
<script>
/* ========================================================================
   SA_JOUR_FINAL - Vue "Jour" avec tranches horaires (AUTONOME)
   ======================================================================== */
(function(){
  'use strict';
  
  if (window.__SA_JOUR_FINAL) return;
  window.__SA_JOUR_FINAL = true;

  console.log('[SA_JOUR_FINAL] Initialisation...');

  // ========== UTILITAIRES ==========
  
  /**
   * Parse l'heure d'un timestamp (ex: "14h30" → 14)
   */
  function parseHeure(heureStr) {
    if (!heureStr || typeof heureStr !== 'string') return null;
    const match = heureStr.match(/^(\d{1,2})/);
    if (!match) return null;
    const h = parseInt(match[1], 10);
    return (h >= 0 && h <= 23) ? h : null;
  }

  /**
   * Obtient les données du jour actuel
   */
  function getJourData() {
    try {
      if (typeof window.donnees === 'object' && typeof window.dateKey === 'function') {
        const key = window.dateKey();
        return window.donnees[key] || null;
      }
      return null;
    } catch(e) {
      console.error('[SA_JOUR_FINAL] Erreur getJourData:', e);
      return null;
    }
  }

  /**
   * Calcule le coût d'une consommation
   */
  function calculerCout(conso) {
    if (!conso || typeof window.params !== 'object') return 0;
    
    try {
      const p = window.params;
      let cout = 0;

      // Clopes classiques
      if (conso.cl_class > 0 && p.enable_classiques) {
        cout += (conso.cl_class / p.cigs_par_paquet) * p.prix_paquet;
      }

      // Clopes roulées
      if (conso.cl_roul > 0 && p.enable_roulees) {
        const prixTabac = (conso.cl_roul / p.cigs_par_30g_roul) * p.prix_tabac_roul;
        const prixFeuilles = (conso.cl_roul / p.feuilles_petite_par_carnet) * p.prix_feuille_petite;
        const prixFiltres = p.use_filtre_roulee ? (conso.cl_roul / p.filtres_par_sachet) * p.prix_filtre_ocb : 0;
        cout += prixTabac + prixFeuilles + prixFiltres;
      }

      // Clopes tubes
      if (conso.cl_tube > 0 && p.enable_tubes) {
        const prixTabac = (conso.cl_tube / p.cigs_par_30g_tube) * p.prix_tabac_roul;
        const prixTubes = (conso.cl_tube / p.tubes_par_boite) * p.prix_tubes;
        cout += prixTabac + prixTubes;
      }

      // Joints
      if (conso.joints > 0) {
        const prixWeed = conso.joints * p.grammes_par_joint * p.prix_gramme;
        const prixFeuilles = (conso.joints / p.feuilles_grande_par_carnet) * p.prix_feuille_grande;
        const prixFiltres = p.use_filtre_joint ? (conso.joints / p.filtres_par_sachet) * p.prix_filtre_ocb : 0;
        cout += prixWeed + prixFeuilles + prixFiltres;
      }

      // Alcool
      if (conso.alc_biere > 0 && p.enable_biere) {
        cout += conso.alc_biere * p.prix_biere;
      }
      if (conso.alc_fort > 0 && p.enable_fort) {
        cout += conso.alc_fort * p.prix_fort;
      }
      if (conso.alc_liqueur > 0 && p.enable_liqueur) {
        cout += conso.alc_liqueur * p.prix_liqueur;
      }

      return cout;
    } catch(e) {
      console.error('[SA_JOUR_FINAL] Erreur calculerCout:', e);
      return 0;
    }
  }

  /**
   * Calcule les économies potentielles (référence - coût réel)
   */
  function calculerEconomies(conso) {
    if (!conso || typeof window.habitudes !== 'object' || typeof window.params !== 'object') return 0;
    
    try {
      const h = window.habitudes;
      const p = window.params;
      
      // Référence = consommation maximale habituelle
      const refConso = {
        cl_class: h.max_cl_class || 0,
        cl_roul: h.max_cl_roul || 0,
        cl_tube: h.max_cl_tube || 0,
        joints: h.max_joint || 0,
        alc_biere: h.max_biere || 0,
        alc_fort: h.max_fort || 0,
        alc_liqueur: h.max_liqueur || 0
      };

      const coutRef = calculerCout(refConso);
      const coutReel = calculerCout(conso);
      
      return Math.max(0, coutRef - coutReel);
    } catch(e) {
      console.error('[SA_JOUR_FINAL] Erreur calculerEconomies:', e);
      return 0;
    }
  }

  // ========== CONSTRUCTION DES SÉRIES JOUR ==========

  /**
   * Construit les séries pour la vue "Jour" (4 tranches horaires)
   */
  function buildSeriesJour() {
    console.log('[SA_JOUR_FINAL] Construction des séries Jour...');
    
    const labels = ['00h–07h', '08h–15h', '16h–19h', '20h–23h'];
    
    try {
      const jourData = getJourData();
      
      if (!jourData || !Array.isArray(jourData.timestamps) || jourData.timestamps.length === 0) {
        console.log('[SA_JOUR_FINAL] Pas de données aujourd\'hui');
        return createEmptySeries(labels);
      }

      // Répartition par tranches
      const tranches = [
        { clopes: 0, joints: 0, alcool: 0 }, // 00h-07h
        { clopes: 0, joints: 0, alcool: 0 }, // 08h-15h
        { clopes: 0, joints: 0, alcool: 0 }, // 16h-19h
        { clopes: 0, joints: 0, alcool: 0 }  // 20h-23h
      ];

      // Parcours des timestamps
      jourData.timestamps.forEach(ts => {
        const heure = parseHeure(ts.heure);
        if (heure === null) return;

        let tranche = -1;
        if (heure >= 0 && heure <= 7) tranche = 0;
        else if (heure >= 8 && heure <= 15) tranche = 1;
        else if (heure >= 16 && heure <= 19) tranche = 2;
        else if (heure >= 20 && heure <= 23) tranche = 3;

        if (tranche === -1) return;

        // Clopes
        if (ts.type === 'clope_class' || ts.type === 'clope_roul' || ts.type === 'clope_tube') {
          tranches[tranche].clopes += Math.abs(ts.delta || 0);
        }
        // Joints
        else if (ts.type === 'joint') {
          tranches[tranche].joints += Math.abs(ts.delta || 0);
        }
        // Alcool
        else if (ts.type === 'alc_biere' || ts.type === 'alc_fort' || ts.type === 'alc_liqueur') {
          tranches[tranche].alcool += Math.abs(ts.delta || 0);
        }
      });

      const C = tranches.map(t => t.clopes);
      const J = tranches.map(t => t.joints);
      const A = tranches.map(t => t.alcool);

      // Calcul du coût et économies TOTAL du jour, réparti équitablement
      const coutTotal = calculerCout(jourData);
      const ecoTotal = calculerEconomies(jourData);

      const coutParTranche = coutTotal / 4;
      const ecoParTranche = ecoTotal / 4;

      const CO = [coutParTranche, coutParTranche, coutParTranche, coutParTranche];
      const EC = [ecoParTranche, ecoParTranche, ecoParTranche, ecoParTranche];

      console.log('[SA_JOUR_FINAL] Séries construites:', {
        clopes: C,
        joints: J,
        alcool: A,
        cout: CO,
        economies: EC
      });

      return {
        labels: labels,
        consos: {
          clopes: C,
          joints: J,
          alcool: A
        },
        cout: CO,
        economies: EC
      };

    } catch(e) {
      console.error('[SA_JOUR_FINAL] Erreur construction:', e);
      return createEmptySeries(labels);
    }
  }

  /**
   * Crée des séries vides (fallback)
   */
  function createEmptySeries(labels) {
    return {
      labels: labels,
      consos: {
        clopes: [0, 0, 0, 0],
        joints: [0, 0, 0, 0],
        alcool: [0, 0, 0, 0]
      },
      cout: [0, 0, 0, 0],
      economies: [0, 0, 0, 0]
    };
  }

  // ========== INTÉGRATION ==========

  /**
   * Hook dans buildSeriesForCurrentView
   */
  function installHook() {
    console.log('[SA_JOUR_FINAL] Installation du hook...');
    
    const NS = window.StopAddictCharts;
    if (!NS) {
      console.warn('[SA_JOUR_FINAL] StopAddictCharts non trouvé');
      return;
    }

    const originalBuild = NS.buildSeriesForCurrentView;
    if (typeof originalBuild !== 'function') {
      console.warn('[SA_JOUR_FINAL] buildSeriesForCurrentView non trouvé');
      return;
    }

    // Évite double hook
    if (originalBuild.__jourFinalHooked) {
      console.log('[SA_JOUR_FINAL] Déjà installé');
      return;
    }

    NS.buildSeriesForCurrentView = function() {
      const view = window.vueStats || 'mois';
      
      // Si vue "jour", utilise notre builder
      if (view === 'jour') {
        console.log('[SA_JOUR_FINAL] Build séries pour vue Jour');
        return buildSeriesJour();
      }
      
      // Sinon, appelle le builder original
      return originalBuild.apply(this, arguments);
    };

    NS.buildSeriesForCurrentView.__jourFinalHooked = true;
    console.log('[SA_JOUR_FINAL] Hook installé avec succès');
  }

  // ========== INITIALISATION ==========

  function init() {
    // Attend que le DOM soit prêt
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', installHook);
    } else {
      installHook();
    }

    // Double sécurité avec timeout
    setTimeout(installHook, 100);
  }

  init();
  console.log('[SA_JOUR_FINAL] Script chargé');
})();
</script>
<script>
/* ========================================================================
   SA_JOUR_ACTIVATION - Active le bouton "Jour" 
   ======================================================================== */
(function(){
  'use strict';
  
  if (window.__SA_JOUR_ACTIVATION) return;
  window.__SA_JOUR_ACTIVATION = true;

  console.log('[SA_JOUR_ACTIVATION] Initialisation...');

  /**
   * Active le clic sur le bouton "Jour"
   */
  function activerBoutonJour() {
    const btnJour = document.querySelector('.tabs button.tab[data-vue="jour"]');
    
    if (!btnJour) {
      console.warn('[SA_JOUR_ACTIVATION] Bouton Jour non trouvé');
      return;
    }

    // Écouteur de clic
    btnJour.addEventListener('click', function() {
      console.log('[SA_JOUR_ACTIVATION] Clic sur bouton Jour');
      
      try {
        // Change la vue globale
        window.vueStats = 'jour';
        
        // Sauvegarde dans localStorage
        try {
          localStorage.setItem('app_vue_stats_v23', '"jour"');
        } catch(e) {
          console.warn('[SA_JOUR_ACTIVATION] localStorage non disponible:', e);
        }
        
        // Active visuellement le bon bouton
        document.querySelectorAll('.tabs .tab').forEach(function(b) {
          b.classList.toggle('actif', b === btnJour);
        });
        
        // Rafraîchit l'UI Stats
        if (typeof updateBannerStats === 'function') {
          updateBannerStats();
        }
        
        if (typeof updateStatsBloc === 'function') {
          updateStatsBloc();
        }
        
        // Force le re-rendu des graphiques
        if (window.StopAddictCharts && typeof window.StopAddictCharts.render === 'function') {
          setTimeout(function() {
            window.StopAddictCharts.render();
          }, 50);
        }
        
        console.log('[SA_JOUR_ACTIVATION] Vue Jour activée');
        
      } catch(e) {
        console.error('[SA_JOUR_ACTIVATION] Erreur activation:', e);
      }
    });

    console.log('[SA_JOUR_ACTIVATION] Bouton Jour activé');
  }

  /**
   * Hook dans setStatsView pour gérer le changement de vue
   */
  function hookSetStatsView() {
    const originalSetStatsView = window.setStatsView;
    
    if (typeof originalSetStatsView !== 'function') {
      console.warn('[SA_JOUR_ACTIVATION] setStatsView non trouvé');
      return;
    }

    if (originalSetStatsView.__jourHooked) {
      console.log('[SA_JOUR_ACTIVATION] setStatsView déjà hooké');
      return;
    }

    window.setStatsView = function(v) {
      console.log('[SA_JOUR_ACTIVATION] setStatsView appelé avec:', v);
      
      // Si on change pour "jour", assure-toi que window.vueStats est bien défini
      if (v === 'jour') {
        window.vueStats = 'jour';
      }
      
      // Appelle la fonction originale
      return originalSetStatsView.apply(this, arguments);
    };

    window.setStatsView.__jourHooked = true;
    console.log('[SA_JOUR_ACTIVATION] setStatsView hooké');
  }

  /**
   * Initialisation
   */
  function init() {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        activerBoutonJour();
        hookSetStatsView();
      });
    } else {
      activerBoutonJour();
      hookSetStatsView();
    }

    // Double sécurité
    setTimeout(function() {
      activerBoutonJour();
      hookSetStatsView();
    }, 200);
  }

  init();
  console.log('[SA_JOUR_ACTIVATION] Script chargé');
})();
</script>
</body>
</html
    enable_joints: true,>
<!--
=============================
README_release_v1.9.0
Date: 2025-10-04

Fichier livré:
- stopaddict_release_v1.9.0.html

Secours (rollback):
- stopaddict_fonctionnel.html

Changelog:
- Ajout d’une vue Jour (4 tranches horaires) pour un suivi intra-journalier plus précis.
- Stabilisation de l’écran Statistiques : rendu fiable au premier affichage et navigation cohérente entre les vues.
- Améliorations mineures : export clarifié en vue Jour et optimisations de performance.

Procédure de déploiement:
1. Remplacer l’ancien fichier par stopaddict_release_v1.9.0.html dans l’emplacement de prod.
2. Conserver le fichier de secours à portée (stopaddict_fonctionnel.html).
3. Effectuer un hard-refresh (vider le cache navigateur) après mise en ligne.

QA rapide:
- Arrivée sur Stats (LS vidé) -> Jour + 4 tranches.
- Navigation Jour <-> Semaine/Mois/Année -> labels corrects ; retour Jour OK.
- Actions clopes/joints/alcool -> compteurs & graphes OK.
- Export -> fichiers générés, libellés corrects.
- Reload après choix d’une vue -> retour sur la dernière vue.
- Responsive -> pas de superposition de labels.

Notes:
- Les warnings “meta charset” ne sont pas bloquants.
- Aucun changement CSS/charte/couleurs.
=============================
-->
